<!-- Booking Management Page - Modern UI -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
</script>
<div class="space-y-6">
  <!-- Date Filter Section -->
  <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6">
    <!-- Dynamic Header & Filters Row -->
    <div
      class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4"
    >
      <!-- Left side: Title (Always at top on Mobile, left on Desktop) -->
      <div>
        <h3 class="text-lg font-bold text-gray-800">กรองข้อมูลการจอง</h3>
        <p class="text-sm text-gray-500 mt-1">เลือกช่วงเวลาเพื่อดูข้อมูล</p>
      </div>

      <!-- Right side: All Filter Controls (Stacked on Mobile, Row on Desktop) -->
      <div class="flex flex-col lg:flex-row lg:items-center gap-4">
        <!-- Part 1: Quick Filter Buttons (Grid on Mobile, Row on Desktop) -->
        <div
          class="grid grid-cols-2 sm:grid-cols-4 lg:flex lg:flex-row gap-2 order-2 lg:order-1"
        >
          <button
            onclick="setBookingDateFilter('all')"
            class="px-3 py-2 bg-gray-50 text-gray-600 rounded-lg hover:bg-gray-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            ทั้งหมด
          </button>
          <button
            onclick="setBookingDateFilter('today')"
            class="px-3 py-2 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            วันนี้
          </button>
          <button
            onclick="setBookingDateFilter('month')"
            class="px-3 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            เดือนนี้
          </button>
          <button
            onclick="setBookingDateFilter('year')"
            class="px-3 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            ปีนี้
          </button>
        </div>

        <!-- Part 2: Separator / Label -->
        <div class="hidden lg:block w-px h-8 bg-gray-200 order-2"></div>
        <div class="lg:hidden order-3 border-t border-gray-100 pt-4 mt-2">
          <label
            class="text-xs text-gray-500 uppercase tracking-wide mb-2 block"
            >กำหนดช่วงเวลาเอง</label
          >
        </div>

        <!-- Part 3: Date Inputs (Row with 'from-to' on Desktop, Stacked on Mobile) -->
        <div
          class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 order-3 lg:order-3"
        >
          <input
            type="date"
            id="filterDateFrom"
            class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 text-sm input-modern lg:w-40"
            placeholder="จาก"
          />
          <span class="hidden sm:inline text-gray-400">-</span>
          <input
            type="date"
            id="filterDateTo"
            class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 text-sm input-modern lg:w-40"
            placeholder="ถึง"
          />
          <button
            onclick="applyCustomBookingDateFilter()"
            class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all font-medium text-sm whitespace-nowrap"
          >
            ค้นหา
          </button>
        </div>
      </div>
    </div>

    <!-- Current Filter Display -->
    <div class="mt-4 pt-4 border-t border-gray-100">
      <p class="text-sm text-gray-600">
        <span class="font-semibold">ช่วงเวลาที่เลือก:</span>
        <span id="currentBookingFilterText" class="text-purple-600 ml-2"
          >ทั้งหมด</span
        >
      </p>
    </div>
  </div>

  <!-- Header Actions -->
  <div
    class="flex flex-col lg:flex-row justify-between items-stretch lg:items-center gap-4"
  >
    <!-- Search and Filters -->
    <div class="w-full lg:w-auto lg:flex-1">
      <div
        class="grid grid-cols-1 sm:grid-cols-2 lg:flex lg:flex-row gap-3 lg:items-center"
      >
        <!-- Refresh & Search Group -->
        <div class="flex flex-row gap-2 sm:col-span-2 lg:flex-1">
          <!-- Refresh Button -->
          <button
            onclick="refreshBookingsData()"
            class="flex-shrink-0 flex items-center justify-center p-3 bg-white border-2 border-gray-100 rounded-xl text-gray-500 hover:text-purple-600 hover:border-purple-100 hover:bg-purple-50 transition-all duration-200 shadow-sm"
            title="รีเฟรชข้อมูล"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
          </button>

          <!-- Search -->
          <div class="relative flex-1 lg:w-64">
            <input
              type="text"
              id="searchBooking"
              placeholder="ค้นหาการจอง..."
              onkeyup="filterBookings()"
              class="w-full input-modern pl-10"
            />
            <svg
              class="w-5 h-5 text-gray-400 absolute left-3 top-3.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              ></path>
            </svg>
          </div>
        </div>

        <!-- Filter by Status -->
        <select
          id="filterStatus"
          onchange="filterBookings()"
          class="w-full lg:w-auto input-modern select-modern"
        >
          <option value="">ทุกสถานะ</option>
          <option value="Confirm">Confirm</option>
          <option value="Completed">Completed</option>
          <option value="Cancel">Cancel</option>
        </select>

        <!-- Filter by Location -->
        <select
          id="filterLocation"
          onchange="filterBookings()"
          class="w-full lg:w-auto input-modern select-modern"
        >
          <option value="">ทุกสถานที่</option>
          <!-- Options will be populated dynamically -->
        </select>
      </div>
    </div>

    <!-- Add Booking Button -->
    <button
      id="createBookingBtn"
      onclick="openCreateBookingModal()"
      class="w-full md:w-auto bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:shadow-xl hover:scale-[1.02] active:scale-95 transition-all duration-200 flex items-center justify-center space-x-2 font-semibold shadow-lg shadow-purple-200"
    >
      <svg
        class="w-5 h-5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 4v16m8-8H4"
        ></path>
      </svg>
      <span>สร้างการจองใหม่</span>
    </button>
  </div>

  <!-- Booking Table Container (Desktop) -->
  <div
    class="hidden lg:block bg-white rounded-2xl shadow-xl shadow-gray-100 overflow-hidden border border-gray-100"
  >
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-gray-50 border-b border-gray-100">
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            รหัสการจอง
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            วันที่จอง
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            วันที่เดินทาง
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            สถานที่/โปรแกรม
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            ยอดรวม
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            สถานะ
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            สลิป
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            เอกสาร
          </th>
          <th
            id="manageHeader"
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            จัดการ
          </th>
        </tr>
      </thead>
      <tbody id="bookingTableBody" class="divide-y divide-gray-100">
        <tr>
          <td colspan="9" class="px-6 py-12 text-center text-gray-400">
            <div class="flex flex-col items-center justify-center space-y-3">
              <div
                class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"
              ></div>
              <p class="text-gray-400 text-sm font-medium animate-pulse">
                กำลังดึงข้อมูลการจอง...
              </p>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Booking List Container (Mobile/Tablet) -->
  <div
    id="bookingGridBody"
    class="lg:hidden grid grid-cols-1 md:grid-cols-2 gap-4"
  >
    <div class="col-span-full py-12 text-center">
      <div class="flex flex-col items-center justify-center space-y-3">
        <div
          class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"
        ></div>
        <p class="text-gray-400 text-sm font-medium animate-pulse">
          กำลังดึงข้อมูลการจอง...
        </p>
      </div>
    </div>
  </div>

  <!-- Pagination Controls -->
  <div
    class="flex flex-col sm:flex-row justify-between items-center gap-4 bg-white px-6 py-4 rounded-2xl shadow-sm border border-gray-100 mt-4"
    id="bookingPaginationControl"
  >
    <!-- Rows per page -->
    <div class="flex items-center space-x-3 text-sm text-gray-600">
      <span class="font-medium">แสดง</span>
      <select
        id="bookingItemsPerPageSelect"
        onchange="changeBookingPageSize()"
        class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all cursor-pointer font-bold text-gray-700"
      >
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <span class="font-medium">รายการต่อหน้า</span>
    </div>

    <!-- Page Info & Navigation -->
    <div class="flex flex-col sm:flex-row items-center gap-4">
      <span
        class="hidden sm:inline text-sm font-medium text-gray-500"
        id="bookingPaginationInfo"
        >หน้า 1 จาก 1 (0 รายการ)</span
      >
      <div class="flex items-center space-x-1">
        <button
          onclick="changeBookingPage('prev')"
          id="bookingPrevPageBtn"
          class="p-4 sm:p-2 border border-gray-200 rounded-xl sm:rounded-lg hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
        >
          <svg
            class="w-6 h-6 sm:w-5 sm:h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            ></path>
          </svg>
        </button>

        <!-- Desktop Page Numbers -->
        <div
          id="bookingPageNumbers"
          class="hidden sm:flex items-center space-x-1"
        >
          <!-- Page buttons will be injected here -->
        </div>

        <!-- Mobile Page Info -->
        <div
          class="sm:hidden flex items-center px-6 py-2 bg-purple-50 rounded-xl text-sm font-bold text-purple-700 min-w-[100px] justify-center"
        >
          <span id="bookingMobilePageInfo">1 / 1</span>
        </div>

        <button
          onclick="changeBookingPage('next')"
          id="bookingNextPageBtn"
          class="p-4 sm:p-2 border border-gray-200 rounded-xl sm:rounded-lg hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
        >
          <svg
            class="w-6 h-6 sm:w-5 sm:h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            ></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div
    id="emptyState"
    class="hidden text-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-100"
  >
    <div
      class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <svg
        class="w-10 h-10 text-gray-300"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
        ></path>
      </svg>
    </div>
    <h3 class="text-lg font-bold text-gray-900">ไม่พบข้อมูลการจอง</h3>
    <p class="text-gray-500">ลองเปลี่ยนเงื่อนไขการค้นหาหรือสร้างการจองใหม่</p>
  </div>
</div>

<!-- Create/Edit Booking Modal -->
<div
  id="bookingModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm"
>
  <div
    id="bookingModalContent"
    class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-hidden"
  >
    <!-- Modal Header -->
    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-6 relative">
      <h3 class="text-2xl font-bold text-white" id="modalTitle">
        สร้างการจองใหม่
      </h3>
      <p id="modalSubtitle" class="text-purple-100 text-sm mt-1 hidden"></p>
      <button
        type="button"
        onclick="closeBookingModal()"
        class="absolute top-4 right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all duration-200"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Form Content -->
    <div id="bookingModalBody" class="overflow-y-auto max-h-[calc(90vh-180px)]">
      <form id="bookingForm" class="p-6">
        <input type="hidden" id="bookingId" />
        <input type="hidden" id="editMode" value="false" />

        <!-- Grid Layout -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- วันที่จอง -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >วันที่จอง <span class="text-red-500">*</span></label
            >
            <input type="date" id="bookingDate" required class="input-modern" />
          </div>

          <!-- วันที่เดินทาง -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >วันที่เดินทาง <span class="text-red-500">*</span></label
            >
            <input type="date" id="travelDate" required class="input-modern" />
          </div>

          <!-- สถานที่ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >สถานที่ <span class="text-red-500">*</span></label
            >
            <select id="location" required class="input-modern select-modern">
              <option value="">เลือกสถานที่</option>
            </select>
          </div>

          <!-- โปรแกรม -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >โปรแกรม <span class="text-red-500">*</span></label
            >
            <select
              id="program"
              required
              class="input-modern select-modern"
              onchange="updatePrices()"
            >
              <option value="">เลือกโปรแกรม</option>
            </select>
          </div>

          <!-- ผู้ใหญ่ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >ผู้ใหญ่ (คน) <span class="text-red-500">*</span></label
            >
            <input
              type="number"
              id="adults"
              min="0"
              value="0"
              required
              class="input-modern"
              onfocus="this.select()"
              oninput="calculateTotal()"
            />
          </div>

          <!-- เด็ก -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >เด็ก (คน)</label
            >
            <input
              type="number"
              id="children"
              min="0"
              value="0"
              class="input-modern"
              onfocus="this.select()"
              oninput="calculateTotal()"
            />
          </div>

          <!-- ราคาผู้ใหญ่ -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >ราคาผู้ใหญ่ (บาท) <span class="text-red-500">*</span></label
            >
            <input
              type="number"
              id="adultPrice"
              min="0"
              value="0"
              required
              readonly
              class="input-modern"
              onchange="calculateTotal()"
            />
          </div>

          <!-- ราคาเด็ก -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >ราคาเด็ก (บาท)</label
            >
            <input
              type="number"
              id="childPrice"
              min="0"
              value="0"
              class="input-modern"
              readonly
              onchange="calculateTotal()"
            />
          </div>

          <!-- ค่าใช้จ่ายเพิ่มเติม -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >ค่าใช้จ่ายเพิ่มเติม (บาท)</label
            >
            <input
              type="number"
              id="additionalCost"
              min="0"
              value="0"
              class="input-modern"
              onfocus="this.select()"
              onchange="calculateTotal()"
            />
          </div>

          <!-- ส่วนลด -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >ส่วนลด (บาท)</label
            >
            <input
              type="number"
              id="discount"
              min="0"
              value="0"
              class="input-modern"
              onfocus="this.select()"
              oninput="calculateTotal()"
            />
          </div>

          <!-- รวม VAT 7% (Switch) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              รวม VAT 7%
            </label>
            <div class="flex items-center space-x-3">
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  type="checkbox"
                  id="includeVat"
                  class="sr-only peer"
                  onchange="calculateTotal()"
                />
                <div
                  class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"
                ></div>
                <span
                  class="ml-3 text-sm font-medium text-gray-700 peer-checked:text-purple-600"
                  id="vatLabel"
                  >ไม่รวม VAT</span
                >
              </label>
            </div>
          </div>

          <!-- Agent -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Agent <span class="text-red-500">*</span></label
            >
            <input
              type="text"
              id="agent"
              placeholder="ระบุ Agen"
              class="input-modern"
              required
            />
          </div>

          <!-- หมายเหตุ -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >หมายเหตุ</label
            >
            <textarea
              id="notes"
              rows="3"
              placeholder="หมายเหตุเพิ่มเติม..."
              class="input-modern"
            ></textarea>
          </div>

          <!-- อัพโหลดสลิปการชำระเงิน -->
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              สลิปการชำระเงิน
            </label>
            <div
              class="border-2 border-dashed border-gray-300 rounded-xl p-6 hover:border-purple-400 transition-all"
            >
              <input
                type="file"
                id="slipFile"
                accept="image/*,.pdf"
                class="hidden"
                onchange="handleSlipFileSelect(event)"
              />
              <div
                id="slipUploadArea"
                class="text-center cursor-pointer"
                onclick="document.getElementById('slipFile').click()"
              >
                <svg
                  class="w-12 h-12 mx-auto text-gray-400 mb-3"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                  ></path>
                </svg>
                <p class="text-sm text-gray-600 mb-1">
                  <span class="text-purple-600 font-semibold"
                    >คลิกเพื่ออัพโหลด</span
                  >
                  หรือลากไฟล์มาวาง
                </p>
                <p class="text-xs text-gray-500">
                  รองรับไฟล์ภาพ (JPG, PNG) หรือ PDF (ขนาดไม่เกิน 5MB)
                </p>
              </div>
              <div id="slipPreview" class="hidden mt-4">
                <div
                  class="flex items-center justify-between bg-gray-50 rounded-lg p-3"
                >
                  <div class="flex items-center space-x-3">
                    <svg
                      class="w-8 h-8 text-green-500"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                      ></path>
                    </svg>
                    <div>
                      <p
                        class="text-sm font-semibold text-gray-700"
                        id="slipFileName"
                      >
                        -
                      </p>
                      <p class="text-xs text-gray-500" id="slipFileSize">-</p>
                    </div>
                  </div>
                  <div class="flex items-center space-x-2">
                    <a
                      id="slipViewLink"
                      href="#"
                      target="_blank"
                      class="text-purple-600 hover:text-purple-800 p-1 hidden"
                      title="ดูสลิป"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                        ></path>
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                        ></path>
                      </svg>
                    </a>
                    <button
                      type="button"
                      onclick="clearSlipFile()"
                      class="text-red-500 hover:text-red-700 p-1"
                      title="ลบ"
                    >
                      <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M6 18L18 6M6 6l12 12"
                        ></path>
                      </svg>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <input type="hidden" id="slipUrl" />
          </div>

          <!-- ยอดรวม (แสดงผล) -->
          <div class="md:col-span-2">
            <div
              class="bg-gradient-to-br from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl p-6 shadow-sm"
            >
              <!-- Calculation Breakdown -->
              <div class="space-y-3 mb-4">
                <div class="flex items-center justify-between text-sm">
                  <div class="flex items-center space-x-2">
                    <svg
                      class="w-4 h-4 text-purple-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                      ></path>
                    </svg>
                    <span class="text-gray-600 font-medium" id="adultSummary"
                      >ผู้ใหญ่: 0 คน × 0 ฿</span
                    >
                  </div>
                  <span class="font-semibold text-gray-900" id="adultTotal"
                    >0 ฿</span
                  >
                </div>

                <div class="flex items-center justify-between text-sm">
                  <div class="flex items-center space-x-2">
                    <svg
                      class="w-4 h-4 text-indigo-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                      ></path>
                    </svg>
                    <span class="text-gray-600 font-medium" id="childSummary"
                      >เด็ก: 0 คน × 0 ฿</span
                    >
                  </div>
                  <span class="font-semibold text-gray-900" id="childTotal"
                    >0 ฿</span
                  >
                </div>

                <div
                  class="flex items-center justify-between text-sm"
                  id="additionalCostRow"
                >
                  <div class="flex items-center space-x-2">
                    <svg
                      class="w-4 h-4 text-orange-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M12 6v6m0 0v6m0-6h6m-6 0H6"
                      ></path>
                    </svg>
                    <span class="text-gray-600 font-medium"
                      >ค่าใช้จ่ายเพิ่มเติม</span
                    >
                  </div>
                  <span
                    class="font-semibold text-gray-900"
                    id="additionalCostAmount"
                    >0 ฿</span
                  >
                </div>

                <!-- VAT 7% Row (shown when VAT is enabled) -->
                <div
                  class="flex items-center justify-between text-sm hidden"
                  id="vatRow"
                >
                  <div class="flex items-center space-x-2">
                    <svg
                      class="w-4 h-4 text-green-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"
                      ></path>
                    </svg>
                    <span class="text-gray-600 font-medium">VAT 7%</span>
                  </div>
                  <span class="font-semibold text-gray-900" id="vatAmount"
                    >0 ฿</span
                  >
                </div>

                <div
                  class="flex items-center justify-between text-sm"
                  id="discountRow"
                >
                  <div class="flex items-center space-x-2">
                    <svg
                      class="w-4 h-4 text-red-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
                      ></path>
                    </svg>
                    <span class="text-gray-600 font-medium">ส่วนลด</span>
                  </div>
                  <span class="font-semibold text-red-600" id="discountAmount"
                    >0 ฿</span
                  >
                </div>

                <div class="border-t-2 border-purple-300 pt-3 mt-2"></div>
              </div>

              <!-- Total Amount -->
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                  <svg
                    class="w-6 h-6 text-purple-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                  <span class="text-xl font-bold text-gray-800"
                    >ยอดรวมทั้งหมด</span
                  >
                </div>
                <span class="text-3xl font-bold text-gray-900" id="totalAmount"
                  >0 ฿</span
                >
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Action Buttons -->
    <div
      class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 border-t border-gray-200"
    >
      <button
        type="button"
        id="cancelBookingBtn"
        onclick="closeBookingModal()"
        class="px-6 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-medium"
      >
        ยกเลิก
      </button>
      <button
        type="submit"
        form="bookingForm"
        id="saveBookingBtn"
        class="px-6 py-2.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl hover:shadow-lg active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed transition-all duration-200 font-medium flex items-center space-x-2"
      >
        <span
          id="saveBtnSpinner"
          class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"
        ></span>
        <span id="saveBtnText">บันทึก</span>
      </button>
    </div>
  </div>
</div>

<!-- View Booking Details Modal -->
<div
  id="viewBookingModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm"
>
  <div
    id="viewBookingModalContent"
    class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl mx-4 max-h-[90vh] overflow-hidden flex flex-col"
  >
    <!-- Modal Header with Pattern -->
    <div
      class="relative overflow-hidden bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-6 flex-shrink-0 z-20"
    >
      <div class="relative z-10 flex justify-between items-start">
        <div>
          <button
            onclick="closeViewBookingModal()"
            class="absolute -top-2 -right-2 p-2 bg-white/10 hover:bg-white/20 rounded-full text-white transition-colors"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
          <div class="flex items-center gap-2 mb-1">
            <span
              class="px-2 py-0.5 rounded text-xs font-semibold bg-white/20 border border-white/20"
              >Booking Detail</span
            >
            <span id="viewBookingDate" class="text-xs text-purple-100"></span>
          </div>
          <h3 class="text-2xl font-bold">รายละเอียดการจอง</h3>
          <p
            id="viewBookingSubtitle"
            class="text-purple-100 opacity-90 mt-1 text-sm"
          ></p>
        </div>
      </div>
    </div>

    <!-- Modal Content (Scrollable) -->
    <div class="overflow-y-auto flex-1">
      <div id="viewBookingContent" class="px-6 pb-6 pt-8 relative z-20">
        <!-- Content will be injected here -->
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div
  id="deleteModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-[70] flex items-center justify-center backdrop-blur-sm"
>
  <div
    class="bg-white rounded-2xl shadow-xl w-full max-w-md mx-4 overflow-hidden"
    id="deleteModalContent"
  >
    <!-- Header (Employee Style) -->
    <div class="bg-red-50 p-6 flex items-center space-x-4">
      <div
        class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0"
      >
        <svg
          class="w-6 h-6 text-red-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
          ></path>
        </svg>
      </div>
      <div>
        <h3 class="text-xl font-bold text-gray-900">ยืนยันการยกเลิก</h3>
        <p class="text-sm text-gray-500" id="deleteBookingIdDisplay">...</p>
      </div>
    </div>

    <!-- Body -->
    <div class="p-6">
      <p class="text-gray-600 mb-6">
        คุณแน่ใจหรือไม่ที่จะยกเลิกรายการจองนี้?
        <br /><span class="text-sm text-gray-500"
          >การกระทำนี้จะเปลี่ยนสถานะเป็น "Cancel"</span
        >
      </p>

      <div class="mb-6">
        <label class="block text-sm font-medium text-gray-700 mb-2"
          >สาเหตุการยกเลิก <span class="text-red-500">*</span></label
        >
        <textarea
          id="deleteReason"
          rows="3"
          class="w-full px-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors resize-none"
          placeholder="ระบุเหตุผลที่ต้องการยกเลิก..."
        ></textarea>
        <p id="deleteReasonError" class="text-red-500 text-xs mt-1 hidden">
          กรุณาระบุเหตุผล
        </p>
      </div>

      <div class="flex space-x-3">
        <button
          id="btnCancelDelete"
          onclick="closeBookingDeleteModal()"
          class="flex-1 px-6 py-3 border-2 border-gray-100 text-gray-700 rounded-xl hover:bg-gray-50 font-bold transition-all"
        >
          ยกเลิก
        </button>
        <button
          onclick="executeDelete()"
          class="flex-1 px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 hover:shadow-lg shadow-red-100 active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed transition-all font-bold flex items-center justify-center space-x-2"
          id="btnConfirmDelete"
        >
          <span
            id="deleteSpinner"
            class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"
          ></span>
          <span>ยืนยันการลบ</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Invoice Preview Modal -->
<div
  id="invoicePreviewModal"
  class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 transition-all duration-300 backdrop-blur-sm bg-black/60"
>
  <div
    id="invoicePreviewContent"
    class="bg-white rounded-2xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[95vh] overflow-hidden"
  >
    <!-- Modal Header -->
    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-6 relative">
      <div class="flex flex-col">
        <h3 id="previewModalTitle" class="text-2xl font-bold text-white">
          ตัวอย่างเอกสาร
        </h3>
        <p id="previewBookingId" class="text-purple-100 text-sm mt-1">#...</p>
      </div>
      <button
        type="button"
        onclick="closeInvoicePreview()"
        class="absolute top-4 right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all duration-200"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Action Toolbar -->
    <div
      class="bg-gray-50 border-b px-6 py-3 flex items-center justify-end space-x-3"
    >
      <button
        onclick="openInNewTab()"
        id="newTabBtn"
        class="flex items-center px-4 py-2 bg-white border border-gray-200 text-gray-700 rounded-xl hover:bg-gray-50 hover:text-purple-600 hover:border-purple-200 transition-all font-medium active:scale-95 shadow-sm"
        title="เปิดเอกสารในแท็บใหม่"
      >
        <svg
          class="w-5 h-5 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
          ></path>
        </svg>
        เปิดในแท็บใหม่
      </button>
      <button
        id="downloadInvoiceBtn"
        class="flex items-center px-4 py-2 bg-purple-600 text-white rounded-xl hover:bg-purple-700 transition-all font-medium active:scale-95 shadow-lg shadow-purple-200"
      >
        <svg
          class="w-5 h-5 mr-2"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
          ></path>
        </svg>
        Download PDF
      </button>
    </div>

    <!-- Container -->
    <div class="flex-1 overflow-y-auto bg-gray-100 p-4 min-h-[500px] relative">
      <div
        id="pdfLoadingState"
        class="absolute inset-0 flex items-center justify-center bg-white/80 z-10 hidden"
      >
        <div class="flex flex-col items-center space-y-3">
          <div
            class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"
          ></div>
          <p class="text-gray-400 text-sm font-medium animate-pulse">
            กำลังเตรียมเอกสาร...
          </p>
        </div>
      </div>
      <div
        id="pdfViewerContainer"
        class="w-full h-full overflow-auto bg-gray-50 rounded-xl flex justify-center p-4 border border-gray-200"
      >
        <!-- PDF Canvas will be rendered here -->
      </div>
    </div>
  </div>
</div>
<script>
  let deletingBookingId = null;

  function openBookingDeleteModal(bookingId) {
    deletingBookingId = bookingId;
    document.getElementById("deleteBookingIdDisplay").textContent =
      "รหัส: " + bookingId;
    document.getElementById("deleteReason").value = "";
    document.getElementById("deleteReasonError").classList.add("hidden");

    const modal = document.getElementById("deleteModal");
    const modalContent = document.getElementById("deleteModalContent");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);
  }

  function closeBookingDeleteModal() {
    const modal = document.getElementById("deleteModal");
    const modalContent = document.getElementById("deleteModalContent");

    modal.classList.add("modal-hide");
    modalContent.classList.add("modal-content-hide");

    setTimeout(() => {
      modal.classList.add("hidden");
      modal.classList.remove("modal-show", "modal-hide");
      modalContent.classList.remove("modal-content-show", "modal-content-hide");
      deletingBookingId = null;
    }, 300);
  }

  function executeDelete() {
    if (!deletingBookingId) return;

    const reason = document.getElementById("deleteReason").value.trim();
    if (!reason) {
      document.getElementById("deleteReasonError").classList.remove("hidden");
      document.getElementById("deleteReason").focus();
      return;
    }

    const btn = document.getElementById("btnConfirmDelete");
    const spinner = document.getElementById("deleteSpinner");
    const btnCancel = document.getElementById("btnCancelDelete");

    // Loading State
    btn.disabled = true;
    btnCancel.disabled = true;
    spinner.classList.remove("hidden");
    btn.innerHTML = `
      <span class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
      <span>กำลังลบ...</span>
    `;

    const session = getSessionFromStorage();

    google.script.run
      .withSuccessHandler((response) => {
        // Reset State
        btn.disabled = false;
        btnCancel.disabled = false;
        btn.innerHTML = `
          <span id="deleteSpinner" class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
          <span>ยืนยันการลบ</span>
        `;

        closeBookingDeleteModal();

        if (response.success) {
          showToast("ยกเลิกรายการจองสำเร็จ", "success");
          loadBookings(); // Refresh data
        } else {
          showToast(response.message || "ไม่สามารถยกเลิกได้", "error");
        }
      })
      .withFailureHandler((error) => {
        // Reset State
        btn.disabled = false;
        btnCancel.disabled = false;
        btn.innerHTML = `
          <span id="deleteSpinner" class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>
          <span>ยืนยันการลบ</span>
        `;

        closeBookingDeleteModal();
        showToast("เกิดข้อผิดพลาด: " + error.message, "error");
      })
      .deleteBooking(session.sessionToken, deletingBookingId, reason);
  }
  // Global variables
  var allBookings = [];
  var allLocations = [];
  var allPrograms = [];
  var currentSession = null;

  /**
   * Format Date for Input (YYYY-MM-DD)
   */
  function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }

  /**
   * Format Date to Thai (DD/MM/YYYY)
   */
  function formatDateThai(date) {
    const day = String(date.getDate()).padStart(2, "0");
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  /**
   * Convert Thai Date Format (DD/MM/YYYY) to Input Format (YYYY-MM-DD)
   */
  function convertThaiDateToInputFormat(thaiDate) {
    if (!thaiDate || thaiDate.trim() === "") return "";

    // Check if already in YYYY-MM-DD format
    if (thaiDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
      return thaiDate;
    }

    // Convert from DD/MM/YYYY to YYYY-MM-DD
    const parts = thaiDate.split("/");
    if (parts.length === 3) {
      const day = parts[0].padStart(2, "0");
      const month = parts[1].padStart(2, "0");
      const year = parts[2];
      return `${year}-${month}-${day}`;
    }

    return "";
  }

  /**
   * Set Booking Date Filter (Quick Filters)
   */
  function setBookingDateFilter(type) {
    const today = new Date();
    let startDate, endDate;

    switch (type) {
      case "all":
        startDate = "";
        endDate = "";
        document.getElementById("currentBookingFilterText").textContent =
          "ทั้งหมด";
        break;

      case "today":
        startDate = endDate = formatDateForInput(today);
        document.getElementById("currentBookingFilterText").textContent =
          "วันนี้";
        break;

      case "month":
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        startDate = formatDateForInput(firstDay);
        endDate = formatDateForInput(lastDay);
        document.getElementById("currentBookingFilterText").textContent =
          "เดือนนี้";
        break;

      case "year":
        const yearStart = new Date(today.getFullYear(), 0, 1);
        const yearEnd = new Date(today.getFullYear(), 11, 31);
        startDate = formatDateForInput(yearStart);
        endDate = formatDateForInput(yearEnd);
        document.getElementById("currentBookingFilterText").textContent =
          "ปีนี้";
        break;
    }

    // Update input fields
    document.getElementById("filterDateFrom").value = startDate;
    document.getElementById("filterDateTo").value = endDate;

    // Reload bookings with new dates
    loadBookings(startDate, endDate);
  }

  /**
   * Apply Custom Booking Date Filter
   */
  function applyCustomBookingDateFilter() {
    const startDate = document.getElementById("filterDateFrom").value;
    const endDate = document.getElementById("filterDateTo").value;

    if (!startDate || !endDate) {
      showToast("กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด", "warning");
      return;
    }

    if (new Date(startDate) > new Date(endDate)) {
      showToast("วันที่เริ่มต้นต้องน้อยกว่าหรือเท่ากับวันที่สิ้นสุด", "error");
      return;
    }

    // Update filter display
    const start = new Date(startDate);
    const end = new Date(endDate);
    document.getElementById(
      "currentBookingFilterText"
    ).textContent = `${formatDateThai(start)} - ${formatDateThai(end)}`;

    // Reload bookings with new dates
    loadBookings(startDate, endDate);
  }

  /**
   * Refresh Bookings Data
   */
  function refreshBookingsData() {
    document.getElementById("searchBooking").value = "";
    document.getElementById("filterStatus").value = "";
    document.getElementById("filterLocation").value = "";
    document.getElementById("filterDateFrom").value = "";
    document.getElementById("filterDateTo").value = "";
    document.getElementById("currentBookingFilterText").textContent = "ทั้งหมด";
    loadBookings();
  }

  /**
   * Load Bookings
   */
  function loadBookings(start, end) {
    const session = getSessionFromStorage();
    if (!session || !session.sessionToken) {
      showToast("กรุณาเข้าสู่ระบบใหม่", "error");
      return;
    }

    const createBtn = document.getElementById("createBookingBtn");
    if (createBtn) {
      if (session.role === "OP" || session.role === "Owner") {
        createBtn.classList.remove("hidden");
      } else {
        createBtn.classList.add("hidden");
      }
    }

    const startDateEl = document.getElementById("filterDateFrom");
    const endDateEl = document.getElementById("filterDateTo");

    // Determine final dates
    let finalStart = start;
    let finalEnd = end;

    // If no dates provided as arguments (e.g. initial load), default to this month
    if (finalStart === undefined || finalEnd === undefined) {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      finalStart = formatDateForInput(firstDay);
      finalEnd = formatDateForInput(lastDay);
    }

    // Update input fields if they are different
    if (startDateEl && startDateEl.value !== finalStart)
      startDateEl.value = finalStart;
    if (endDateEl && endDateEl.value !== finalEnd) endDateEl.value = finalEnd;

    // Update filter text ONLY if we are defaulting (no arguments provided)
    // This prevents overwriting the specific text set by filter buttons (e.g. "Year", "Custom Dates")
    if (start === undefined && end === undefined) {
      let filterText = "กำหนดเอง";
      const today = formatDateForInput(new Date());
      const firstDay = formatDateForInput(
        new Date(new Date().getFullYear(), new Date().getMonth(), 1)
      );
      const lastDay = formatDateForInput(
        new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0)
      );

      if (!finalStart && !finalEnd) filterText = "ทั้งหมด";
      else if (finalStart === today && finalEnd === today)
        filterText = "วันนี้";
      else if (finalStart === firstDay && finalEnd === lastDay)
        filterText = "เดือนนี้";

      document.getElementById("currentBookingFilterText").textContent =
        filterText;
    }

    currentSession = session;

    const manageHeader = document.getElementById("manageHeader");
    const isActionableRole =
      session && (session.role === "OP" || session.role === "Owner");
    let colSpan = 9;

    if (manageHeader) {
      if (isActionableRole) {
        manageHeader.classList.remove("hidden");
      } else {
        manageHeader.classList.add("hidden");
        colSpan = 8;
      }
    }

    // Show loading
    document.getElementById("bookingTableBody").innerHTML = `
      <tr>
        <td colspan="${colSpan}" class="px-6 py-12 text-center">
          <div class="flex flex-col items-center justify-center space-y-3">
            <div class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"></div>
            <p class="text-gray-400 text-sm font-medium animate-pulse">กำลังดึงข้อมูลการจอง...</p>
          </div>
        </td>
      </tr>
    `;

    document.getElementById("bookingGridBody").innerHTML = `
      <div class="col-span-full py-12 text-center">
        <div class="flex flex-col items-center justify-center space-y-3">
          <div class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"></div>
          <p class="text-gray-400 text-sm font-medium animate-pulse">กำลังดึงข้อมูลการจอง...</p>
        </div>
      </div>
    `;

    // Load locations and programs first
    Promise.all([
      new Promise((resolve) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(() => resolve({ success: false, data: [] }))
          .getAllLocations(session.sessionToken);
      }),
      new Promise((resolve) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(() => resolve({ success: false, data: [] }))
          .getAllPrograms(session.sessionToken);
      }),
    ]).then(([locationsResult, programsResult]) => {
      if (locationsResult.success) {
        allLocations = locationsResult.data;
        populateLocationFilter();
      }
      if (programsResult.success) {
        allPrograms = programsResult.data;
      }

      // Load bookings
      google.script.run
        .withSuccessHandler(function (response) {
          if (response.success) {
            // Sort by bookingId in descending order (newest first)
            allBookings = (response.data || []).sort((a, b) => {
              return b.bookingId.localeCompare(a.bookingId);
            });
            // Apply current filters instead of showing all
            filterBookings();
          } else {
            showToast(response.message || "ไม่สามารถโหลดข้อมูลได้", "error");
            document.getElementById("bookingTableBody").innerHTML = `
              <tr>
                <td colspan="9" class="px-6 py-8 text-center text-red-500">
                  ${response.message || "ไม่พบข้อมูล"}
                </td>
              </tr>
            `;
          }
        })
        .withFailureHandler(function (error) {
          showToast("เกิดข้อผิดพลาด: " + error.message, "error");
          document.getElementById("bookingTableBody").innerHTML = `
            <tr>
              <td colspan="${colSpan}" class="px-6 py-8 text-center text-red-500">
                เกิดข้อผิดพลาด: ${error.message}
              </td>
            </tr>
          `;
        })
        .getAllBookings(session.sessionToken, finalStart, finalEnd);
    });
  }

  /**
   * Populate Location Filter Dropdown
   */
  function populateLocationFilter() {
    const filterLocation = document.getElementById("filterLocation");
    if (!filterLocation) return;

    // Clear existing options except the first one
    filterLocation.innerHTML = '<option value="">ทุกสถานที่</option>';

    // Add location options
    allLocations.forEach((location) => {
      const option = document.createElement("option");
      option.value = location.locationName;
      option.textContent = location.locationName;
      filterLocation.appendChild(option);
    });
  }

  /**
   * Get Program Name from Program ID
   */
  function getProgramName(programId) {
    if (!programId) return "-";
    const program = allPrograms.find((p) => p.programId === programId);
    return program ? program.description : programId;
  }

  /**
   * Render Bookings Table
   */
  function renderBookings(bookings) {
    const tbody = document.getElementById("bookingTableBody");
    const gridBody = document.getElementById("bookingGridBody");
    const hasData = bookings && bookings.length > 0;

    const isActionableRole =
      currentSession &&
      (currentSession.role === "OP" || currentSession.role === "Owner");
    const colSpan = isActionableRole ? 9 : 8;

    // 1. Render Table View (Desktop)
    if (!hasData) {
      tbody.innerHTML = `
        <tr>
          <td colspan="${colSpan}" class="px-4 py-8 text-center text-gray-500">
            ไม่พบข้อมูลการจอง
          </td>
        </tr>
      `;
    } else {
      tbody.innerHTML = bookings
        .map((booking) => {
          const statusBadge = getStatusBadge(booking.status);
          const totalPeople = (booking.adults || 0) + (booking.children || 0);
          const isCancelled = booking.status === "Cancel";
          const isCompleted = booking.status === "Completed";
          const canEdit =
            !isCancelled &&
            !isCompleted &&
            currentSession &&
            (currentSession.role === "Owner" ||
              (currentSession.role === "OP" &&
                booking.createdBy === currentSession.username));

          const canDelete =
            !isCancelled &&
            currentSession &&
            (currentSession.role === "Owner" ||
              (currentSession.role === "OP" &&
                booking.createdBy === currentSession.username));

          let actionButtons = "";

          if (canEdit) {
            actionButtons += `<button onclick="editBooking('${booking.bookingId}')" class="p-2 text-indigo-600 hover:bg-indigo-50 border border-transparent hover:border-indigo-100 rounded-xl transition-all duration-200 shadow-sm bg-white mr-1" title="แก้ไข"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>`;
          }

          if (canDelete) {
            actionButtons += `<button onclick="deleteBooking('${booking.bookingId}')" class="p-2 text-red-600 hover:bg-red-50 border border-transparent hover:border-red-100 rounded-xl transition-all duration-200 shadow-sm bg-white" title="ลบ"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>`;
          }

          return `
            <tr class="hover:bg-gray-50 transition-colors cursor-pointer" onclick="viewBooking('${
              booking.bookingId || ""
            }')">
              <td class="px-6 py-4">
                <div class="text-sm font-bold text-gray-900">${
                  booking.bookingId
                }</div>
                <div class="text-xs text-gray-500">โดย: ${
                  booking.createdBy
                }</div>
              </td>
              <td class="px-6 py-4 text-sm text-gray-700">${
                booking.bookingDate
              }</td>
              <td class="px-6 py-4 text-sm text-gray-700">${
                booking.travelDate
              }</td>
              <td class="px-6 py-4">
                <div class="text-sm font-medium text-gray-900">${
                  booking.location
                }</div>
                <div class="text-xs text-gray-500">${booking.program}</div>
              </td>
              <td class="px-6 py-4">
                <div class="text-sm font-bold text-gray-900">${formatNumber(
                  booking.totalAmount
                )} ฿</div>
                <div class="text-xs text-gray-500">${booking.adults} ผู้ใหญ่, ${
            booking.children
          } เด็ก</div>
              </td>
              <td class="px-6 py-4 text-center">
                ${statusBadge}
              </td>
              <td class="px-6 py-4 text-center">
                ${
                  booking.slipUrl
                    ? `<a href="${booking.slipUrl}" target="_blank" onclick="event.stopPropagation()" class="inline-flex items-center px-3 py-1 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg></a>`
                    : '<span class="text-gray-400">-</span>'
                }
              </td>
              <td class="px-6 py-4 text-center">
                ${
                  booking.status === "Cancel"
                    ? '<span class="text-gray-400">-</span>'
                    : booking.status === "Completed"
                    ? `<button onclick="event.stopPropagation(); viewReceipt('${booking.bookingId}')" class="inline-flex items-center px-3 py-1 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all font-medium text-sm" title="ดูใบเสร็จรับเงิน">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        ใบเสร็จ
                      </button>`
                    : `<button onclick="event.stopPropagation(); viewInvoice('${booking.bookingId}')" class="inline-flex items-center px-3 py-1 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all font-medium text-sm" title="ดูใบแจ้งหนี้">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        ใบแจ้งหนี้
                      </button>`
                }
              </td>
              <td class="px-6 py-4 text-center">
                <div class="flex items-center justify-center space-x-1" onclick="event.stopPropagation()">
                  ${actionButtons}
                </div>
              </td>
            </tr>
          `;
        })
        .join("");
    }

    // 2. Render Grid View (Mobile)
    if (gridBody) {
      if (!hasData) {
        gridBody.innerHTML = `
          <div class="col-span-full py-12 text-center text-gray-500 bg-white rounded-2xl border-2 border-dashed border-gray-100">
            <div class="flex flex-col items-center">
              <svg class="w-12 h-12 text-gray-300 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
              </svg>
              <span class="font-medium">ไม่พบข้อมูลการจอง</span>
            </div>
          </div>`;
      } else {
        gridBody.innerHTML = bookings
          .map((booking) => {
            const statusBadge = getStatusBadge(booking.status);
            const totalPeople = (booking.adults || 0) + (booking.children || 0);
            const isCancelled = booking.status === "Cancel";
            const isCompleted = booking.status === "Completed";
            const canEdit =
              !isCancelled &&
              !isCompleted &&
              currentSession &&
              (currentSession.role === "Owner" ||
                (currentSession.role === "OP" &&
                  booking.createdBy === currentSession.username));

            const canDelete =
              !isCancelled &&
              currentSession &&
              (currentSession.role === "Owner" ||
                (currentSession.role === "OP" &&
                  booking.createdBy === currentSession.username));

            let actionButtons = "";

            if (canEdit) {
              actionButtons += `<button onclick="editBooking('${booking.bookingId}')" class="flex items-center justify-center py-2 bg-indigo-50 text-indigo-700 rounded-xl text-sm font-bold hover:bg-indigo-100 transition-colors" title="แก้ไข"><svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>แก้ไข</button>`;
            }

            if (canDelete) {
              // Add margin-left if edit button exists (simple space check)
              const mlClass = canEdit ? "ml-2" : "";
              // Or just use grid gap which is already there?
              // Wait, the container <div class="grid grid-cols-2 gap-2"> handles layout.
              // But if only one button exists, grid-cols-2 might look weird if we want full width or just one slot?
              // Actually the current layout is:
              // <div class="grid grid-cols-2 gap-2">
              //   <button ... รายละเอียด ...>
              //   <button ... ใบเสร็จ/ใบแจ้งหนี้ ...>
              // </div>
              // <div class="mt-2 grid grid-cols-2 gap-2"> <-- New row for actions?
              // Original code put edit/delete in a flex container?
              // Let's check original code around line 1700.
              // Original: <div class="mt-3 grid grid-cols-2 gap-2"> ... buttons ... </div>
              // So they are just buttons in a grid.
              // If we have both edit and delete, they take 2 slots.
              // If we have only one, it takes 1 slot.

              actionButtons += `<button onclick="deleteBooking('${booking.bookingId}')" class="flex items-center justify-center py-2 bg-red-50 text-red-700 rounded-xl text-sm font-bold hover:bg-red-100 transition-colors" title="ลบ"><svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>ลบ</button>`;
            }

            // If we have action buttons, wrap them in a grid container
            const actionSection = actionButtons
              ? `<div class="mt-2 grid grid-cols-2 gap-2">${actionButtons}</div>`
              : "";

            return `
               <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md transition-shadow relative overflow-hidden group">
                 <div class="flex justify-between items-start mb-3">
                   <div>
                     <span class="text-xs font-bold text-gray-400">#${
                       booking.bookingId
                     }</span>
                      ${
                        booking.program
                          ? `<h3 class="font-semibold text-gray-800 line-clamp-1">${booking.program}</h3>`
                          : '<div class="h-5"></div>'
                      }
                     <p class="text-sm text-gray-500 flex items-center mt-1">
                        <svg class="w-4 h-4 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        ${booking.location || "-"}
                     </p>
                   </div>
                   <div class="flex-shrink-0 ml-2">${statusBadge}</div>
                 </div>

                 <div class="space-y-2 text-sm text-gray-600 mb-4 border-t border-b border-gray-50 py-3 bg-gray-50/50 -mx-4 px-4">
                   <div class="flex justify-between">
                     <span class="text-gray-500">เดินทาง</span>
                     <span class="font-medium text-gray-800">${
                       booking.travelDate
                     }</span>
                   </div>
                   <div class="flex justify-between">
                     <span class="text-gray-500">จำนวนคน</span>
                     <span class="font-medium text-gray-800">${totalPeople} คน</span>
                   </div>
                   <div class="flex justify-between">
                     <span class="text-gray-500">ยอดรวม</span>
                     <span class="font-bold text-purple-600">${formatNumber(
                       booking.totalAmount
                     )} ฿</span>
                   </div>
                 </div>

                  <div class="grid grid-cols-2 gap-2">
                    <button onclick="viewBooking('${
                      booking.bookingId
                    }')" class="flex items-center justify-center py-2 bg-purple-50 text-purple-700 rounded-xl text-sm font-bold hover:bg-purple-100 transition-colors">
                      <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                      รายละเอียด
                    </button>
                    ${
                      booking.status === "Cancel"
                        ? ""
                        : booking.status === "Completed"
                        ? `<button onclick="viewReceipt('${booking.bookingId}')" class="flex items-center justify-center py-2 bg-green-50 text-green-700 rounded-xl text-sm font-bold hover:bg-green-100 transition-colors">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            ใบเสร็จ
                          </button>`
                        : `<button onclick="viewInvoice('${booking.bookingId}')" class="flex items-center justify-center py-2 bg-blue-50 text-blue-700 rounded-xl text-sm font-bold hover:bg-blue-100 transition-colors">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            ใบแจ้งหนี้
                          </button>`
                    }
                  </div>
                  ${actionSection}
                </div>
             `;
          })
          .join("");
      }
    }
  }

  /**
   * Filter Bookings
   */
  function filterBookings() {
    const searchText = document
      .getElementById("searchBooking")
      .value.toLowerCase();
    const statusFilter = document.getElementById("filterStatus").value;
    const locationFilter = document.getElementById("filterLocation")?.value;
    const dateFrom = document.getElementById("filterDateFrom").value;
    const dateTo = document.getElementById("filterDateTo").value;

    const filtered = allBookings.filter((booking) => {
      // Search filter
      const matchSearch =
        !searchText ||
        booking.bookingId.toLowerCase().includes(searchText) ||
        booking.location.toLowerCase().includes(searchText) ||
        booking.program.toLowerCase().includes(searchText);

      // Status filter
      const matchStatus = !statusFilter || booking.status === statusFilter;

      // Location filter
      const matchLocation =
        !locationFilter || booking.location === locationFilter;

      // Date filter - Convert booking.bookingDate from DD/MM/YYYY to YYYY-MM-DD for comparison
      let matchDate = true;
      if (dateFrom || dateTo) {
        const bookingDate = booking.bookingDate;
        // Check if bookingDate is in DD/MM/YYYY format
        if (bookingDate && bookingDate.includes("/")) {
          const parts = bookingDate.split("/");
          if (parts.length === 3) {
            // Convert DD/MM/YYYY to YYYY-MM-DD correctly with padding
            const y = parts[2];
            const m = parts[1].padStart(2, "0");
            const d = parts[0].padStart(2, "0");
            const comparableDate = `${y}-${m}-${d}`;
            matchDate =
              (!dateFrom || comparableDate >= dateFrom) &&
              (!dateTo || comparableDate <= dateTo);
          }
        } else {
          // If already in YYYY-MM-DD format
          matchDate =
            (!dateFrom || bookingDate >= dateFrom) &&
            (!dateTo || bookingDate <= dateTo);
        }
      }

      return matchSearch && matchStatus && matchLocation && matchDate;
    });

    // Sort by bookingId in descending order (newest first)
    const sorted = filtered.sort((a, b) => {
      return b.bookingId.localeCompare(a.bookingId);
    });

    // Save filtered result and reset to page 1
    currentFilteredBookings = sorted;
    currentBookingPage = 1;
    renderBookingPagination();
  }

  // --- Pagination Variables ---
  var currentBookingPage = 1;
  var bookingItemsPerPage = 10;
  var currentFilteredBookings = [];

  /**
   * Render Pagination & Data
   */
  function renderBookingPagination() {
    const totalItems = currentFilteredBookings.length;
    const totalPages = Math.ceil(totalItems / bookingItemsPerPage);

    // Validate current page
    if (currentBookingPage > totalPages) {
      currentBookingPage = totalPages || 1;
    }
    if (currentBookingPage < 1) {
      currentBookingPage = 1;
    }

    const startIndex = (currentBookingPage - 1) * bookingItemsPerPage;
    const endIndex = Math.min(startIndex + bookingItemsPerPage, totalItems);
    const pageData = currentFilteredBookings.slice(startIndex, endIndex);

    // Render Data
    renderBookings(pageData);

    // Update Controls
    updateBookingPaginationControls(
      totalItems,
      totalPages,
      startIndex,
      endIndex
    );
  }

  /**
   * Update Pagination Controls UI
   */
  function updateBookingPaginationControls(
    totalItems,
    totalPages,
    startIndex,
    endIndex
  ) {
    // Text Info
    document.getElementById(
      "bookingPaginationInfo"
    ).textContent = `หน้า ${currentBookingPage} จาก ${totalPages} (${totalItems} รายการ)`;
    document.getElementById(
      "bookingMobilePageInfo"
    ).textContent = `${currentBookingPage} / ${totalPages}`;

    // Buttons Disable State
    document.getElementById("bookingPrevPageBtn").disabled =
      currentBookingPage === 1;
    document.getElementById("bookingNextPageBtn").disabled =
      currentBookingPage === totalPages;

    // Desktop Page Numbers
    const pageNumbersContainer = document.getElementById("bookingPageNumbers");
    pageNumbersContainer.innerHTML = "";

    const maxVisiblePages = 5;
    let startPage = Math.max(
      1,
      currentBookingPage - Math.floor(maxVisiblePages / 2)
    );
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    // First page + dots
    if (startPage > 1) {
      const firstBtn = createBookingPageButton(1);
      pageNumbersContainer.appendChild(firstBtn);

      if (startPage > 2) {
        const dots = document.createElement("span");
        dots.className = "text-gray-400 px-1 select-none";
        dots.textContent = "...";
        pageNumbersContainer.appendChild(dots);
      }
    }

    // Page numbers
    for (let i = startPage; i <= endPage; i++) {
      const btn = createBookingPageButton(i);
      pageNumbersContainer.appendChild(btn);
    }

    // Last page + dots
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        const dots = document.createElement("span");
        dots.className = "text-gray-400 px-1 select-none";
        dots.textContent = "...";
        pageNumbersContainer.appendChild(dots);
      }

      const lastBtn = createBookingPageButton(totalPages);
      pageNumbersContainer.appendChild(lastBtn);
    }
  }

  function createBookingPageButton(pageNum) {
    const btn = document.createElement("button");
    btn.textContent = pageNum;
    btn.onclick = () => changeBookingPage(pageNum);

    if (pageNum === currentBookingPage) {
      btn.className =
        "px-3 py-1 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg font-bold shadow-sm";
    } else {
      btn.className =
        "px-3 py-1 border border-gray-200 rounded-lg hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 transition-all";
    }

    return btn;
  }

  /**
   * Change Page Action
   */
  function changeBookingPage(direction) {
    const totalItems = currentFilteredBookings.length;
    const totalPages = Math.ceil(totalItems / bookingItemsPerPage);

    if (direction === "prev" && currentBookingPage > 1) {
      currentBookingPage--;
    } else if (direction === "next" && currentBookingPage < totalPages) {
      currentBookingPage++;
    } else if (typeof direction === "number") {
      currentBookingPage = direction;
    }

    renderBookingPagination();
  }

  /**
   * Change Page Size Action
   */
  function changeBookingPageSize() {
    const selector = document.getElementById("bookingItemsPerPageSelect");
    bookingItemsPerPage = parseInt(selector.value);
    currentBookingPage = 1; // Reset to page 1
    renderBookingPagination();
  }

  /**
   * Open Create Booking Modal
   */
  function openCreateBookingModal() {
    document.getElementById("modalTitle").textContent = "สร้างการจองใหม่";
    document.getElementById("modalSubtitle").classList.add("hidden");
    document.getElementById("editMode").value = "false";
    document.getElementById("bookingForm").reset();
    document.getElementById("bookingId").value = "";

    // Set default booking date to today (Local Time)
    const today = new Date();
    // Adjust for timezone to ensure we get the correct local YYYY-MM-DD
    const localISOTime = new Date(
      today.getTime() - today.getTimezoneOffset() * 60000
    )
      .toISOString()
      .split("T")[0];
    document.getElementById("bookingDate").value = localISOTime;

    // Load locations and programs
    loadLocationsToSelect();
    loadProgramsToSelect();

    // Reset total and breakdown
    document.getElementById("adultSummary").textContent = "ผู้ใหญ่: 0 คน × 0 ฿";
    document.getElementById("adultTotal").textContent = "0 ฿";
    document.getElementById("childSummary").textContent = "เด็ก: 0 คน × 0 ฿";
    document.getElementById("childTotal").textContent = "0 ฿";
    document.getElementById("additionalCostAmount").textContent = "0 ฿";
    document.getElementById("discountAmount").textContent = "0 ฿";
    document.getElementById("totalAmount").textContent = "0 ฿";

    // Reset VAT
    document.getElementById("includeVat").checked = false;
    document.getElementById("vatRow").classList.add("hidden");
    document.getElementById("vatLabel").textContent = "ไม่รวม VAT";

    // Clear slip file
    clearSlipFile();

    // Show modal
    const modal = document.getElementById("bookingModal");
    const modalContent = document.getElementById("bookingModalContent");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");

    // Ensure modal starts at top
    const modalBody = document.getElementById("bookingModalBody");
    if (modalBody) modalBody.scrollTop = 0;

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);
  }

  /**
   * Close Booking Modal
   */
  function closeBookingModal() {
    const modal = document.getElementById("bookingModal");
    const modalContent = document.getElementById("bookingModalContent");

    modal.classList.add("modal-hide");
    modalContent.classList.add("modal-content-hide");

    setTimeout(() => {
      modal.classList.add("hidden");
      modal.classList.remove("modal-show", "modal-hide");
      modalContent.classList.remove("modal-content-show", "modal-content-hide");
    }, 300);
  }

  /**
   * Load Locations to Select
   */
  function loadLocationsToSelect() {
    const select = document.getElementById("location");
    select.innerHTML = '<option value="">เลือกสถานที่</option>';

    allLocations.forEach((loc) => {
      const option = document.createElement("option");
      option.value = loc.locationName;
      option.textContent = loc.locationName;
      select.appendChild(option);
    });
  }

  /**
   * Load Programs to Select
   */
  function loadProgramsToSelect() {
    const select = document.getElementById("program");
    select.innerHTML = '<option value="">เลือกโปรแกรม</option>';

    allPrograms.forEach((prog) => {
      const option = document.createElement("option");
      option.value = prog.programId;
      option.textContent = prog.programId;
      option.dataset.adultPrice = prog.adultPrice;
      option.dataset.childPrice = prog.childPrice;
      select.appendChild(option);
    });
  }

  /**
   * Update Prices when Program is selected
   */
  function updatePrices() {
    const select = document.getElementById("program");
    const selectedOption = select.options[select.selectedIndex];

    if (selectedOption && selectedOption.value) {
      document.getElementById("adultPrice").value =
        selectedOption.dataset.adultPrice || 0;
      document.getElementById("childPrice").value =
        selectedOption.dataset.childPrice || 0;
    } else {
      document.getElementById("adultPrice").value = 0;
      document.getElementById("childPrice").value = 0;
    }
    calculateTotal();
  }

  /**
   * Calculate Total Amount
   */
  function calculateTotal() {
    const adults = parseInt(document.getElementById("adults").value) || 0;
    const children = parseInt(document.getElementById("children").value) || 0;
    const adultPrice =
      parseFloat(document.getElementById("adultPrice").value) || 0;
    const childPrice =
      parseFloat(document.getElementById("childPrice").value) || 0;
    const additionalCost =
      parseFloat(document.getElementById("additionalCost").value) || 0;
    const discount = parseFloat(document.getElementById("discount").value) || 0;
    const includeVat = document.getElementById("includeVat").checked;

    // Calculate subtotals
    const adultSubtotal = adults * adultPrice;
    const childSubtotal = children * childPrice;
    const subtotal = adultSubtotal + childSubtotal + additionalCost - discount;

    // Calculate VAT if enabled
    const vatAmount = includeVat ? Math.round(subtotal * 0.07) : 0;
    const total = subtotal + vatAmount;

    // Update adult summary
    document.getElementById(
      "adultSummary"
    ).textContent = `ผู้ใหญ่: ${adults} คน × ${formatNumber(adultPrice)} ฿`;
    document.getElementById("adultTotal").textContent =
      formatNumber(adultSubtotal) + " ฿";

    // Update child summary
    document.getElementById(
      "childSummary"
    ).textContent = `เด็ก: ${children} คน × ${formatNumber(childPrice)} ฿`;
    document.getElementById("childTotal").textContent =
      formatNumber(childSubtotal) + " ฿";

    // Update additional cost
    document.getElementById("additionalCostAmount").textContent =
      additionalCost > 0 ? `${formatNumber(additionalCost)} ฿` : "0 ฿";

    // Update discount
    document.getElementById("discountAmount").textContent =
      discount > 0 ? `${formatNumber(discount)} ฿` : "0 ฿";

    // Update VAT row visibility and amount
    const vatRow = document.getElementById("vatRow");
    const vatLabel = document.getElementById("vatLabel");
    if (includeVat) {
      vatRow.classList.remove("hidden");
      document.getElementById("vatAmount").textContent =
        formatNumber(vatAmount) + " ฿";
      vatLabel.textContent = "รวม VAT";
    } else {
      vatRow.classList.add("hidden");
      vatLabel.textContent = "ไม่รวม VAT";
    }

    // Update total
    document.getElementById("totalAmount").textContent =
      formatNumber(total) + " ฿";
  }

  /**
   * Save Booking (Create or Update)
   */
  document
    .getElementById("bookingForm")
    .addEventListener("submit", function (e) {
      e.preventDefault();

      const session = getSessionFromStorage();
      if (!session || !session.sessionToken) {
        showToast("กรุณาเข้าสู่ระบบใหม่", "error");
        return;
      }

      const editMode = document.getElementById("editMode").value === "true";
      const bookingId = document.getElementById("bookingId").value;

      // Get form data
      const bookingData = {
        bookingDate: document.getElementById("bookingDate").value,
        travelDate: document.getElementById("travelDate").value,
        location: document.getElementById("location").value,
        program: document.getElementById("program").value, // ใช้ value (รหัสโปรแกรม) แทน text
        adults: parseInt(document.getElementById("adults").value) || 0,
        children: parseInt(document.getElementById("children").value) || 0,
        adultPrice:
          parseFloat(document.getElementById("adultPrice").value) || 0,
        childPrice:
          parseFloat(document.getElementById("childPrice").value) || 0,
        additionalCost:
          parseFloat(document.getElementById("additionalCost").value) || 0,
        discount: parseFloat(document.getElementById("discount").value) || 0,
        includeVat: document.getElementById("includeVat").checked,
        agent: document.getElementById("agent").value,
        notes: document.getElementById("notes").value,
      };

      // Show loading
      const btn = document.getElementById("saveBookingBtn");
      const cancelBtn = document.getElementById("cancelBookingBtn");
      const spinner = document.getElementById("saveBtnSpinner");
      const btnText = document.getElementById("saveBtnText");

      btn.disabled = true;
      cancelBtn.disabled = true; // Disable cancel button
      spinner.classList.remove("hidden");
      btnText.textContent = editMode ? "กำลังบันทึก..." : "กำลังสร้าง...";

      // Call backend
      if (editMode) {
        google.script.run
          .withSuccessHandler(async function (response) {
            if (response.success) {
              // Upload slip if a new file was selected
              if (selectedSlipFile) {
                btnText.textContent = "กำลังอัพโหลดสลิป...";
                try {
                  const slipUrl = await uploadSlipFile(bookingId);

                  if (slipUrl) {
                    // Update booking with new slip URL
                    const updateRes = await new Promise((resolve, reject) => {
                      google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .updateBookingSlip(
                          session.sessionToken,
                          bookingId,
                          slipUrl
                        );
                    });

                    if (!updateRes || !updateRes.success) {
                      console.warn("Update booking slip failed:", updateRes);
                      showToast(
                        "อัพโหลดไฟล์สำเร็จ แต่บันทึกลงฐานข้อมูลไม่สำเร็จ: " +
                          (updateRes?.message || "Unknown error"),
                        "warning"
                      );
                    }
                  } else {
                    showToast("ไม่ได้รับ URL หลังจากอัพโหลดไฟล์", "warning");
                  }
                } catch (error) {
                  console.error("Slip process error:", error);
                  showToast(
                    "แก้ไขการจองสำเร็จ แต่เกิดข้อผิดพลาดกับสลิป: " +
                      error.message,
                    "warning"
                  );
                }
              }

              btn.disabled = false;
              cancelBtn.disabled = false;
              spinner.classList.add("hidden");
              btnText.textContent = "บันทึก";

              showToast("แก้ไขการจองสำเร็จ", "success");
              closeBookingModal();
              loadBookings();
            } else {
              btn.disabled = false;
              cancelBtn.disabled = false;
              spinner.classList.add("hidden");
              btnText.textContent = "บันทึก";
              showToast(response.message || "ไม่สามารถแก้ไขได้", "error");
            }
          })
          .withFailureHandler(function (error) {
            btn.disabled = false;
            cancelBtn.disabled = false;
            spinner.classList.add("hidden");
            btnText.textContent = "บันทึก";
            showToast("เกิดข้อผิดพลาด: " + error.message, "error");
          })
          .updateBooking(session.sessionToken, bookingId, bookingData);
      } else {
        google.script.run
          .withSuccessHandler(async function (response) {
            if (response.success) {
              const createdBookingId = response.data.bookingId;

              // Upload slip if selected
              if (selectedSlipFile) {
                btnText.textContent = "กำลังอัพโหลดสลิป...";
                try {
                  const slipUrl = await uploadSlipFile(createdBookingId);
                  if (slipUrl) {
                    // Update booking with slip URL
                    await new Promise((resolve, reject) => {
                      google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .updateBookingSlip(
                          session.sessionToken,
                          createdBookingId,
                          slipUrl
                        );
                    });
                  }
                } catch (error) {
                  console.error("Slip upload error:", error);
                  showToast(
                    "สร้างการจองสำเร็จ แต่อัพโหลดสลิปไม่สำเร็จ",
                    "warning"
                  );
                }
              }

              btn.disabled = false;
              cancelBtn.disabled = false; // Re-enable cancel button
              spinner.classList.add("hidden");
              btnText.textContent = "บันทึก";

              showToast("สร้างการจองสำเร็จ", "success");
              closeBookingModal();
              loadBookings();
            } else {
              btn.disabled = false;
              cancelBtn.disabled = false; // Re-enable cancel button
              spinner.classList.add("hidden");
              btnText.textContent = "บันทึก";
              showToast(response.message || "ไม่สามารถสร้างได้", "error");
            }
          })
          .withFailureHandler(function (error) {
            btn.disabled = false;
            cancelBtn.disabled = false; // Re-enable cancel button
            spinner.classList.add("hidden");
            btnText.textContent = "บันทึก";
            showToast("เกิดข้อผิดพลาด: " + error.message, "error");
          })
          .createBooking(session.sessionToken, bookingData);
      }
    });

  /**
   * Edit Booking
   */
  function editBooking(bookingId) {
    const booking = allBookings.find((b) => b.bookingId === bookingId);
    if (!booking) {
      showToast("ไม่พบข้อมูลการจอง", "error");
      return;
    }

    // Set form values
    document.getElementById("modalTitle").textContent = "แก้ไขการจอง";

    // Show booking ID subtitle
    const subtitle = document.getElementById("modalSubtitle");
    subtitle.textContent = "รหัสการจอง: " + booking.bookingId;
    subtitle.classList.remove("hidden");
    document.getElementById("editMode").value = "true";
    document.getElementById("bookingId").value = booking.bookingId;
    document.getElementById("bookingDate").value = convertThaiDateToInputFormat(
      booking.bookingDate
    );
    document.getElementById("travelDate").value = convertThaiDateToInputFormat(
      booking.travelDate
    );

    // Load locations and programs first (ใช้ข้อมูลที่มีอยู่แล้วใน allLocations และ allPrograms)
    loadLocationsToSelect();
    loadProgramsToSelect();

    // Set location and program after options are loaded
    document.getElementById("location").value = booking.location;
    document.getElementById("program").value = booking.program;

    document.getElementById("adults").value = booking.adults;
    document.getElementById("children").value = booking.children;
    document.getElementById("adultPrice").value = booking.adultPrice;
    document.getElementById("childPrice").value = booking.childPrice;
    document.getElementById("additionalCost").value =
      booking.additionalCost || 0;
    document.getElementById("discount").value = booking.discount;
    document.getElementById("includeVat").checked = booking.includeVat || false;
    document.getElementById("agent").value = booking.agent || "";
    document.getElementById("notes").value = booking.notes || "";

    // Handle existing slip
    clearSlipFile(); // Clear any previous selection

    if (booking.slipUrl && booking.slipUrl.trim() !== "") {
      // Show existing slip
      const slipUploadArea = document.getElementById("slipUploadArea");
      const slipPreview = document.getElementById("slipPreview");

      slipUploadArea.classList.add("hidden");
      slipPreview.classList.remove("hidden");

      document.getElementById("slipFileName").textContent = "สลิปเดิม";
      document.getElementById("slipFileSize").textContent =
        "ดูรายละเอียดด้านล่าง";

      const viewLink = document.getElementById("slipViewLink");
      viewLink.href = booking.slipUrl;
      viewLink.classList.remove("hidden");

      document.getElementById("slipUrl").value = booking.slipUrl;
    } else {
      console.log("No slip URL or empty slip URL"); // Debug
    }

    calculateTotal();

    // Show modal with animation
    const modal = document.getElementById("bookingModal");
    const modalContent = document.getElementById("bookingModalContent");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");

    // Ensure modal starts at top
    const modalBody = document.getElementById("bookingModalBody");
    if (modalBody) modalBody.scrollTop = 0;

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);
  }

  /**
   * Close View Booking Modal
   */
  function closeViewBookingModal() {
    const modal = document.getElementById("viewBookingModal");
    const modalContent = document.getElementById("viewBookingModalContent");

    modal.classList.add("modal-hide");
    modalContent.classList.add("modal-content-hide");

    setTimeout(() => {
      modal.classList.add("hidden");
      modal.classList.remove("modal-show", "modal-hide");
      modalContent.classList.remove("modal-content-show", "modal-content-hide");
    }, 300);
  }

  /**
   * Delete Booking
   */
  function deleteBooking(bookingId) {
    openBookingDeleteModal(bookingId);
  }

  /**
   * Get Status Badge
   */
  function getStatusBadge(status) {
    const badges = {
      Confirm: '<span class="badge badge-info">Confirm</span>',
      Completed: '<span class="badge badge-success">Completed</span>',
      Cancel: '<span class="badge badge-danger">Cancel</span>',
    };
    return badges[status] || status;
  }

  /**
   * Format Number
   */
  function formatNumber(num) {
    return new Intl.NumberFormat("th-TH").format(num);
  }

  /**
   * Format Date for Display
   */
  function formatDateDisplay(dateStr) {
    if (!dateStr) return "-";
    const date = new Date(dateStr);
    return date.toLocaleDateString("th-TH", {
      year: "numeric",
      month: "short",
      day: "numeric",
    });
  }

  /**
   * Handle Slip File Select
   */
  var selectedSlipFile = null;

  function handleSlipFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate file size (5MB)
    const maxSize = 5 * 1024 * 1024; // 5MB in bytes
    if (file.size > maxSize) {
      showToast("ไฟล์มีขนาดใหญ่เกิน 5MB", "error");
      event.target.value = "";
      return;
    }

    // Validate file type
    const allowedTypes = [
      "image/jpeg",
      "image/jpg",
      "image/png",
      "application/pdf",
    ];
    if (!allowedTypes.includes(file.type)) {
      showToast("รองรับเฉพาะไฟล์ภาพ (JPG, PNG) หรือ PDF เท่านั้น", "error");
      event.target.value = "";
      return;
    }

    // Store file
    selectedSlipFile = file;

    // Show preview
    document.getElementById("slipUploadArea").classList.add("hidden");
    document.getElementById("slipPreview").classList.remove("hidden");
    document.getElementById("slipFileName").textContent = file.name;
    document.getElementById("slipFileSize").textContent = formatFileSize(
      file.size
    );

    // Hide view link for new files (not uploaded yet)
    document.getElementById("slipViewLink").classList.add("hidden");
  }

  /**
   * Clear Slip File
   */
  function clearSlipFile() {
    selectedSlipFile = null;
    document.getElementById("slipFile").value = "";
    document.getElementById("slipUploadArea").classList.remove("hidden");
    document.getElementById("slipPreview").classList.add("hidden");
    document.getElementById("slipUrl").value = "";

    // Hide view link
    const viewLink = document.getElementById("slipViewLink");
    viewLink.href = "#";
    viewLink.classList.add("hidden");
  }

  /**
   * Format File Size
   */
  function formatFileSize(bytes) {
    if (bytes === 0) return "0 Bytes";
    const k = 1024;
    const sizes = ["Bytes", "KB", "MB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i];
  }

  /**
   * Upload Slip to Google Drive
   */
  function uploadSlipFile(bookingId) {
    return new Promise((resolve, reject) => {
      if (!selectedSlipFile) {
        resolve(null);
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const base64Data = e.target.result.split(",")[1]; // Remove data:image/...;base64,

        const session = getSessionFromStorage();
        // Get booking date directly from inputs (assuming modal is open and has values)
        // If uploadSlipFile is used in context where inputs might not be populated or different context, consider passing date as arg.
        // Usually upload happens when saving form, so inputs should have values.
        const bookingDate = document.getElementById("bookingDate").value;

        google.script.run
          .withSuccessHandler(function (response) {
            if (response) {
              // response is the URL directly string or object wrapper?
              // The backend returns file.getUrl() string directly.
              // Wait, previous withSuccessHandler check response.success
              // Let's check backend return type again.
              // uploadBookingSlip returns file.getUrl() (String) OR throws Error.
              // But standard pattern often returns {success:true, data:...}.
              // Let's check backend code again.
              resolve(response);
            } else {
              reject(new Error("No URL returned"));
            }
          })
          .withFailureHandler(function (error) {
            reject(error);
          })
          .uploadBookingSlip(
            session.sessionToken,
            {
              data: base64Data,
              mimeType: selectedSlipFile.type,
              filename: selectedSlipFile.name,
            },
            bookingId
          );
      };
      reader.onerror = function (error) {
        reject(error);
      };
      reader.readAsDataURL(selectedSlipFile);
    });
  }

  /**
   * View Invoice PDF (Frontend Generation)
   */
  async function viewInvoice(bookingId) {
    // Get booking data from local array
    const booking = allBookings.find((b) => b.bookingId === bookingId);
    if (!booking) {
      showToast("ไม่พบข้อมูลการจอง", "error");
      return;
    }

    // Show modal and loading state
    document.getElementById("previewModalTitle").textContent = "ใบแจ้งหนี้";
    document.getElementById("previewBookingId").textContent = "#" + bookingId;
    const modal = document.getElementById("invoicePreviewModal");
    const modalContent = document.getElementById("invoicePreviewContent");
    const loading = document.getElementById("pdfLoadingState");
    const container = document.getElementById("pdfViewerContainer");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");
    loading.classList.remove("hidden");
    container.innerHTML = "";

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);

    try {
      // Generate PDF using frontend (from PDFGenerator.html)
      await previewPDF(booking);
      loading.classList.add("hidden");
    } catch (error) {
      loading.classList.add("hidden");
      showToast("เกิดข้อผิดพลาด: " + error.message, "error");
      closeInvoicePreview();
    }
  }

  function closeInvoicePreview() {
    const modal = document.getElementById("invoicePreviewModal");
    const modalContent = document.getElementById("invoicePreviewContent");
    const container = document.getElementById("pdfViewerContainer");

    modal.classList.add("modal-hide");
    modalContent.classList.add("modal-content-hide");

    setTimeout(() => {
      modal.classList.add("hidden");
      modal.classList.remove("modal-show", "modal-hide");
      modalContent.classList.remove("modal-content-show", "modal-content-hide");

      // Clear container
      container.innerHTML = "";
    }, 300);
  }

  /**
   * View Receipt PDF (Frontend Generation - for Completed bookings)
   */
  async function viewReceipt(bookingId) {
    // Get booking data from local array
    const booking = allBookings.find((b) => b.bookingId === bookingId);
    if (!booking) {
      showToast("ไม่พบข้อมูลการจอง", "error");
      return;
    }

    // Show modal and loading state
    document.getElementById("previewModalTitle").textContent = "ใบเสร็จรับเงิน";
    document.getElementById("previewBookingId").textContent = "#" + bookingId;
    const modal = document.getElementById("invoicePreviewModal");
    const modalContent = document.getElementById("invoicePreviewContent");
    const loading = document.getElementById("pdfLoadingState");
    const container = document.getElementById("pdfViewerContainer");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");
    loading.classList.remove("hidden");
    container.innerHTML = "";

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);

    try {
      // Generate PDF using frontend (from PDFGenerator.html)
      await previewPDF(booking);
      loading.classList.add("hidden");
    } catch (error) {
      loading.classList.add("hidden");
      showToast("เกิดข้อผิดพลาด: " + error.message, "error");
      closeInvoicePreview();
    }
  }

  /**
   * View Booking Detail
   */
  function viewBooking(bookingId) {
    const booking = allBookings.find((b) => b.bookingId === bookingId);
    if (!booking) {
      showToast("ไม่พบข้อมูลการจอง", "error");
      return;
    }

    // Get status badge HTML
    const statusBadge = getStatusBadge(booking.status);
    const totalPeople = (booking.adults || 0) + (booking.children || 0);

    const content = `
      <div class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 1. Booking Information -->
            <div class="space-y-4">
                <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider border-b border-gray-100 pb-2">ข้อมูลการจอง</h4>

                <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                   <div class="flex justify-between">
                      <span class="text-sm text-gray-500">รหัสการจอง</span>
                      <span class="text-sm font-bold text-gray-900">${
                        booking.bookingId
                      }</span>
                   </div>
                   <div class="flex justify-between">
                      <span class="text-sm text-gray-500">วันที่จอง</span>
                      <span class="text-sm font-medium text-gray-900">${
                        booking.bookingDate
                      }</span>
                   </div>
                   <div class="flex justify-between">
                      <span class="text-sm text-gray-500">วันที่เดินทาง</span>
                      <span class="text-sm font-medium text-gray-900">${
                        booking.travelDate
                      }</span>
                   </div>
                   <div class="flex justify-between">
                      <span class="text-sm text-gray-500">สถานะ</span>
                      <span>${statusBadge}</span>
                   </div>
                   <div class="flex justify-between">
                      <span class="text-sm text-gray-500">ทำรายการโดย</span>
                      <span class="text-sm font-medium text-gray-900">${
                        booking.createdBy
                      }</span>
                   </div>
                </div>
            </div>

            <!-- 2. Program & Location Info -->
            <div class="space-y-4">
               <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider border-b border-gray-100 pb-2">โปรแกรมและสถานที่</h4>

               <div class="bg-gradient-to-br from-purple-50 to-indigo-50 border border-purple-100 rounded-lg p-4">
                  <div class="flex items-start gap-3">
                     <div class="mt-1 bg-white p-2 rounded-lg shadow-sm text-purple-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                     </div>
                     <div>
                        <p class="text-xs text-purple-600 font-bold uppercase mb-0.5">สถานที่</p>
                        <p class="text-base font-bold text-gray-900">${
                          booking.location
                        }</p>
                        <p class="text-sm text-gray-600 mt-1">${
                          booking.program
                        }</p>
                     </div>
                  </div>
               </div>
                <div class="bg-orange-50 border border-orange-100 rounded-lg p-3 mt-3">
                    <div class="flex items-center gap-3">
                       <div class="bg-white p-1.5 rounded-lg shadow-sm text-orange-500">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                       </div>
                       <div>
                          <p class="text-xs text-orange-600 font-bold uppercase">Agent</p>
                          <p class="text-sm font-bold text-gray-900">${
                            booking.agent || "-"
                          }</p>
                       </div>
                    </div>
                 </div>
            </div>
        </div>

        <!-- 3. Passenger & Payment Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           <!-- Passenger Info -->
           <div class="space-y-4">
             <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider border-b border-gray-100 pb-2">จำนวนผู้เดินทาง</h4>
             <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                 <div class="grid grid-cols-2 gap-3">
                     <div class="bg-white rounded-lg p-3 text-center">
                         <p class="text-xs text-gray-500 font-medium">ผู้ใหญ่</p>
                         <p class="text-2xl font-bold text-blue-600">${
                           booking.adults || 0
                         }</p>
                     </div>
                     <div class="bg-white rounded-lg p-3 text-center">
                         <p class="text-xs text-gray-500 font-medium">เด็ก</p>
                         <p class="text-2xl font-bold text-indigo-600">${
                           booking.children || 0
                         }</p>
                     </div>
                 </div>
                 <div class="mt-3 pt-3 border-t border-blue-200 text-center">
                     <p class="text-sm text-gray-600">รวม <span class="font-bold text-gray-900">${totalPeople}</span> คน</p>
                 </div>
             </div>
           </div>

           <!-- Payment Breakdown -->
           <div class="space-y-4">
             <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider border-b border-gray-100 pb-2">รายละเอียดการชำระ</h4>
             <div class="bg-green-50 border border-green-100 rounded-lg p-4">
                 <div class="space-y-2">
                     <div class="flex justify-between text-sm">
                         <span class="text-gray-600">ผู้ใหญ่ (${
                           booking.adults || 0
                         } × ${Number(
      booking.adultPrice
    ).toLocaleString()})</span>
                         <span class="font-semibold text-gray-900">${Number(
                           (booking.adults || 0) * booking.adultPrice
                         ).toLocaleString()} ฿</span>
                     </div>
                     <div class="flex justify-between text-sm">
                         <span class="text-gray-600">เด็ก (${
                           booking.children || 0
                         } × ${Number(
      booking.childPrice
    ).toLocaleString()})</span>
                         <span class="font-semibold text-gray-900">${Number(
                           (booking.children || 0) * booking.childPrice
                         ).toLocaleString()} ฿</span>
                     </div>
                     <div class="flex justify-between text-sm">
                         <span class="text-gray-600">ค่าใช้จ่ายเพิ่มเติม</span>
                         <span class="font-semibold text-gray-900">${Number(
                           booking.additionalCost || 0
                         ).toLocaleString()} ฿</span>
                     </div>
                    ${
                      booking.includeVat
                        ? `
                      <div class="flex justify-between text-sm">
                        <span class="text-gray-600">VAT 7%</span>
                        <span class="font-semibold text-gray-900"
                          >${Number(
                            Math.round(
                              ((booking.adults || 0) * booking.adultPrice +
                                (booking.children || 0) * booking.childPrice +
                                (booking.additionalCost || 0) -
                                (booking.discount || 0)) *
                                0.07
                            )
                          ).toLocaleString()}
                          ฿</span
                        >
                      </div>
                      `
                        : ""
                    }
                      <div class="flex justify-between text-sm">
                         <span class="text-gray-600">ส่วนลด</span>
                         <span class="font-semibold text-red-600">${Number(
                           booking.discount || 0
                         ).toLocaleString()} ฿</span>
                     </div>
                     <div class="pt-2 mt-2 border-t border-green-200 flex justify-between">
                         <span class="font-bold text-gray-900">ยอดรวม</span>
                         <span class="font-bold text-gray-900 text-lg">${Number(
                           booking.totalAmount
                         ).toLocaleString()} ฿</span>
                     </div>
                 </div>
             </div>
           </div>
        </div>

        <!-- 4. Payment Slip (if any) -->
        ${
          booking.slipUrl
            ? `
        <div>
           <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-2">หลักฐานการชำระเงิน</h4>
           <div class="border-2 border-dashed border-gray-200 rounded-xl p-4 flex items-center justify-between hover:border-purple-200 hover:bg-purple-50 transition-colors group cursor-pointer" onclick="window.open('${booking.slipUrl}', '_blank')">
              <div class="flex items-center gap-3">
                 <div class="bg-purple-100 text-purple-600 p-2 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                 </div>
                 <div>
                    <p class="text-sm font-medium text-gray-900 group-hover:text-purple-700">สลิปการชำระเงิน</p>
                    <p class="text-xs text-gray-500">คลิกเพื่อดูรูปภาพขยาย</p>
                 </div>
              </div>
              <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transform group-hover:translate-x-1 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
           </div>
        </div>
        `
            : ""
        }

        <!-- 6. History Reason / Cancellation Reason -->
        ${
          booking.reason
            ? `
        <div>
            <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-2">
              ${
                booking.status === "Cancel"
                  ? "เหตุผลการยกเลิก"
                  : "บันทึกประวัติ"
              }
            </h4>
            <div class="${
              booking.status === "Cancel"
                ? "bg-red-50 border-red-100 text-red-800"
                : "bg-gray-50 border-gray-200 text-gray-800"
            } border rounded-lg p-3 text-sm flex items-start gap-2">
                 <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                 <p>${booking.reason}</p>
            </div>
        </div>
        `
            : ""
        }

        <!-- 7. Booking Notes -->
        ${
          booking.notes
            ? `
        <div class="mt-4">
            <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-2">หมายเหตุการจอง</h4>
            <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 text-sm text-blue-800 flex items-start gap-2">
                 <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                 <p>${booking.notes}</p>
            </div>
        </div>
        `
            : ""
        }

      </div>
    `;

    document.getElementById("viewBookingSubtitle").textContent =
      "#" + booking.bookingId;
    document.getElementById("viewBookingDate").textContent = booking.bookingDate
      ? booking.bookingDate.split(" ")[0]
      : "";
    document.getElementById("viewBookingContent").innerHTML = content;

    const modal = document.getElementById("viewBookingModal");
    const modalContent = document.getElementById("viewBookingModalContent");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);
  }

  function closeViewBookingModal() {
    const modal = document.getElementById("viewBookingModal");
    const modalContent = document.getElementById("viewBookingModalContent");

    modal.classList.add("modal-hide");
    modalContent.classList.add("modal-content-hide");

    setTimeout(() => {
      modal.classList.add("hidden");
      modal.classList.remove("modal-show", "modal-hide");
      modalContent.classList.remove("modal-content-show", "modal-content-hide");
    }, 300);
  }

  // Initialize when page loads
  if (typeof window.loadBookings === "undefined") {
    window.loadBookings = loadBookings;
  }
</script>
