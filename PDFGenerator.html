<!-- PDF Generator Utility -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
  /**
   * Generate Invoice PDF from Frontend
   */
  /**
   * สร้าง Options สำหรับ PDF ที่เสถียรที่สุด (A4 @ 96DPI = 794x1123px)
   */
  function getPDFOptions(filename) {
    return {
      margin: 0,
      filename: filename,
      image: { type: "jpeg", quality: 0.98 },
      html2canvas: {
        scale: 3,
        useCORS: true,
        letterRendering: true,
        logging: false,
        width: 794,
        windowWidth: 794,
      },
      jsPDF: {
        unit: "mm",
        format: "a4",
        orientation: "portrait",
        compress: true,
      },
      pagebreak: { mode: ["avoid-all", "css", "legacy"] },
    };
  }

  /**
   * จ่ายเวลาให้ Browser เรนเดอร์ (ช่วยแก้ปัญหาหน้าว่าง)
   */
  const wait = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

  /**
   * Generate Invoice PDF (Download)
   * วิธีที่เสถียรที่สุด: ใช้ Canvas ที่เรนเดอร์ผ่านแล้วมาสร้างเป็น PDF
   */
  async function generateInvoicePDF(booking) {
    const container = document.createElement("div");
    container.innerHTML = createInvoiceHTML(booking);
    container.style.position = "fixed";
    container.style.left = "-10000px";
    container.style.top = "0";
    container.style.width = "794px";
    container.style.background = "white";
    document.body.appendChild(container);

    try {
      await wait(500);
      const pages = container.querySelectorAll(".page");
      const canvases = [];

      for (let i = 0; i < pages.length; i++) {
        const canvas = await html2canvas(pages[i], {
          scale: 3,
          useCORS: true,
          width: 794,
          height: 1123,
          windowWidth: 794,
          windowHeight: 1123,
        });
        canvases.push(canvas);
      }

      const headerText = booking.status === "Completed" ? "Receipt" : "Invoice";
      // วางรูปทีละหน้าลงบนกระดาษ A4 เปล่าเพื่อความแม่นยำ
      let worker = html2pdf()
        .set(getPDFOptions(`${headerText}_${booking.bookingId}.pdf`))
        .from("<div></div>")
        .toPdf()
        .get("pdf")
        .then((pdf) => {
          for (let i = 0; i < canvases.length; i++) {
            if (i > 0) pdf.addPage();
            const imgData = canvases[i].toDataURL("image/jpeg", 0.98);
            pdf.addImage(imgData, "JPEG", 0, 0, 210, 297);
          }
        });
      await worker.save();
    } finally {
      document.body.removeChild(container);
    }
  }

  /**
   * Preview Invoice PDF
   */
  /**
   * แปลงตัวเลขเป็นคำอ่านภาษาไทย (Baht Text)
   */
  function arabicToThaiBaht(amount) {
    if (amount === 0) return "ศูนย์บาทถ้วน";

    const numberText = [
      "ศูนย์",
      "หนึ่ง",
      "สอง",
      "สาม",
      "สี่",
      "ห้า",
      "หก",
      "เจ็ด",
      "แปด",
      "เก้า",
    ];
    const unitText = ["", "สิบ", "ร้อย", "พัน", "หมื่น", "แสน", "ล้าน"];

    const convert = (number) => {
      let output = "";
      for (let i = 0; i < number.length; i++) {
        const n = parseInt(number[i]);
        if (n !== 0) {
          if (i === number.length - 1 && n === 1 && number.length > 1) {
            output += "เอ็ด";
          } else if (i === number.length - 2 && n === 2) {
            output += "ยี่สิบ";
          } else if (i === number.length - 2 && n === 1) {
            output += "สิบ";
          } else {
            output += numberText[n] + unitText[number.length - 1 - i];
          }
        }
      }
      return output;
    };

    const parts = amount.toFixed(2).split(".");
    let baht = parts[0];
    let satang = parts[1];
    let res = "";

    if (baht.length > 6) {
      const millions = baht.substring(0, baht.length - 6);
      baht = baht.substring(baht.length - 6);
      res = convert(millions) + "ล้าน" + convert(baht);
    } else {
      res = convert(baht);
    }

    if (res !== "") res += "บาท";

    if (satang === "00") {
      res += "ถ้วน";
    } else {
      res += convert(satang) + "สตางค์";
    }

    return res;
  }

  async function previewPDF(booking) {
    const container = document.createElement("div");
    container.innerHTML = createInvoiceHTML(booking);
    container.style.position = "fixed";
    container.style.left = "-10000px";
    container.style.top = "0";
    container.style.width = "794px";
    container.style.background = "white";
    document.body.appendChild(container);

    try {
      await wait(500);

      const pages = container.querySelectorAll(".page");
      const canvases = [];

      for (let i = 0; i < pages.length; i++) {
        const page = pages[i];
        const canvas = await html2canvas(page, {
          scale: 3,
          useCORS: true,
          letterRendering: true,
          logging: false,
          width: 794,
          height: 1123,
          windowWidth: 794,
          windowHeight: 1123,
        });
        canvases.push(canvas);
      }

      const headerText = booking.status === "Completed" ? "Receipt" : "Invoice";
      // สร้าง PDF Blob เปล่าแล้ววางรูปทีละหน้าเพื่อความแม่นยำ
      let worker = html2pdf()
        .set(getPDFOptions(`${headerText}_${booking.bookingId}.pdf`))
        .from("<div></div>")
        .toPdf()
        .get("pdf")
        .then((pdf) => {
          for (let i = 0; i < canvases.length; i++) {
            if (i > 0) pdf.addPage();
            const imgData = canvases[i].toDataURL("image/jpeg", 0.98);
            pdf.addImage(imgData, "JPEG", 0, 0, 210, 297);
          }
        });
      const pdfBlob = await worker.output("blob");

      showPDFPreview(
        canvases,
        pdfBlob,
        `${headerText}_${booking.bookingId}.pdf`,
        booking.bookingId
      );
    } catch (error) {
      console.error("PDF Preview Error:", error);
      showToast("ไม่สามารถสร้าง PDF ได้: " + error.message, "error");
    } finally {
      document.body.removeChild(container);
    }
  }

  /**
   * Create Invoice HTML Template
   */
  function createInvoiceHTML(booking) {
    const themeColor = "#7c3aed";

    const adultTotal = (booking.adults || 0) * (booking.adultPrice || 0);
    const childTotal = (booking.children || 0) * (booking.childPrice || 0);
    const additionalCost = booking.additionalCost || 0;
    const bahtText = arabicToThaiBaht(booking.totalAmount || 0);

    const isCompleted = booking.status === "Completed";
    const docTitle = isCompleted ? "ใบเสร็จรับเงิน" : "ใบแจ้งหนี้";
    const recipientLabel = isCompleted ? "ผู้รับใบเสร็จ" : "ผู้รับใบแจ้งหนี้";
    const issuerLabel = isCompleted ? "ผู้ออกใบเสร็จ" : "ผู้ออกใบแจ้งหนี้";

    const formatDate = (dateStr) => {
      if (!dateStr) {
        const d = new Date();
        const day = String(d.getDate()).padStart(2, "0");
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
      }
      return dateStr;
    };

    return `
        <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
        <style>
          .page { 
            font-family: 'Sarabun', sans-serif;
            box-sizing: border-box;
            width: 210mm;
            min-height: 297mm;
            margin: 0 !important;
            background: white;
            position: relative;
            padding-top: 10mm;
            padding-left: 15mm;
            padding-right: 15mm;
            padding-bottom: 10mm;

            color: black; 
            font-size: 13px;
            line-height: 1.5;
          }

          .header {
            margin-bottom: 20px;
            text-align: center;
          }

          .company-info {
            font-size: 12px;
            line-height: 1.6;
            text-align: left;
            margin-top: 100px;
          }

          .doc-title {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            text-align: center;
          }

          .doc-subtitle {
            color: #754595;
            text-align: center;
            margin-bottom: 5px;
          }

          .info-section {
            padding-top: 20px;
          }

          .info-section table {
            width: 100%;
            border-collapse: collapse;
          }

          .info-item {
            padding: 5px 0;
          }

          .info-label {
            color: #754595;
            padding-right: 15px;
            text-align: left;
            width: 100px;
          }

          .info-value {
            color: #1f2937;
          }

          table.items {
            width: 100%;
            margin-top: 10px;
          }

          table.items th {
            padding: 10px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
          }

          .summary {
            margin-top: 10px;
            text-align: right;
          }

          .summary-row {
            font-size: 13px;
          }

          .summary-label {
            display: inline-block;
            min-width: 150px;
            text-align: right;
            color: #754595;
          }

          .summary-value {
            display: inline-block;
            min-width: 150px;
            text-align: right;
          }

          .notes {
            margin: 10px 0;
          }

          .notes-label {
            font-size: 11px;
            font-weight: 600;
            color: #754595;
            margin-bottom: 5px;
          }

          .notes-content {
            font-size: 12px;
            color: #6b7280;
          }

          .footer {
            position: absolute;
            bottom: 15mm;
            left: 20mm;
            right: 20mm;
            font-size: 12px;
            padding-top: 15px;
          }

          .footer table {
            width: 100%;
            border-collapse: collapse;
          }
        </style>
        <div class="page">
          <div class="info-section">
            <table>
              <tr>
                <td style="width: 50%; vertical-align: top; padding-right: 20px;">
                  <div class="company-info">
                   บริษัท ซีแลนด์ แอดเวนเจอร์ จำกัด (สำนักงานใหญ่)<br>
                   23 ม.2 ต.สองแพรก อ.เมือง จ.พังงา<br>
                   เลขประจำตัวผู้เสียภาษี 0825566000935
                  </div>
                </td>
                <td style="width: 50%; vertical-align: top;">
                    <div class="header">
                        <div class="doc-title">${docTitle}</div>
                        <div class="doc-subtitle">ต้นฉบับ</div>
                    </div>
                  <div style="border-top: 1px solid #e5e7eb;"/>
                  <table style="width: 100%; margin-top: 10px;">
                    <tr class="info-item">
                      <td class="info-label">เลขที่</td>
                      <td class="info-value">${
                        booking.bookingId || "BK-202601090102"
                      }</td>
                    </tr>
                    <tr class="info-item">
                      <td class="info-label">วันที่</td>
                      <td class="info-value">${formatDate(
                        booking.bookingDate
                      )}</td>
                    </tr>
                    <tr class="info-item">
                      <td class="info-label">ครบกำหนด</td>
                      <td class="info-value">${formatDate(
                        booking.travelDate
                      )}</td>
                    </tr>
                    <tr class="info-item">
                      <td class="info-label">ผู้ขาย</td>
                      <td class="info-value">บริษัท ซีแลนด์ แอดเวนเจอร์ จำกัด</td>
                    </tr>
                  </table>
                  <div style="border-top: 1px solid #e5e7eb; margin-top: 10px;"/>
                </td>
              </tr>
            </table>
          </div>

          <div>
            <table style="width: 100%;">
              <tr>
                <td style="width: 25%; padding: 8px 0;">
                  <div style="color: #754595; font-weight: 600; margin-bottom: 3px;">ลูกค้า</div>
                  <div style="font-weight: 500;">${booking.agent}</div>
                </td>
                <td style="width: 25%; padding: 8px 0;">
                  <div style="color: #754595; font-weight: 600; margin-bottom: 3px;">โปรแกรม</div>
                  <div style="font-weight: 500;">${booking.program || "-"}</div>
                </td>
                <td style="width: 25%; padding: 8px 0;">
                  <div style="color: #754595; font-weight: 600; margin-bottom: 3px;">สถานที่</div>
                  <div style="font-weight: 500;">${
                    booking.location || "-"
                  }</div>
                </td>
              </tr>
            </table>
          </div>

          <table class="items">
            <thead>
              <tr style="border-top: 1px solid #e5e7eb;">
                <th style="width: 5%; text-align: center;">#</th>
                <th style="width: 40%;">รายละเอียด</th>
                <th style="width: 15%; text-align: center;">จำนวน</th>
                <th style="width: 20%; text-align: right;">ราคาต่อหน่วย</th>
                <th style="width: 20%; text-align: right;">เงินรวม</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="text-align: center; padding: 10px; border-bottom: 1px solid #f3f4f6;">1</td>
                <td style="padding: 10px; border-bottom: 1px solid #f3f4f6;">ผู้ใหญ่</td>
                <td style="text-align: center; padding: 10px; border-bottom: 1px solid #f3f4f6;">${
                  booking.adults || 0
                }</td>
                <td style="text-align: right; padding: 10px; border-bottom: 1px solid #f3f4f6;">${(
                  booking.adultPrice || 0
                ).toLocaleString("th-TH", { minimumFractionDigits: 2 })}</td>
                <td style="text-align: right; padding: 10px; border-bottom: 1px solid #f3f4f6;">${adultTotal.toLocaleString(
                  "th-TH",
                  { minimumFractionDigits: 2 }
                )}</td>
              </tr>
              <tr>
                <td style="text-align: center; padding: 10px; border-bottom: 1px solid #f3f4f6;">2</td>
                <td style="padding: 10px; border-bottom: 1px solid #f3f4f6;">เด็ก</td>
                <td style="text-align: center; padding: 10px; border-bottom: 1px solid #f3f4f6;">${
                  booking.children || 0
                }</td>
                <td style="text-align: right; padding: 10px; border-bottom: 1px solid #f3f4f6;">${(
                  booking.childPrice || 0
                ).toLocaleString("th-TH", { minimumFractionDigits: 2 })}</td>
                <td style="text-align: right; padding: 10px; border-bottom: 1px solid #f3f4f6;">${childTotal.toLocaleString(
                  "th-TH",
                  { minimumFractionDigits: 2 }
                )}</td>
              </tr>
            </tbody>
          </table>

          <div class="summary">
            ${
              booking.additionalCost
                ? `
              <div class="summary-row">
              <span class="summary-label">ค่าใช้จ่ายเพิ่มเติม</span>
              <span class="summary-value">${booking.additionalCost.toLocaleString(
                "th-TH",
                {
                  minimumFractionDigits: 2,
                }
              )} บาท</span>
            </div>`
                : ""
            }
            ${
              booking.includeVat
                ? `
            <div class="summary-row">
              <span class="summary-label">ภาษีมูลค่าเพิ่ม 7%</span>
              <span class="summary-value">${Number(
                Math.round(
                  ((booking.adults || 0) * booking.adultPrice +
                    (booking.children || 0) * booking.childPrice +
                    (booking.additionalCost || 0) -
                    (booking.discount || 0)) *
                    0.07
                )
              ).toLocaleString("th-TH", {
                minimumFractionDigits: 2,
              })} บาท</span>
            </div>`
                : ""
            }
            <div class="summary-row">
              <span class="summary-label">ส่วนลด</span>
              <span class="summary-value">${(
                booking.discount || 0
              ).toLocaleString("th-TH", {
                minimumFractionDigits: 2,
              })} บาท</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">จำนวนรวมทั้งสิ้น</span>
              <span class="summary-value">${booking.totalAmount.toLocaleString(
                "th-TH",
                {
                  minimumFractionDigits: 2,
                }
              )} บาท</span>
            </div>
            </div>
            
          <div style="text-align: left; margin-bottom: 10px; font-weight: 500; color: #1f2937;">
            (${bahtText})
          </div>
          <div class="notes">
            <div class="notes-label">หมายเหตุ</div>
            <div class="notes-content">${booking.notes || ""}</div>
          </div>

          <div class="footer">
            <table style="width: 100%;">
              <tr>
                <td style="width: 50%; vertical-align: top;">
                  <div style="font-size: 12px; margin-bottom: 60px; text-align: left;">ในนาม ${booking.agent}</div>
                  <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                      <td style="width: 37%; border-top: 1px solid #e5e7eb; padding-top: 5px; text-align: center; font-size: 12px; color: #000;">${recipientLabel}</td>
                      <td style="width: 6%;"></td>
                      <td style="width: 37%; border-top: 1px solid #e5e7eb; padding-top: 5px; text-align: center; font-size: 12px; color: #000;">วันที่</td>
                      <td style="width: 20%;"></td>
                    </tr>
                  </table>
                </td>
                <td style="width: 50%; vertical-align: top;">
                  <div style="font-size: 12px; margin-bottom: 60px; text-align: right;">ในนาม บริษัท ซีแลนด์ แอดเวนเจอร์ จำกัด</div>
                  <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                      <td style="width: 20%;"></td>
                      <td style="width: 37%; border-top: 1px solid #e5e7eb; padding-top: 5px; text-align: center; font-size: 12px; color: #000;">${issuerLabel}</td>
                      <td style="width: 6%;"></td>
                      <td style="width: 37%; border-top: 1px solid #e5e7eb; padding-top: 5px; text-align: center; font-size: 12px; color: #000;">วันที่</td>
                    </tr>
                  </table>
                </td>
              </tr>
            </table>
          </div>
        </div>

        ${
          !isCompleted
            ? `
        <!-- Page 2: Payment Information -->
        <div class="page">
          <div style="color: #00bcd4; font-size: 24px; font-weight: 700; margin-bottom: 30px;">ข้อมูลการรับชำระ</div>
          
          <div style="margin-bottom: 30px;">
            <div style="font-size: 12px; line-height: 1.6;">
              บริษัท ซีแลนด์ แอดเวนเจอร์ จำกัด (สำนักงานใหญ่)<br>
              23 ม.2 ต.สองแพรก อ.เมือง จ.พังงา<br>
              เลขประจำตัวผู้เสียภาษี 0825566000935
            </div>
          </div>

          <div style="border-top: 1px solid #e5e7eb; padding-top: 30px;">
            <div style="font-size: 20px; font-weight: 700; margin-bottom: 30px;">โอนเงิน</div>
            
            <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 40px; text-align: center; max-width: 350px;">
              <!-- QR Code Placeholder -->
             <div style="width: 46px; height: 46px; margin: 0 auto 20px; border: 2px solid #00a950; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
  <img src="https://www.kasikornbank.com/SiteCollectionDocuments/about/img/logo/logo.png" style="width: 30px; height: auto; object-fit: contain;" crossorigin="anonymous"/>
</div>
              
              <div style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">163-1-12928-1</div>
              <div style="font-size: 14px; color: #666; margin-bottom: 4px;">ธ. กสิกรไทย</div>
              <div style="font-size: 13px; color: #999;">บจก. ซีแลนด์ แอดเวนเจอร์</div>
            </div>
          </div>
        </div>`
            : ""
        }
    `;
  }

  /**
   * Wrapper functions
   */
  async function viewInvoice(bookingId) {
    const booking = allBookings.find((b) => b.bookingId === bookingId);
    if (!booking) {
      showToast("ไม่พบข้อมูลการจอง", "error");
      return;
    }

    await previewPDF(booking);
  }

  function downloadInvoice(bookingId) {
    const booking = allBookings.find((b) => b.bookingId === bookingId);
    if (!booking) {
      showToast("ไม่พบข้อมูลการจอง", "error");
      return;
    }

    generateInvoicePDF(booking);
    showToast("กำลังสร้าง PDF...", "info");
  }

  function showPDFPreview(canvases, pdfBlob, filename, bookingId) {
    document.getElementById("previewBookingId").textContent = "#" + bookingId;
    const modal = document.getElementById("invoicePreviewModal");
    const modalContent = document.getElementById("invoicePreviewContent");
    const container = document.getElementById("pdfViewerContainer");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);

    // สร้าง Blob URL จาก pdfBlob ที่ส่งมาโดยตรง
    const blobUrl = URL.createObjectURL(pdfBlob);

    container.innerHTML = "";

    // Ensure container displays items vertically
    container.style.display = "flex";
    container.style.flexDirection = "column";
    container.style.alignItems = "center";
    container.style.gap = "20px";

    // Handle both single canvas and array of canvases
    const canvasArray = Array.isArray(canvases) ? canvases : [canvases];

    canvasArray.forEach((canvas, index) => {
      canvas.style.width = "100%";
      canvas.style.maxWidth = "100%";
      canvas.style.height = "auto";
      canvas.style.display = "block";
      canvas.style.borderRadius = "8px";
      canvas.style.boxShadow = "0 4px 6px rgba(0,0,0,0.1)";
      canvas.style.backgroundColor = "white";

      container.appendChild(canvas);
    });

    const downloadBtn = document.getElementById("downloadInvoiceBtn");
    downloadBtn.onclick = () => {
      const link = document.createElement("a");
      link.href = blobUrl;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    window.openInNewTab = () => {
      window.open(blobUrl, "_blank");
    };

    window.pdfCleanup = () => {
      URL.revokeObjectURL(blobUrl);
    };
  }
</script>
