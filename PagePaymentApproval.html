<!-- Payment Approval Page - Modern UI -->
<div class="space-y-6">
  <!-- Date Filter Section -->
  <div class="bg-white rounded-2xl shadow-lg p-6">
    <!-- Dynamic Header & Filters Row -->
    <div
      class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4"
    >
      <!-- Left side: Title -->
      <div>
        <h3 class="text-lg font-bold text-gray-800">กรองข้อมูลการอนุมัติ</h3>
        <p class="text-sm text-gray-500 mt-1">เลือกช่วงเวลาเพื่อดูข้อมูล</p>
      </div>

      <!-- Right side: All Filter Controls -->
      <div class="flex flex-col lg:flex-row lg:items-center gap-4">
        <!-- Part 1: Quick Filter Buttons -->
        <div
          class="grid grid-cols-2 sm:grid-cols-4 lg:flex lg:flex-row gap-2 order-2 lg:order-1"
        >
          <button
            onclick="setPaymentDateFilter('all')"
            class="px-3 py-2 bg-gray-50 text-gray-600 rounded-lg hover:bg-gray-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            ทั้งหมด
          </button>
          <button
            onclick="setPaymentDateFilter('today')"
            class="px-3 py-2 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            วันนี้
          </button>
          <button
            onclick="setPaymentDateFilter('month')"
            class="px-3 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            เดือนนี้
          </button>
          <button
            onclick="setPaymentDateFilter('year')"
            class="px-3 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            ปีนี้
          </button>
        </div>

        <!-- Part 2: Separator / Label -->
        <div class="hidden lg:block w-px h-8 bg-gray-200 order-2"></div>
        <div class="lg:hidden order-3 border-t border-gray-100 pt-4 mt-2">
          <label
            class="text-xs text-gray-500 uppercase tracking-wide mb-2 block"
            >กำหนดช่วงเวลาเอง</label
          >
        </div>

        <!-- Part 3: Date Inputs -->
        <div
          class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 order-3 lg:order-3"
        >
          <input
            type="date"
            id="paymentFilterDateFrom"
            class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 text-sm input-modern lg:w-40"
            placeholder="จาก"
          />
          <span class="hidden sm:inline text-gray-400">-</span>
          <input
            type="date"
            id="paymentFilterDateTo"
            class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 text-sm input-modern lg:w-40"
            placeholder="ถึง"
          />
          <button
            onclick="applyCustomPaymentDateFilter()"
            class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all font-medium text-sm whitespace-nowrap"
          >
            ค้นหา
          </button>
        </div>
      </div>
    </div>

    <!-- Current Filter Display -->
    <div class="mt-4 pt-4 border-t border-gray-100">
      <p class="text-sm text-gray-600">
        <span class="font-semibold">ช่วงเวลาที่เลือก:</span>
        <span id="currentPaymentFilterText" class="text-purple-600 ml-2"
          >ทั้งหมด</span
        >
      </p>
    </div>
  </div>

  <!-- Header Actions -->
  <div
    class="flex flex-col lg:flex-row justify-between items-stretch lg:items-center gap-4"
  >
    <!-- Search and Filters Group -->
    <div class="w-full lg:w-auto lg:flex-1">
      <div
        class="grid grid-cols-1 sm:grid-cols-2 lg:flex lg:flex-row gap-3 lg:items-center"
      >
        <!-- Refresh & Search Group -->
        <div class="flex flex-row gap-2 sm:col-span-2 lg:flex-1">
          <!-- Refresh Button -->
          <button
            onclick="refreshPaymentData()"
            class="flex-shrink-0 flex items-center justify-center p-3 bg-white border-2 border-gray-100 rounded-xl text-gray-500 hover:text-purple-600 hover:border-purple-100 hover:bg-purple-50 transition-all duration-200 shadow-sm"
            title="รีเฟรชข้อมูล"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
          </button>

          <!-- Search -->
          <div class="relative flex-1 lg:w-64">
            <input
              type="text"
              id="searchPayment"
              placeholder="ค้นหาการจอง..."
              onkeyup="filterPayments()"
              class="w-full input-modern pl-10"
            />
            <svg
              class="w-5 h-5 text-gray-400 absolute left-3 top-3.5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
              ></path>
            </svg>
          </div>
        </div>

        <!-- Filter by Status -->
        <select
          id="filterPaymentStatus"
          onchange="filterPayments()"
          class="w-full sm:w-auto input-modern select-modern"
        >
          <option value="">ทุกสถานะ</option>
          <option value="Confirm">Confirm</option>
          <option value="Completed">Completed</option>
          <option value="Cancel">Cancel</option>
        </select>

        <!-- Filter by Location -->
        <select
          id="filterPaymentLocation"
          onchange="filterPayments()"
          class="w-full sm:w-auto input-modern select-modern"
        >
          <option value="">ทุกสถานที่</option>
          <!-- Options will be populated dynamically -->
        </select>
      </div>
    </div>
  </div>

  <!-- Payment Table Container (Desktop) -->
  <div
    class="hidden lg:block bg-white rounded-2xl shadow-xl shadow-gray-100 overflow-hidden border border-gray-100"
  >
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-gray-50 border-b border-gray-100">
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            รหัสการจอง
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            วันที่จอง
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            วันที่เดินทาง
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            สถานที่/โปรแกรม
          </th>
          <th
            class="px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            ยอดรวม
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            สถานะ
          </th>
          <th
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            สลิป
          </th>
          <th
            id="th-manage"
            class="px-6 py-4 text-center text-xs font-bold text-gray-500 uppercase tracking-wider"
          >
            จัดการ
          </th>
        </tr>
      </thead>
      <tbody id="paymentTableBody" class="divide-y divide-gray-100">
        <tr>
          <td colspan="8" class="px-6 py-12 text-center text-gray-400">
            <div class="flex flex-col items-center justify-center space-y-3">
              <div
                class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"
              ></div>
              <p class="text-gray-400 text-sm font-medium animate-pulse">
                กำลังดึงข้อมูลการอนุมัติ...
              </p>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Payment List Container (Mobile/Tablet) -->
  <div
    id="paymentGridBody"
    class="lg:hidden grid grid-cols-1 md:grid-cols-2 gap-4"
  >
    <div class="col-span-full py-12 text-center">
      <div class="flex flex-col items-center justify-center space-y-3">
        <div
          class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"
        ></div>
        <p class="text-gray-400 text-sm font-medium animate-pulse">
          กำลังดึงข้อมูลการอนุมัติ...
        </p>
      </div>
    </div>
  </div>

  <!-- Pagination Controls -->
  <div
    class="flex flex-col sm:flex-row justify-between items-center gap-4 bg-white px-6 py-4 rounded-2xl shadow-sm border border-gray-100"
  >
    <!-- Rows per page -->
    <div class="flex items-center space-x-3 text-sm text-gray-600">
      <span class="font-medium">แสดง</span>
      <select
        id="paymentItemsPerPageSelect"
        onchange="changePaymentPageSize()"
        class="input-modern select-modern w-full sm:w-auto"
      >
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>
      <span class="font-medium">รายการต่อหน้า</span>
    </div>

    <!-- Page Info & Navigation -->
    <div class="flex flex-col sm:flex-row items-center gap-4">
      <span
        class="hidden sm:inline text-sm font-medium text-gray-500"
        id="paymentPaginationInfo"
        >หน้า 1 จาก 1 (0 รายการ)</span
      >
      <div class="flex items-center space-x-1">
        <button
          onclick="changePaymentPage('prev')"
          id="paymentPrevPageBtn"
          class="p-4 sm:p-2 border border-gray-200 rounded-xl sm:rounded-lg hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
        >
          <svg
            class="w-6 h-6 sm:w-5 sm:h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            ></path>
          </svg>
        </button>

        <!-- Desktop Page Numbers -->
        <div
          id="paymentPageNumbers"
          class="hidden sm:flex items-center space-x-1"
        >
          <!-- Page buttons will be injected here -->
        </div>

        <!-- Mobile Page Info -->
        <div
          class="sm:hidden flex items-center px-6 py-2 bg-purple-50 rounded-xl text-sm font-bold text-purple-700 min-w-[100px] justify-center"
        >
          <span id="paymentMobilePageInfo">1 / 1</span>
        </div>

        <button
          onclick="changePaymentPage('next')"
          id="paymentNextPageBtn"
          class="p-4 sm:p-2 border border-gray-200 rounded-xl sm:rounded-lg hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
        >
          <svg
            class="w-6 h-6 sm:w-5 sm:h-5"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            ></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div
    id="emptyPaymentState"
    class="hidden text-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-100"
  >
    <div
      class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <svg
        class="w-10 h-10 text-gray-300"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
        ></path>
      </svg>
    </div>
    <h3 class="text-lg font-bold text-gray-900">ไม่พบรายการจอง</h3>
    <p class="text-gray-500">ไม่มีรายการจองที่ตรงกับเงื่อนไขที่เลือก</p>
  </div>
</div>

<!-- View Payment Detail Modal -->
<div
  id="viewPaymentModal"
  class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
>
  <div
    id="viewPaymentModalContent"
    class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col"
  >
    <!-- Modal Header with Pattern -->
    <div
      class="relative overflow-hidden bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-6 flex-shrink-0 z-20"
    >
      <div class="relative z-10 flex justify-between items-start">
        <div>
          <button
            onclick="closeViewPaymentModal()"
            class="absolute -top-2 -right-2 p-2 bg-white/10 hover:bg-white/20 rounded-full text-white transition-colors"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
          <div class="flex items-center gap-2 mb-1">
            <span
              class="px-2 py-0.5 rounded text-xs font-semibold bg-white/20 border border-white/20"
              >Payment Detail</span
            >
            <span id="viewPaymentDate" class="text-xs text-purple-100"></span>
          </div>
          <h3 class="text-2xl font-bold">รายละเอียดการจอง</h3>
          <p
            id="viewPaymentSubtitle"
            class="text-purple-100 opacity-90 mt-1 text-sm"
          ></p>
        </div>
      </div>
    </div>

    <!-- Modal Content (Scrollable) -->
    <div class="overflow-y-auto flex-1">
      <div id="viewPaymentContent" class="px-6 pb-6 pt-8 relative z-20">
        <!-- Content will be injected here -->
      </div>
    </div>

    <!-- Modal Footer -->
    <div
      id="viewPaymentFooter"
      class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t border-gray-100 flex-shrink-0"
    >
      <!-- Buttons will be injected here via JS -->
    </div>
  </div>
</div>

<!-- Update Status Modal -->
<div
  id="updateStatusModal"
  class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm"
>
  <div
    id="updateStatusModalContent"
    class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 overflow-hidden"
  >
    <!-- Modal Header -->
    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-6 relative">
      <h3 class="text-2xl font-bold text-white">เปลี่ยนสถานะการจอง</h3>
      <button
        type="button"
        onclick="closeUpdateStatusModal()"
        class="absolute top-4 right-4 text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition-all duration-200"
      >
        <svg
          class="w-6 h-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </button>
    </div>

    <!-- Modal Body -->
    <div
      id="updateStatusModalBody"
      class="overflow-y-auto max-h-[calc(90vh-180px)]"
    >
      <div class="p-6 space-y-4">
        <input type="hidden" id="statusBookingId" />

        <div class="transition-all duration-200">
          <label class="block text-sm font-semibold text-gray-700 mb-2"
            >สถานะปัจจุบัน</label
          >
          <div class="flex justify-between items-center">
            <div id="currentStatusDisplay" class="text-lg font-semibold"></div>
            <div id="statusSlipContainer" class="hidden">
              <a
                id="statusSlipBtn"
                href="#"
                target="_blank"
                class="inline-flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-xl text-sm font-bold hover:bg-blue-100 transition-all border border-blue-100"
              >
                <svg
                  class="w-4 h-4 mr-1.5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                  ></path>
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                  ></path>
                </svg>
                ดูสลิป
              </a>
            </div>
          </div>
        </div>

        <div class="transition-all duration-200">
          <label class="block text-sm font-semibold text-gray-700 mb-2"
            >สถานะใหม่ <span class="text-red-500">*</span></label
          >
          <select
            id="newStatusSelect"
            onchange="toggleReasonField()"
            class="input-modern select-modern w-full"
          >
            <option value="">-- เลือกสถานะ --</option>
            <option value="Confirm">Confirm</option>
            <option value="Completed">Completed</option>
            <option value="Cancel">Cancel</option>
          </select>
        </div>

        <div id="reasonField" class="hidden transition-all duration-200">
          <label class="block text-sm font-semibold text-gray-700 mb-2"
            >เหตุผล (สำหรับการยกเลิก) <span class="text-red-500">*</span></label
          >
          <textarea
            id="statusReasonText"
            rows="3"
            class="input-modern"
            placeholder="ระบุเหตุผล..."
          ></textarea>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div
      class="bg-gray-50 px-6 py-4 flex justify-end space-x-3 border-t border-gray-200"
    >
      <button
        type="button"
        id="cancelStatusBtn"
        onclick="closeUpdateStatusModal()"
        class="px-6 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-medium"
      >
        ยกเลิก
      </button>
      <button
        type="button"
        id="confirmStatusBtn"
        onclick="confirmStatusUpdate()"
        class="px-6 py-2.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl hover:shadow-lg active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed transition-all duration-200 font-bold flex items-center space-x-2 shadow-purple-200"
      >
        <span
          id="statusBtnSpinner"
          class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"
        ></span>
        <span id="statusBtnText">บันทึก</span>
      </button>
    </div>
  </div>
</div>

<!-- ========================================
     REFUND SYSTEM MODAL (Combined)
     ======================================== -->

<!-- Create Refund Modal (All-in-One) -->
<div
  id="createRefundModal"
  class="hidden fixed inset-0 bg-gray-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4"
>
  <div
    id="createRefundModalContent"
    class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-hidden flex flex-col"
  >
    <!-- Modal Header with Pattern -->
    <div
      class="relative overflow-hidden bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-6 flex-shrink-0 z-20"
    >
      <div class="relative z-10 flex justify-between items-start">
        <div>
          <button
            type="button"
            onclick="closeCreateRefundModal()"
            class="absolute -top-2 -right-2 p-2 bg-white/10 hover:bg-white/20 rounded-full text-white transition-colors"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"
              ></path>
            </svg>
          </button>
          <div class="flex items-center gap-2 mb-1">
            <span
              class="px-2 py-0.5 rounded text-xs font-semibold bg-white/20 border border-white/20"
              >Refund Processing</span
            >
            <span id="refundDateLabel" class="text-xs text-purple-100"></span>
          </div>
          <h3 class="text-2xl font-bold">สร้างรายการคืนเงิน</h3>
          <p class="text-purple-100 opacity-90 mt-1 text-sm">
            บันทึกข้อมูลและแนบหลักฐานการคืนเงินให้ลูกค้า
          </p>
        </div>
      </div>
    </div>

    <!-- Scrollable Content -->
    <div
      id="createRefundModalBody"
      class="flex-1 overflow-y-auto max-h-[calc(90vh-140px)] px-6 pb-6 pt-8 relative z-20 space-y-6"
    >
      <!-- 1. Booking Summary -->
      <div
        class="bg-gray-50 border border-gray-100 rounded-xl p-4 flex items-center justify-between"
      >
        <div>
          <p class="text-xs text-gray-500 uppercase font-bold tracking-wide">
            รหัสการจอง
          </p>
          <span
            id="refundBookingId"
            class="text-lg font-bold text-indigo-600"
          ></span>
        </div>
        <div class="text-right">
          <p class="text-xs text-gray-500 uppercase font-bold tracking-wide">
            ยอดชำระรวม
          </p>
          <span
            id="refundTotalAmount"
            class="text-lg font-bold text-gray-900"
          ></span>
        </div>
      </div>

      <form onsubmit="event.preventDefault();" class="space-y-6">
        <!-- 2. Customer Info Zone -->
        <div class="space-y-4">
          <h4
            class="text-sm font-bold text-gray-900 uppercase tracking-wider flex items-center gap-2 border-b pb-2 border-gray-100"
          >
            <svg
              class="w-5 h-5 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
              ></path>
            </svg>
            ข้อมูลผู้รับเงิน
          </h4>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >ชื่อ-นามสกุล <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                id="customerName"
                class="input-modern"
                placeholder="ระบุชื่อบัญชีผู้รับเงิน"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >ธนาคาร <span class="text-red-500">*</span></label
              >
              <select id="customerBankName" class="select-modern">
                <option value="">-- เลือกธนาคาร --</option>
                <option value="พร้อมเพย์ (PromptPay)">
                  พร้อมเพย์ (PromptPay)
                </option>
                <option value="กสิกรไทย (KBank)">กสิกรไทย (KBank)</option>
                <option value="ไทยพาณิชย์ (SCB)">ไทยพาณิชย์ (SCB)</option>
                <option value="กรุงเทพ (BBL)">กรุงเทพ (BBL)</option>
                <option value="กรุงไทย (KTB)">กรุงไทย (KTB)</option>
                <option value="กรุงศรี (BAY)">กรุงศรี (BAY)</option>
                <option value="ทหารไทยธนชาต (TTB)">ทหารไทยธนชาต (TTB)</option>
                <option value="ออมสิน (GSB)">ออมสิน (GSB)</option>
                <option value="ธ.ก.ส. (BAAC)">ธ.ก.ส. (BAAC)</option>
                <option value="OTHER">อื่นๆ</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >เลขที่บัญชี <span class="text-red-500">*</span></label
              >
              <input
                type="text"
                id="customerAccountNumber"
                class="input-modern"
                placeholder="ระบุหมายเลขบัญชี"
                inputmode="numeric"
                oninput="this.value = this.value.replace(/[^0-9]/g, '')"
              />
            </div>
          </div>
        </div>

        <!-- 3. Refund Details Zone -->
        <div class="space-y-4">
          <h4
            class="text-sm font-bold text-gray-900 uppercase tracking-wider flex items-center gap-2 border-b pb-2 border-gray-100"
          >
            <svg
              class="w-5 h-5 text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
            รายละเอียดการโอนคืน
          </h4>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >ยอดเงินที่คืน (บาท) <span class="text-red-500">*</span></label
              >
              <input
                type="number"
                id="refundAmount"
                min="0"
                step="0.01"
                onfocus="this.select()"
                class="input-modern"
                placeholder="0.00"
              />
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                หลักฐานการคืนเงิน <span class="text-red-500">*</span>
              </label>
              <div
                class="border-2 border-dashed border-gray-300 rounded-xl p-6 hover:border-purple-400 transition-all"
              >
                <input
                  type="file"
                  id="refundSlipFile"
                  accept="image/*,.pdf"
                  class="hidden"
                  onchange="handleRefundSlipSelect(event)"
                />
                <div
                  id="refundSlipUploadArea"
                  class="text-center cursor-pointer"
                  onclick="document.getElementById('refundSlipFile').click()"
                >
                  <svg
                    class="w-12 h-12 mx-auto text-gray-400 mb-3"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                    ></path>
                  </svg>
                  <p class="text-sm text-gray-600 mb-1">
                    <span class="text-purple-600 font-semibold"
                      >คลิกเพื่ออัพโหลด</span
                    >
                    หรือลากไฟล์มาวาง
                  </p>
                  <p class="text-xs text-gray-500">
                    รองรับไฟล์ภาพ (JPG, PNG) หรือ PDF (ขนาดไม่เกิน 5MB)
                  </p>
                </div>
                <div id="refundSlipPreview" class="hidden mt-4">
                  <div
                    class="flex items-center justify-between bg-gray-50 rounded-lg p-3"
                  >
                    <div class="flex items-center space-x-3">
                      <svg
                        class="w-8 h-8 text-green-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                      </svg>
                      <div>
                        <p
                          class="text-sm font-semibold text-gray-700"
                          id="refundSlipFileName"
                        >
                          -
                        </p>
                        <p
                          class="text-xs text-gray-500"
                          id="refundSlipFileSize"
                        >
                          -
                        </p>
                      </div>
                    </div>
                    <div class="flex items-center space-x-2">
                      <a
                        id="refundSlipViewLink"
                        href="#"
                        target="_blank"
                        class="text-purple-600 hover:text-purple-800 p-1 hidden"
                        title="ดูไฟล์"
                      >
                        <svg
                          class="w-5 h-5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                          ></path>
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                          ></path>
                        </svg>
                      </a>
                      <button
                        type="button"
                        onclick="clearRefundSlip()"
                        class="text-red-500 hover:text-red-700 p-1"
                        title="ลบไฟล์"
                      >
                        <svg
                          class="w-5 h-5"
                          fill="none"
                          stroke="currentColor"
                          viewBox="0 0 24 24"
                        >
                          <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                          ></path>
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-1"
                >หมายเหตุ</label
              >
              <textarea
                id="refundNote"
                rows="2"
                class="input-modern resize-none"
                placeholder="รายละเอียดเพิ่มเติม (ถ้ามี)"
              ></textarea>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Modal Footer -->
    <div
      class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t border-gray-100 flex-shrink-0"
    >
      <button
        type="button"
        onclick="closeCreateRefundModal()"
        class="px-6 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-medium"
      >
        ยกเลิก
      </button>
      <button
        id="saveRefundBtn"
        type="button"
        onclick="saveRefund()"
        class="px-6 py-2.5 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-xl hover:shadow-lg hover:scale-[1.02] active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed transition-all duration-200 font-bold flex items-center space-x-2 shadow-purple-200"
      >
        <span
          id="saveRefundSpinner"
          class="hidden w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"
        ></span>
        <span id="saveRefundText">บันทึกการคืนเงิน</span>
      </button>
    </div>
  </div>
</div>

<script>
  let allPayments = [];
  let allLocationsPaymentFilter = [];
  let currentPayment = null;

  /**
   * Format Date for Input (YYYY-MM-DD)
   */
  function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }

  /**
   * Format Date to Thai (DD/MM/YYYY)
   */
  function formatDateThai(date) {
    const day = String(date.getDate()).padStart(2, "0");
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  /**
   * Set Payment Date Filter (Quick Filters)
   */
  function setPaymentDateFilter(type) {
    const today = new Date();
    let startDate, endDate;

    switch (type) {
      case "all":
        startDate = "";
        endDate = "";
        document.getElementById("currentPaymentFilterText").textContent =
          "ทั้งหมด";
        break;

      case "today":
        startDate = endDate = formatDateForInput(today);
        document.getElementById("currentPaymentFilterText").textContent =
          "วันนี้";
        break;

      case "month":
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        startDate = formatDateForInput(firstDay);
        endDate = formatDateForInput(lastDay);
        document.getElementById("currentPaymentFilterText").textContent =
          "เดือนนี้";
        break;

      case "year":
        const yearStart = new Date(today.getFullYear(), 0, 1);
        const yearEnd = new Date(today.getFullYear(), 11, 31);
        startDate = formatDateForInput(yearStart);
        endDate = formatDateForInput(yearEnd);
        document.getElementById("currentPaymentFilterText").textContent =
          "ปีนี้";
        break;
    }

    // Update input fields
    document.getElementById("paymentFilterDateFrom").value = startDate;
    document.getElementById("paymentFilterDateTo").value = endDate;

    // Trigger load (fetch from server)
    loadPayments(startDate, endDate);
  }

  /**
   * Apply Custom Payment Date Filter
   */
  function applyCustomPaymentDateFilter() {
    const startDate = document.getElementById("paymentFilterDateFrom").value;
    const endDate = document.getElementById("paymentFilterDateTo").value;

    if (!startDate || !endDate) {
      showToast("กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด", "warning");
      return;
    }

    if (new Date(startDate) > new Date(endDate)) {
      showToast("วันที่เริ่มต้นต้องน้อยกว่าหรือเท่ากับวันที่สิ้นสุด", "error");
      return;
    }

    // Update filter display
    const start = new Date(startDate);
    const end = new Date(endDate);
    document.getElementById(
      "currentPaymentFilterText"
    ).textContent = `${formatDateThai(start)} - ${formatDateThai(end)}`;

    // Trigger load (fetch from server)
    loadPayments(startDate, endDate);
  }

  /**
   * Populate Payment Location Filter Dropdown
   */
  function populatePaymentLocationFilter() {
    const filterLocation = document.getElementById("filterPaymentLocation");
    if (!filterLocation) return;

    // Clear existing options except the first one
    filterLocation.innerHTML = '<option value="">ทุกสถานที่</option>';

    // Add location options
    allLocationsPaymentFilter.forEach((location) => {
      const option = document.createElement("option");
      option.value = location.locationName;
      option.textContent = location.locationName;
      filterLocation.appendChild(option);
    });
  }

  // Initialize
  function loadPaymentApproval() {
    loadPayments();
  }

  // Load Payments
  function loadPayments(startDate, endDate) {
    const session = getSessionFromStorage();
    if (!session || !session.sessionToken) {
      showToast("กรุณาเข้าสู่ระบบใหม่", "error");
      return;
    }

    const startDateEl = document.getElementById("paymentFilterDateFrom");
    const endDateEl = document.getElementById("paymentFilterDateTo");

    // Default to this month if parameters are undefined (e.g. initial load)
    if (startDate === undefined || endDate === undefined) {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      startDate = formatDateForInput(firstDay);
      endDate = formatDateForInput(lastDay);

      if (startDateEl) startDateEl.value = startDate;
      if (endDateEl) endDateEl.value = endDate;
      document.getElementById("currentPaymentFilterText").textContent =
        "เดือนนี้";
    }

    // Use values from inputs if arguments are not provided (or just updated)
    const finalStartDate = startDateEl ? startDateEl.value : startDate;
    const finalEndDate = endDateEl ? endDateEl.value : endDate;

    showPaymentLoading();

    // Fetch locations first if not already loaded
    if (allLocationsPaymentFilter.length === 0) {
      google.script.run
        .withSuccessHandler(function (response) {
          if (response.success) {
            allLocationsPaymentFilter = response.data;
            populatePaymentLocationFilter();
          }
        })
        .getAllLocations(session.sessionToken);
    }

    // Always fetch ALL statuses for the date range, then filter client-side
    google.script.run
      .withSuccessHandler(onPaymentsLoaded)
      .withFailureHandler(onPaymentError)
      .getBookingsForApproval(
        session.sessionToken,
        null,
        finalStartDate,
        finalEndDate
      );
  }

  function refreshPaymentData() {
    document.getElementById("searchPayment").value = "";
    document.getElementById("filterPaymentStatus").value = "";
    document.getElementById("filterPaymentLocation").value = "";
    document.getElementById("paymentFilterDateFrom").value = "";
    document.getElementById("paymentFilterDateTo").value = "";
    document.getElementById("currentPaymentFilterText").textContent = "ทั้งหมด";
    loadPayments();
  }

  // --- Pagination Variables ---
  var currentPaymentPage = 1;
  var paymentItemsPerPage = 10;
  var currentFilteredPayments = [];

  function onPaymentsLoaded(response) {
    hidePaymentLoading();

    if (!response.success) {
      showToast(response.message, "error");
      if (response.message.includes("Session")) {
        setTimeout(() => {
          window.location.href = "?page=login";
        }, 2000);
      }
      return;
    }

    // Sort by bookingId in descending order (newest first)
    allPayments = (response.data || []).sort((a, b) => {
      return b.bookingId.localeCompare(a.bookingId);
    });

    // Apply current filters (Status, Location, Search)
    filterPayments();
  }

  function displayPayments(payments) {
    const tbody = document.getElementById("paymentTableBody");
    const gridBody = document.getElementById("paymentGridBody");
    const emptyState = document.getElementById("emptyPaymentState");

    const session = getSessionFromStorage();
    const isCostRole = session && session.role === "Cost";

    // Hide/Show Manage Header
    const thManage = document.getElementById("th-manage");
    if (thManage) {
      if (isCostRole) {
        thManage.classList.add("hidden");
      } else {
        thManage.classList.remove("hidden");
      }
    }

    if (payments.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="px-6 py-12 text-center text-gray-400">
            <div class="flex flex-col items-center space-y-3">
              <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center">
                <svg class="w-10 h-10 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              <span class="text-lg font-semibold">ไม่พบรายการจอง</span>
            </div>
          </td>
        </tr>
      `;
      gridBody.innerHTML = "";
      emptyState.classList.remove("hidden");
      return;
    }

    emptyState.classList.add("hidden");

    // Desktop Table
    tbody.innerHTML = payments
      .map(
        (payment) => `
      <tr class="hover:bg-gray-50 transition-colors cursor-pointer" onclick='viewPaymentDetail(${JSON.stringify(
        payment
      ).replace(/'/g, "&#39;")})'>
        <td class="px-6 py-4">
          <div class="text-sm font-bold text-gray-900">${
            payment.bookingId
          }</div>
          <div class="text-xs text-gray-500">โดย: ${payment.createdBy}</div>
        </td>
        <td class="px-6 py-4 text-sm text-gray-700">${payment.bookingDate}</td>
        <td class="px-6 py-4 text-sm text-gray-700">${payment.travelDate}</td>
        <td class="px-6 py-4">
          <div class="text-sm font-medium text-gray-900">${
            payment.location
          }</div>
          <div class="text-xs text-gray-500">${payment.program}</div>
        </td>
        <td class="px-6 py-4">
          <div class="text-sm font-bold text-gray-900">${Number(
            payment.totalAmount
          ).toLocaleString()} ฿</div>
          <div class="text-xs text-gray-500">${payment.adults} ผู้ใหญ่, ${
          payment.children
        } เด็ก</div>
        </td>
        <td class="px-6 py-4 text-center">
          ${getStatusBadge(payment.status)}
        </td>
        <td class="px-6 py-4 text-center">
          ${
            payment.slipUrl
              ? `<a href="${payment.slipUrl}" target="_blank" onclick="event.stopPropagation()" class="inline-flex items-center px-3 py-1 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                  </svg>
                </a>`
              : '<span class="text-gray-400">-</span>'
          }
        </td>
        <td class="px-6 py-4 text-center ${isCostRole ? "hidden" : ""}">
          ${
            payment.status !== "Cancel"
              ? `<button 
            onclick='event.stopPropagation(); openUpdateStatusModal(${JSON.stringify(
              payment
            ).replace(/'/g, "&#39;")})' 
            class="inline-flex text-sm items-center px-3 py-1 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition-all font-medium"
          >
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            เปลี่ยนสถานะ
          </button>`
              : '<span class="text-xs text-gray-400 font-medium"></span>'
          }
        </td>
      </tr>
    `
      )
      .join("");

    // Mobile Cards
    gridBody.innerHTML = payments
      .map((payment) => {
        const statusBadge = getStatusBadge(payment.status);
        const totalPeople =
          (Number(payment.adults) || 0) + (Number(payment.children) || 0);

        return `
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 hover:shadow-md transition-shadow relative overflow-hidden group">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <span class="text-xs font-bold text-gray-400">#${
                    payment.bookingId
                  }</span>
                  <h3 class="font-semibold text-gray-800 line-clamp-1">${
                    payment.program || "-"
                  }</h3>
                  <p class="text-sm text-gray-500 flex items-center mt-1">
                    <svg class="w-4 h-4 mr-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    ${payment.location || "-"}
                  </p>
                </div>
                <div class="flex-shrink-0 ml-2">${statusBadge}</div>
              </div>
              
              <div class="space-y-2 text-sm text-gray-600 mb-4 border-t border-b border-gray-50 py-3 bg-gray-50/50 -mx-4 px-4">
                <div class="flex justify-between">
                  <span class="text-gray-500">เดินทาง</span> 
                  <span class="font-medium text-gray-800">${
                    payment.travelDate
                  }</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">จำนวนคน</span> 
                  <span class="font-medium text-gray-800">${totalPeople} คน</span>
                </div>
                <div class="flex justify-between">
                  <span class="text-gray-500">ยอดรวม</span> 
                  <span class="font-bold text-purple-600">${Number(
                    payment.totalAmount
                  ).toLocaleString()} ฿</span>
                </div>
              </div>

              <div class="flex space-x-2">
                <button onclick='viewPaymentDetail(${JSON.stringify(
                  payment
                ).replace(
                  /'/g,
                  "&#39;"
                )})' class="flex-1 flex items-center justify-center py-2 bg-blue-50 text-blue-700 rounded-xl text-sm font-bold hover:bg-blue-100 transition-colors">
                  <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                  รายละเอียด
                </button>
                ${
                  !isCostRole && payment.status !== "Cancel"
                    ? `<button onclick='event.stopPropagation(); openUpdateStatusModal(${JSON.stringify(
                        payment
                      ).replace(
                        /'/g,
                        "&#39;"
                      )})' class="flex-1 flex items-center justify-center py-2 bg-purple-50 text-purple-700 rounded-xl text-sm font-bold hover:bg-purple-100 transition-colors">
                  <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                  เปลี่ยนสถานะ
                </button>`
                    : ""
                }
              </div>
            </div>
          `;
      })
      .join("");
  }

  function getStatusBadge(status) {
    const statusMap = {
      Confirm: { class: "bg-blue-100 text-blue-800", text: "Confirm" },
      Completed: { class: "bg-green-100 text-green-800", text: "Completed" },
      Cancel: { class: "bg-red-100 text-red-800", text: "Cancel" },
    };

    const statusInfo = statusMap[status] || {
      class: "bg-gray-100 text-gray-800",
      text: status,
    };
    return `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${statusInfo.class}">${statusInfo.text}</span>`;
  }

  function filterPayments() {
    const searchTerm = document
      .getElementById("searchPayment")
      ?.value.toLowerCase();
    const statusFilter = document.getElementById("filterPaymentStatus")?.value;
    const locationFilter = document.getElementById(
      "filterPaymentLocation"
    )?.value;
    const dateFrom = document.getElementById("paymentFilterDateFrom")?.value;
    const dateTo = document.getElementById("paymentFilterDateTo")?.value;

    let filtered = allPayments;

    if (statusFilter) {
      filtered = filtered.filter((p) => p.status === statusFilter);
    }

    if (locationFilter) {
      filtered = filtered.filter((p) => p.location === locationFilter);
    }

    if (searchTerm) {
      filtered = filtered.filter(
        (p) =>
          p.bookingId.toLowerCase().includes(searchTerm) ||
          p.location.toLowerCase().includes(searchTerm) ||
          p.program.toLowerCase().includes(searchTerm) ||
          (p.agent && p.agent.toLowerCase().includes(searchTerm))
      );
    }

    // Date filter - Filter by bookingDate
    if (dateFrom || dateTo) {
      filtered = filtered.filter((p) => {
        const bookingDate = p.bookingDate;
        // Check if bookingDate is in DD/MM/YYYY format
        if (bookingDate && bookingDate.includes("/")) {
          const parts = bookingDate.split("/");
          if (parts.length === 3) {
            // Convert DD/MM/YYYY to YYYY-MM-DD
            const comparableDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
            return (
              (!dateFrom || comparableDate >= dateFrom) &&
              (!dateTo || comparableDate <= dateTo)
            );
          }
        } else {
          // If already in YYYY-MM-DD format
          return (
            (!dateFrom || bookingDate >= dateFrom) &&
            (!dateTo || bookingDate <= dateTo)
          );
        }
        return true;
      });
    }

    // Sort by bookingId in ascending order
    filtered = filtered.sort((a, b) => {
      return b.bookingId.localeCompare(a.bookingId);
    });

    currentFilteredPayments = filtered;
    currentPaymentPage = 1;
    renderPaymentPagination();
  }

  // View Payment Detail
  function viewPaymentDetail(payment) {
    const session = getSessionFromStorage();
    const isCostRole = session && session.role === "Cost";

    currentPayment = payment;

    const totalPeople = (payment.adults || 0) + (payment.children || 0);
    const statusBadge = getStatusBadge(payment.status);

    const content = `
      <div class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 1. Booking Information -->
            <div class="space-y-4">
                <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider border-b border-gray-100 pb-2">ข้อมูลการจอง</h4>
                
                <div class="bg-gray-50 rounded-lg p-4 space-y-3">
                   <div class="flex justify-between">
                      <span class="text-sm text-gray-500">รหัสการจอง</span>
                      <span class="text-sm font-bold text-gray-900">${
                        payment.bookingId
                      }</span>
                   </div>
                   <div class="flex justify-between">
                      <span class="text-sm text-gray-500">วันที่จอง</span>
                      <span class="text-sm font-medium text-gray-900">${
                        payment.bookingDate
                      }</span>
                   </div>
                   <div class="flex justify-between">
                      <span class="text-sm text-gray-500">วันที่เดินทาง</span>
                      <span class="text-sm font-medium text-gray-900">${
                        payment.travelDate
                      }</span>
                   </div>
                   <div class="flex justify-between">
                      <span class="text-sm text-gray-500">สถานะ</span>
                      <span>${statusBadge}</span>
                   </div>
                   <div class="flex justify-between">
                      <span class="text-sm text-gray-500">ทำรายการโดย</span>
                      <span class="text-sm font-medium text-gray-900">${
                        payment.createdBy
                      }</span>
                   </div>
                </div>
            </div>

            <!-- 2. Program & Location Info -->
            <div class="space-y-4">
               <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider border-b border-gray-100 pb-2">โปรแกรมและสถานที่</h4>
               
               <div class="bg-gradient-to-br from-purple-50 to-indigo-50 border border-purple-100 rounded-lg p-4">
                  <div class="flex items-start gap-3">
                     <div class="mt-1 bg-white p-2 rounded-lg shadow-sm text-purple-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                     </div>
                     <div>
                        <p class="text-xs text-purple-600 font-bold uppercase mb-0.5">สถานที่</p>
                        <p class="text-base font-bold text-gray-900">${
                          payment.location
                        }</p>
                        <p class="text-sm text-gray-600 mt-1">${
                          payment.program
                        }</p>
                     </div>
                  </div>
               </div>

               <div class="bg-orange-50 border border-orange-100 rounded-lg p-3 mt-3">
                    <div class="flex items-center gap-3">
                       <div class="bg-white p-1.5 rounded-lg shadow-sm text-orange-500">
                          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                       </div>
                       <div>
                          <p class="text-xs text-orange-600 font-bold uppercase">Agent</p>
                          <p class="text-sm font-bold text-gray-900">${
                            payment.agent || "-"
                          }</p>
                       </div>
                    </div>
                 </div>
            </div>
        </div>

        <!-- 3. Passenger & Payment Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
           <!-- Passenger Info -->
           <div class="space-y-4">
             <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider border-b border-gray-100 pb-2">จำนวนผู้เดินทาง</h4>
             <div class="bg-blue-50 border border-blue-100 rounded-lg p-4">
                 <div class="grid grid-cols-2 gap-3">
                     <div class="bg-white rounded-lg p-3 text-center">
                         <p class="text-xs text-gray-500 font-medium">ผู้ใหญ่</p>
                         <p class="text-2xl font-bold text-blue-600">${
                           payment.adults || 0
                         }</p>
                     </div>
                     <div class="bg-white rounded-lg p-3 text-center">
                         <p class="text-xs text-gray-500 font-medium">เด็ก</p>
                         <p class="text-2xl font-bold text-indigo-600">${
                           payment.children || 0
                         }</p>
                     </div>
                 </div>
                 <div class="mt-3 pt-3 border-t border-blue-200 text-center">
                     <p class="text-sm text-gray-600">รวม <span class="font-bold text-gray-900">${totalPeople}</span> คน</p>
                 </div>
             </div>
           </div>

           <!-- Payment Breakdown -->
           <div class="space-y-4">
             <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider border-b border-gray-100 pb-2">รายละเอียดการชำระ</h4>
             <div class="bg-green-50 border border-green-100 rounded-lg p-4">
                 <div class="space-y-2">
                     <div class="flex justify-between text-sm">
                         <span class="text-gray-600">ผู้ใหญ่ (${
                           payment.adults || 0
                         } × ${Number(
      payment.adultPrice
    ).toLocaleString()})</span>
                         <span class="font-semibold text-gray-900">${Number(
                           (payment.adults || 0) * payment.adultPrice
                         ).toLocaleString()} ฿</span>
                     </div>
                     <div class="flex justify-between text-sm">
                         <span class="text-gray-600">เด็ก (${
                           payment.children || 0
                         } × ${Number(
      payment.childPrice
    ).toLocaleString()})</span>
                         <span class="font-semibold text-gray-900">${Number(
                           (payment.children || 0) * payment.childPrice
                         ).toLocaleString()} ฿</span>
                     </div>
                     <div class="flex justify-between text-sm">
                         <span class="text-gray-600">ค่าใช้จ่ายเพิ่มเติม</span>
                         <span class="font-semibold text-gray-900">${Number(
                           payment.additionalCost || 0
                         ).toLocaleString()} ฿</span>
                     </div>
                      ${
                        payment.includeVat
                          ? `
                      <div class="flex justify-between text-sm">
                        <span class="text-gray-600">VAT 7%</span>
                        <span class="font-semibold text-gray-900"
                          >${Number(
                            Math.round(
                              ((payment.adults || 0) * payment.adultPrice +
                                (payment.children || 0) * payment.childPrice +
                                (payment.additionalCost || 0) -
                                (payment.discount || 0)) *
                                0.07
                            )
                          ).toLocaleString()}
                          ฿</span
                        >
                      </div>
                      `
                          : ""
                      }
                     <div class="flex justify-between text-sm">
                         <span class="text-gray-600">ส่วนลด</span>
                         <span class="font-semibold text-red-600">${Number(
                           payment.discount || 0
                         ).toLocaleString()} ฿</span>
                     </div>
                     <div class="pt-2 mt-2 border-t border-green-200 flex justify-between">
                         <span class="font-bold text-gray-900">ยอดรวม</span>
                         <span class="font-bold text-gray-900 text-lg">${Number(
                           payment.totalAmount
                         ).toLocaleString()} ฿</span>
                     </div>
                 </div>
             </div>
           </div>
        </div>

        <!-- 4. Payment Input Section -->
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4">
          <h3 class="font-bold text-gray-900 mb-3 flex items-center">
            <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            การชำระเงิน
          </h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-1">เงินโอน (฿)</label>
              <input 
                type="number" 
                id="transferAmount" 
                value="${payment.transferAmount || 0}"
                min="0"
                onfocus="this.select()"
                oninput="calculateTotalPaid()"
                class="input-modern"
                placeholder="0.00"
              />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-1">เงินสด (฿)</label>
              <input 
                type="number" 
                id="cashAmount" 
                value="${payment.cashAmount || 0}"
                min="0"
                onfocus="this.select()"
                oninput="calculateTotalPaid()"
                class="input-modern"
                placeholder="0.00"
              />
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-1">เงินสดจ่ายหน้างาน (฿)</label>
              <input 
                type="number" 
                id="cashOnTour" 
                value="${payment.cashOnTour || 0}"
                min="0"
                onfocus="this.select()"
                oninput="calculateTotalPaid()"
                class="input-modern"
                placeholder="0.00"
              />
            </div>
          </div>
          
          <div class="mt-3 p-3 bg-white rounded-lg border border-green-200">
            <div class="flex justify-between items-center">
              <span class="text-sm font-semibold text-gray-700">รวมเงินที่ชำระ :</span>
              <span id="totalPaidDisplay" class="text-xl font-bold text-green-600">
                ${Number(
                  (payment.transferAmount || 0) +
                    (payment.cashAmount || 0) +
                    (payment.cashOnTour || 0)
                ).toLocaleString()} ฿
              </span>
            </div>
            <div class="flex justify-between items-center mt-2 pt-2 border-t border-gray-100">
              <span class="text-sm font-semibold text-gray-700">คงเหลือ :</span>
              <span id="remainingAmount" class="font-bold ${
                payment.totalAmount -
                  ((payment.transferAmount || 0) +
                    (payment.cashAmount || 0) +
                    (payment.cashOnTour || 0)) >
                0
                  ? "text-red-600"
                  : "text-green-600"
              }">
                ${Number(
                  payment.totalAmount -
                    ((payment.transferAmount || 0) +
                      (payment.cashAmount || 0) +
                      (payment.cashOnTour || 0))
                ).toLocaleString()} ฿
              </span>
            </div>
          </div>

          ${
            !isCostRole
              ? `
          <button 
            id="savePaymentBtn"
            onclick="savePaymentAmounts()"
            class="w-full mt-3 px-4 py-2.5 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg hover:shadow-lg transition-all font-semibold flex items-center justify-center disabled:opacity-70 disabled:cursor-not-allowed"
          >
            <span id="savePaymentSpinner" class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin mr-2"></span>
            <svg id="savePaymentIcon" class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="savePaymentText">บันทึกข้อมูลการชำระเงิน</span>
          </button>
          `
              : ""
          }
        </div>

        ${
          payment.note
            ? `
        <!-- 5. Note -->
        <div>
            <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-2">หมายเหตุ</h4>
            <div class="bg-yellow-50 border border-yellow-100 rounded-lg p-3 text-sm text-yellow-800 flex items-start gap-2">
                 <svg class="w-5 h-5 text-yellow-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                 <p>${payment.note}</p>
            </div>
        </div>
        `
            : ""
        }

        ${
          payment.slipUrl
            ? `
        <!-- 6. Payment Slip -->
        <div>
           <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-2">หลักฐานการชำระเงิน</h4>
           <div class="border-2 border-dashed border-gray-200 rounded-xl p-4 flex items-center justify-between hover:border-purple-200 hover:bg-purple-50 transition-colors group cursor-pointer" onclick="window.open('${payment.slipUrl}', '_blank')">
              <div class="flex items-center gap-3">
                 <div class="bg-purple-100 text-purple-600 p-2 rounded-lg">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                 </div>
                 <div>
                    <p class="text-sm font-medium text-gray-900 group-hover:text-purple-700">สลิปการชำระเงิน</p>
                    <p class="text-xs text-gray-500">คลิกเพื่อดูรูปภาพขยาย</p>
                 </div>
              </div>
              <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transform group-hover:translate-x-1 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
           </div>
        </div>
        `
            : ""
        }

        ${
          payment.notes
            ? `
        <div class="mt-4">
            <h4 class="text-sm font-bold text-gray-900 uppercase tracking-wider mb-2">หมายเหตุการจอง</h4>
            <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 text-sm text-blue-800 flex items-start gap-2">
                 <svg class="w-5 h-5 text-blue-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"></path></svg>
                 <p>${payment.notes}</p>
            </div>
        </div>
        `
            : ""
        }

        <!-- 7. Refund Status (Dynamic) -->
        <div id="refundStatusContainer"></div>

        <!-- 8. History Section -->
        <div class="border-t pt-4">
          <h3 class="font-bold text-gray-900 mb-3 flex items-center">
            <svg class="w-5 h-5 mr-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            ประวัติการเปลี่ยนสถานะ
          </h3>
          <div id="paymentHistoryList" class="space-y-4">
            <div class="flex flex-col items-center justify-center py-6 space-y-3">
              <div class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"></div>
               <p class="text-gray-400 text-xs font-medium animate-pulse">กำลังดึงข้อมูลประวัติ...</p>
            </div>
          </div>
        </div>

        <!-- 9. Created/Updated Info -->
        <div class="text-xs text-gray-500 border-t pt-4 space-y-1">
          <div>สร้างโดย: ${payment.createdBy} (${payment.createdAt})</div>
          ${
            payment.updatedBy
              ? `<div>แก้ไขล่าสุดโดย: ${payment.updatedBy} (${payment.updatedAt})</div>`
              : ""
          }
        </div>

      </div>
    `;

    // Footer Buttons
    const footerContent = `
      ${
        !isCostRole
          ? `
      <button 
        onclick='openRefundModal(${JSON.stringify(payment).replace(
          /'/g,
          "&#39;"
        )})'
        class="px-6 py-2.5 bg-gradient-to-r from-red-500 to-rose-600 text-white rounded-xl hover:shadow-lg active:scale-95 transition-all duration-200 font-bold flex items-center gap-2"
      >
        คืนเงิน
      </button>

      ${
        payment.status !== "Cancel"
          ? `<button 
              onclick='openUpdateStatusModal(${JSON.stringify(payment).replace(
                /'/g,
                "&#39;"
              )})' 
              class="px-6 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-xl hover:shadow-lg active:scale-95 transition-all duration-200 font-bold flex items-center gap-2 shadow-purple-200"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              เปลี่ยนสถานะ
            </button>`
          : ""
      }
      `
          : ""
      }

      <button 
        onclick="closeViewPaymentModal()" 
        class="px-6 py-2.5 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 font-medium"

      >
        ปิด
      </button>
    `;

    document.getElementById("viewPaymentSubtitle").textContent =
      "รหัสการจอง: " + payment.bookingId;
    document.getElementById("viewPaymentContent").innerHTML = content;
    document.getElementById("viewPaymentFooter").innerHTML = footerContent;

    // Load history
    loadPaymentHistory(payment.bookingId);

    // Check for Refund info
    checkBookingRefund(payment.bookingId);

    const modal = document.getElementById("viewPaymentModal");
    const modalContent = document.getElementById("viewPaymentModalContent");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");

    // Ensure modal starts at top
    const modalBody = document.getElementById("viewPaymentModalBody");
    if (modalBody) modalBody.scrollTop = 0;

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);
  }

  /**
   * Check if booking has been refunded
   */
  function checkBookingRefund(bookingId) {
    const container = document.getElementById("refundStatusContainer");
    if (!container) return;

    // Show Loading
    container.innerHTML = `
      <div class="flex flex-col items-center justify-center py-6 space-y-3 mb-6">
        <div class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"></div>
        <p class="text-gray-400 text-xs font-medium animate-pulse">กำลังตรวจสอบข้อมูลการคืนเงิน...</p>
      </div>
    `;

    const session = getSessionFromStorage();
    if (!session) return;

    google.script.run
      .withSuccessHandler(function (response) {
        if (response && response.success && response.data) {
          renderRefundInfo(response.data);
        } else {
          // No refund record found
          container.innerHTML = `
            <div class="py-4 px-6 bg-gray-50 rounded-xl border border-dashed border-gray-200 mb-6 text-center">
              <p class="text-gray-400 text-sm italic">ไม่มีประวัติการคืนเงิน</p>
            </div>
          `;
        }
      })
      .getRefundByBookingId(session.sessionToken, bookingId);
  }

  function renderRefundInfo(refund) {
    const container = document.getElementById("refundStatusContainer");
    if (!container) return;

    container.innerHTML = `
      <div class="bg-gradient-to-br from-rose-50 to-red-50 border-2 border-red-200 rounded-xl p-4 mb-6 animate-pulse-subtle">
        <h3 class="font-bold text-red-900 mb-2 flex items-center justify-between">
          <span class="flex items-center">
            คืนเงินเรียบร้อยแล้ว
          </span>
          <span class="text-xs font-medium px-2 py-0.5 bg-red-100 text-red-600 rounded-full">Refunded</span>
        </h3>
        
        <div class="grid grid-cols-2 gap-y-2 text-sm">
          <div class="text-gray-600">ชื่อบัญชี:</div>
          <div class="font-semibold text-gray-900 text-right">${
            refund.customerName || ""
          }</div>

          <div class="text-gray-600">เลขที่บัญชี:</div>
          <div class="font-semibold text-gray-900 text-right">${
            refund.accountNumber || ""
          }</div>

          <div class="text-gray-600">โอนเข้าบัญชี:</div>
          <div class="font-semibold text-gray-900 text-right">${
            refund.bankName
          }</div>

          <div class="text-gray-600">ยอดเงินคืน:</div>
          <div class="font-bold text-red-600 text-right">${Number(
            refund.refundAmount
          ).toLocaleString()} ฿</div>
          
          <div class="text-gray-600 text-xs col-span-2 text-right text-gray-500 mt-1">
            เมื่อ ${refund.createdAt} โดย ${refund.createdBy}
          </div>
        </div>

        ${
          refund.slipUrl
            ? `
          <div class="mt-3 pt-3 border-t border-red-100">
            <a href="${refund.slipUrl}" target="_blank" class="flex items-center justify-center gap-2 text-xs font-bold text-red-600 hover:text-red-800 transition-colors">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              ดูหลักฐานการโอนคืน
            </a>
          </div>
        `
            : ""
        }
      </div>
    `;
  }

  function closeViewPaymentModal() {
    const modal = document.getElementById("viewPaymentModal");
    const modalContent = document.getElementById("viewPaymentModalContent");

    modal.classList.add("modal-hide");
    modalContent.classList.add("modal-content-hide");

    setTimeout(() => {
      modal.classList.add("hidden");
      modal.classList.remove("modal-show", "modal-hide");
      modalContent.classList.remove("modal-content-show", "modal-content-hide");
    }, 300);
  }

  // Update Status Modal
  function openUpdateStatusModal(payment) {
    if (payment.status === "Cancel") {
      showToast("ไม่สามารถเปลี่ยนสถานะรายการที่ยกเลิกแล้วได้", "info");
      return;
    }
    currentPayment = payment;

    document.getElementById("statusBookingId").value = payment.bookingId;
    document.getElementById("currentStatusDisplay").innerHTML = getStatusBadge(
      payment.status
    );

    // Populate status dropdown excluding current status
    const statusSelect = document.getElementById("newStatusSelect");
    const allStatuses = ["Confirm", "Completed", "Cancel"];
    const currentStatus = payment.status;

    statusSelect.innerHTML = '<option value="">-- เลือกสถานะ --</option>';
    allStatuses.forEach((status) => {
      // Skip current status
      if (status === currentStatus) {
        return;
      }

      // Prevent changing from Completed back to Confirm
      if (currentStatus === "Completed" && status === "Confirm") {
        return;
      }

      const option = document.createElement("option");
      option.value = status;
      option.textContent = status;
      statusSelect.appendChild(option);
    });

    document.getElementById("statusReasonText").value = "";

    // Hide reason field by default
    document.getElementById("reasonField").classList.add("hidden");

    // Slip button logic
    const slipContainer = document.getElementById("statusSlipContainer");
    const slipBtn = document.getElementById("statusSlipBtn");

    if (payment.slipUrl) {
      slipContainer.classList.remove("hidden");
      slipBtn.href = payment.slipUrl;
    } else {
      slipContainer.classList.add("hidden");
      slipBtn.href = "#";
    }

    const modal = document.getElementById("updateStatusModal");
    const modalContent = document.getElementById("updateStatusModalContent");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");

    // Ensure modal starts at top
    const modalBody = document.getElementById("updateStatusModalBody");
    if (modalBody) modalBody.scrollTop = 0;

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);
  }

  function toggleReasonField() {
    const statusSelect = document.getElementById("newStatusSelect");
    const reasonField = document.getElementById("reasonField");

    if (statusSelect.value === "Cancel") {
      reasonField.classList.remove("hidden");
    } else {
      reasonField.classList.add("hidden");
      // Clear reason text when hiding
      document.getElementById("statusReasonText").value = "";
    }
  }

  function closeUpdateStatusModal() {
    const modal = document.getElementById("updateStatusModal");
    const modalContent = document.getElementById("updateStatusModalContent");

    modal.classList.add("modal-hide");
    modalContent.classList.add("modal-content-hide");

    setTimeout(() => {
      modal.classList.add("hidden");
      modal.classList.remove("modal-show", "modal-hide");
      modalContent.classList.remove("modal-content-show", "modal-content-hide");
    }, 300);
  }

  function confirmStatusUpdate() {
    const session = getSessionFromStorage();
    if (!session || !session.sessionToken) {
      showToast("กรุณาเข้าสู่ระบบใหม่", "error");
      return;
    }

    const bookingId = document.getElementById("statusBookingId").value;
    const newStatus = document.getElementById("newStatusSelect").value;
    const reason = document.getElementById("statusReasonText").value;

    if (!newStatus) {
      showToast("กรุณาเลือกสถานะใหม่", "error");
      return;
    }

    if (newStatus === "Cancel" && !reason) {
      showToast("กรุณาระบุเหตุผลในการยกเลิก", "error");
      return;
    }

    // Show loading
    const btn = document.getElementById("confirmStatusBtn");
    const cancelBtn = document.getElementById("cancelStatusBtn");
    const spinner = document.getElementById("statusBtnSpinner");
    const text = document.getElementById("statusBtnText");

    btn.disabled = true;
    cancelBtn.disabled = true;
    spinner.classList.remove("hidden");
    text.textContent = "กำลังบันทึก...";

    google.script.run
      .withSuccessHandler(onStatusUpdated)
      .withFailureHandler(onPaymentError)
      .updateBookingStatus(session.sessionToken, bookingId, newStatus, reason);
  }

  function onStatusUpdated(response) {
    // Reset button
    const btn = document.getElementById("confirmStatusBtn");
    const cancelBtn = document.getElementById("cancelStatusBtn");
    const spinner = document.getElementById("statusBtnSpinner");
    const text = document.getElementById("statusBtnText");

    btn.disabled = false;
    cancelBtn.disabled = false;
    spinner.classList.add("hidden");
    text.textContent = "บันทึก";

    if (!response.success) {
      showToast(response.message, "error");
      return;
    }

    showToast("อัพเดทสถานะสำเร็จ!", "success");

    closeUpdateStatusModal();
    closeViewPaymentModal();

    // Reload payments
    setTimeout(() => {
      loadPayments();
    }, 1500);
  }

  // Utility Functions
  function showPaymentLoading() {
    const tbody = document.getElementById("paymentTableBody");
    const gridBody = document.getElementById("paymentGridBody");

    const loadingHtml = `
      <tr>
        <td colspan="8" class="px-6 py-12 text-center">
          <div class="flex flex-col items-center justify-center space-y-3">
            <div class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"></div>
            <p class="text-gray-400 text-sm font-medium animate-pulse">กำลังดึงข้อมูลการอนุมัติ...</p>
          </div>
        </td>
      </tr>
    `;

    const gridLoadingHtml = `
      <div class="col-span-full py-12 text-center">
        <div class="flex flex-col items-center justify-center space-y-3">
          <div class="w-10 h-10 border-4 border-purple-100 border-t-purple-600 rounded-full animate-spin"></div>
          <p class="text-gray-400 text-sm font-medium animate-pulse">กำลังดึงข้อมูลการอนุมัติ...</p>
        </div>
      </div>
    `;

    if (tbody) tbody.innerHTML = loadingHtml;
    if (gridBody) gridBody.innerHTML = gridLoadingHtml;
  }

  /**
   * Render Pagination & Data
   */
  function renderPaymentPagination() {
    const totalItems = currentFilteredPayments.length;
    const totalPages = Math.ceil(totalItems / paymentItemsPerPage);

    // Validate current page
    if (currentPaymentPage > totalPages) {
      currentPaymentPage = totalPages || 1;
    }
    if (currentPaymentPage < 1) {
      currentPaymentPage = 1;
    }

    const startIndex = (currentPaymentPage - 1) * paymentItemsPerPage;
    const endIndex = Math.min(startIndex + paymentItemsPerPage, totalItems);
    const pageData = currentFilteredPayments.slice(startIndex, endIndex);

    // Render Data
    displayPayments(pageData);

    // Update Pagination Info
    document.getElementById(
      "paymentPaginationInfo"
    ).textContent = `หน้า ${currentPaymentPage} จาก ${totalPages} (${totalItems} รายการ)`;
    document.getElementById(
      "paymentMobilePageInfo"
    ).textContent = `${currentPaymentPage} / ${totalPages}`;

    // Update Navigation Buttons
    document.getElementById("paymentPrevPageBtn").disabled =
      currentPaymentPage === 1;
    document.getElementById("paymentNextPageBtn").disabled =
      currentPaymentPage === totalPages;

    // Render Page Numbers (Desktop)
    const pageNumbersContainer = document.getElementById("paymentPageNumbers");
    pageNumbersContainer.innerHTML = "";

    const maxVisiblePages = 5;
    let startPage = Math.max(
      1,
      currentPaymentPage - Math.floor(maxVisiblePages / 2)
    );
    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
      startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    // First page + dots
    if (startPage > 1) {
      const firstBtn = createPaymentPageButton(1);
      pageNumbersContainer.appendChild(firstBtn);

      if (startPage > 2) {
        const dots = document.createElement("span");
        dots.className = "text-gray-400 px-1 select-none";
        dots.textContent = "...";
        pageNumbersContainer.appendChild(dots);
      }
    }

    // Page numbers
    for (let i = startPage; i <= endPage; i++) {
      const btn = createPaymentPageButton(i);
      pageNumbersContainer.appendChild(btn);
    }

    // Last page + dots
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        const dots = document.createElement("span");
        dots.className = "text-gray-400 px-1 select-none";
        dots.textContent = "...";
        pageNumbersContainer.appendChild(dots);
      }

      const lastBtn = createPaymentPageButton(totalPages);
      pageNumbersContainer.appendChild(lastBtn);
    }
  }

  function createPaymentPageButton(pageNum) {
    const btn = document.createElement("button");
    btn.textContent = pageNum;
    btn.onclick = () => changePaymentPage(pageNum);

    if (pageNum === currentPaymentPage) {
      btn.className =
        "px-3 py-1 bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-lg font-bold shadow-sm";
    } else {
      btn.className =
        "px-3 py-1 border border-gray-200 rounded-lg hover:bg-purple-50 hover:text-purple-600 hover:border-purple-200 transition-all";
    }

    return btn;
  }

  /**
   * Change Page Action
   */
  function changePaymentPage(direction) {
    const totalItems = currentFilteredPayments.length;
    const totalPages = Math.ceil(totalItems / paymentItemsPerPage);

    if (direction === "prev" && currentPaymentPage > 1) {
      currentPaymentPage--;
    } else if (direction === "next" && currentPaymentPage < totalPages) {
      currentPaymentPage++;
    } else if (typeof direction === "number") {
      currentPaymentPage = direction;
    }

    renderPaymentPagination();
  }

  /**
   * Change Page Size Action
   */
  function changePaymentPageSize() {
    const selector = document.getElementById("paymentItemsPerPageSelect");
    paymentItemsPerPage = parseInt(selector.value);
    currentPaymentPage = 1; // Reset to page 1
    renderPaymentPagination();
  }

  function hidePaymentLoading() {
    // Loading will be replaced by actual data
  }

  function onPaymentError(error) {
    console.error("Error:", error);
    showToast("เกิดข้อผิดพลาด: " + error.message, "error");
    hidePaymentLoading();
  }

  /**
   * Status History Functions
   */
  function loadPaymentHistory(bookingId) {
    const session = getSessionFromStorage();
    if (!session) return;

    google.script.run
      .withSuccessHandler(renderPaymentHistory)
      .getBookingStatusHistory(session.sessionToken, bookingId);
  }

  function renderPaymentHistory(response) {
    const container = document.getElementById("paymentHistoryList");
    if (!container) return;

    if (!response || !response.success) {
      container.innerHTML = `<div class="text-sm text-red-500 py-2">ไม่สามารถดึงข้อมูลประวัติได้</div>`;
      return;
    }

    const history = response.data;
    if (history.length === 0) {
      container.innerHTML = `<div class="text-sm text-gray-400 py-2">ไม่มีประวัติการเปลี่ยนสถานะ</div>`;
      return;
    }

    container.innerHTML = history
      .map(
        (item) => `
      <div class="relative pl-6 border-l-2 border-gray-100 pb-2 last:pb-0">
        <div class="absolute -left-[9px] top-1.5 w-4 h-4 rounded-full bg-white border-2 border-purple-500"></div>
        <div class="text-xs text-gray-400 mb-1">${item.changedAt}</div>
        <div class="text-sm">
          <span class="font-bold text-gray-900">${item.changedBy}</span>
          <span class="text-gray-600">เปลี่ยนสถานะ :</span>
          <div class="mt-1 flex items-center gap-2">
            ${getStatusBadge(item.oldStatus)}
            <svg class="w-3 h-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            ${getStatusBadge(item.newStatus)}
          </div>
          ${
            item.reason
              ? `<div class="mt-2 text-xs text-gray-500 bg-gray-50 p-2 rounded-lg italic border-l-2 border-gray-200">เหตุผล: ${item.reason}</div>`
              : ""
          }
        </div>
      </div>
    `
      )
      .join("");
  }

  /**
   * Calculate Total Paid Amount
   */
  function calculateTotalPaid() {
    const transferAmount =
      parseFloat(document.getElementById("transferAmount")?.value) || 0;
    const cashAmount =
      parseFloat(document.getElementById("cashAmount")?.value) || 0;
    const cashOnTour =
      parseFloat(document.getElementById("cashOnTour")?.value) || 0;

    const totalPaid = transferAmount + cashAmount + cashOnTour;

    // Update display
    const totalPaidEl = document.getElementById("totalPaidDisplay");
    if (totalPaidEl) {
      totalPaidEl.textContent = totalPaid.toLocaleString() + " ฿";
    }

    // Also update remaining if we want, but first ensure we have the element
    const totalAmount = currentPayment?.totalAmount || 0;
    const remaining = totalAmount - totalPaid;
    const remainingEl = document.getElementById("remainingAmount");
    if (remainingEl) {
      remainingEl.textContent = remaining.toLocaleString() + " ฿";
      if (remaining > 0) {
        remainingEl.className = "font-bold text-red-600";
      } else {
        remainingEl.className = "font-bold text-green-600";
      }
    }
  }

  /**
   * Save Payment Amounts
   */
  function savePaymentAmounts() {
    const session = getSessionFromStorage();
    if (!session || !session.sessionToken) {
      showToast("กรุณาเข้าสู่ระบบใหม่", "error");
      return;
    }

    if (!currentPayment) {
      showToast("ไม่พบข้อมูลการจอง", "error");
      return;
    }

    const transferAmount = parseFloat(
      document.getElementById("transferAmount")?.value || 0
    );
    const cashAmount = parseFloat(
      document.getElementById("cashAmount")?.value || 0
    );
    const cashOnTour = parseFloat(
      document.getElementById("cashOnTour")?.value || 0
    );

    // Validate amounts
    if (transferAmount < 0 || cashAmount < 0 || cashOnTour < 0) {
      showToast("จำนวนเงินต้องไม่ติดลบ", "error");
      return;
    }

    // Show loading state
    const btn = document.getElementById("savePaymentBtn");
    const spinner = document.getElementById("savePaymentSpinner");
    const icon = document.getElementById("savePaymentIcon");
    const text = document.getElementById("savePaymentText");

    if (btn && spinner && icon && text) {
      btn.disabled = true;
      spinner.classList.remove("hidden");
      icon.classList.add("hidden");
      text.textContent = "กำลังบันทึก...";
    }

    google.script.run
      .withSuccessHandler(onPaymentAmountsSaved)
      .withFailureHandler(onPaymentError)
      .updatePaymentAmounts(
        session.sessionToken,
        currentPayment.bookingId,
        transferAmount,
        cashAmount,
        cashOnTour
      );
  }

  /**
   * On Payment Amounts Saved
   */
  function onPaymentAmountsSaved(response) {
    // Reset loading state
    const btn = document.getElementById("savePaymentBtn");
    const spinner = document.getElementById("savePaymentSpinner");
    const icon = document.getElementById("savePaymentIcon");
    const text = document.getElementById("savePaymentText");

    if (btn && spinner && icon && text) {
      btn.disabled = false;
      spinner.classList.add("hidden");
      icon.classList.remove("hidden");
      text.textContent = "บันทึกข้อมูลการชำระเงิน";
    }

    if (!response.success) {
      showToast(response.message || "ไม่สามารถบันทึกข้อมูลได้", "error");
      return;
    }

    showToast("บันทึกข้อมูลการชำระเงินสำเร็จ!", "success");

    // Close Modal after success
    closeViewPaymentModal();

    // Update current payment data
    if (currentPayment) {
      currentPayment.transferAmount = parseFloat(
        document.getElementById("transferAmount")?.value || 0
      );
      currentPayment.cashAmount = parseFloat(
        document.getElementById("cashAmount")?.value || 0
      );
      currentPayment.cashOnTour = parseFloat(
        document.getElementById("cashOnTour")?.value || 0
      );
    }

    // Reload payments list
    loadPayments();
  }

  // Export function to window for main.html to call
  if (typeof window.loadPaymentApproval === "undefined") {
    window.loadPaymentApproval = loadPaymentApproval;
  }

  // ========================================
  // REFUND SYSTEM - FRONTEND FUNCTIONS
  // ========================================

  let currentPaymentForRefund = null;

  /**
   * Open Refund Modal (All-in-One)
   */
  function openRefundModal(payment) {
    currentPaymentForRefund = payment;

    // Populate booking info
    document.getElementById("refundBookingId").textContent = payment.bookingId;
    document.getElementById("refundTotalAmount").textContent =
      Number(payment.totalAmount).toLocaleString() + " ฿";

    // Clear all form fields
    document.getElementById("customerName").value = "";
    document.getElementById("customerBankName").value = "";
    document.getElementById("customerAccountNumber").value = "";
    document.getElementById("refundAmount").value = "";
    document.getElementById("refundNote").value = "";

    // Reset Slip UI
    clearRefundSlip();

    // Open modal with Standard Animation
    const modal = document.getElementById("createRefundModal");
    const modalContent = document.getElementById("createRefundModalContent");

    modal.classList.remove("hidden");
    modal.classList.add("modal-show");

    // Ensure modal starts at top
    const modalBody = document.getElementById("createRefundModalBody");
    if (modalBody) modalBody.scrollTop = 0;

    setTimeout(() => {
      modalContent.classList.add("modal-content-show");
    }, 10);
  }

  function closeCreateRefundModal() {
    const modal = document.getElementById("createRefundModal");
    const modalContent = document.getElementById("createRefundModalContent");

    modal.classList.add("modal-hide");
    modalContent.classList.add("modal-content-hide");

    setTimeout(() => {
      modal.classList.add("hidden");
      modal.classList.remove("modal-show", "modal-hide");
      modalContent.classList.remove("modal-content-show", "modal-content-hide");
    }, 300);
    currentPaymentForRefund = null;
  }

  /**
   * Handle Slip File Selection
   */
  var selectedRefundSlipFile = null;

  function handleRefundSlipSelect(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate size (5MB)
    if (file.size > 5 * 1024 * 1024) {
      showToast("ไฟล์มีขนาดใหญ่เกิน 5MB", "error");
      event.target.value = "";
      return;
    }

    // Store file
    selectedRefundSlipFile = file;

    // Show preview and hide upload area
    document.getElementById("refundSlipUploadArea").classList.add("hidden");
    document.getElementById("refundSlipPreview").classList.remove("hidden");
    document.getElementById("refundSlipFileName").textContent = file.name;
    document.getElementById("refundSlipFileSize").textContent = formatFileSize(
      file.size
    );

    // Hide view link for new files
    document.getElementById("refundSlipViewLink").classList.add("hidden");
  }

  function clearRefundSlip() {
    selectedRefundSlipFile = null;
    const fileInput = document.getElementById("refundSlipFile");
    if (fileInput) fileInput.value = "";

    const uploadArea = document.getElementById("refundSlipUploadArea");
    const preview = document.getElementById("refundSlipPreview");

    if (uploadArea) uploadArea.classList.remove("hidden");
    if (preview) preview.classList.add("hidden");
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return "0 Bytes";
    const k = 1024;
    const sizes = ["Bytes", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
  }

  /**
   * Save Refund (All-in-One Process)
   * 1. Validate form
   * 2. Create Customer first
   * 3. Then create Refund with customer ID
   */
  function saveRefund() {
    const session = getSessionFromStorage();
    if (!session || !session.sessionToken) {
      showToast("กรุณาเข้าสู่ระบบใหม่", "error");
      return;
    }

    // Get customer data
    const customerName = document.getElementById("customerName").value.trim();
    const bankName = document.getElementById("customerBankName").value;
    const accountNumber = document
      .getElementById("customerAccountNumber")
      .value.trim();

    // Get refund data
    const refundAmount = parseFloat(
      document.getElementById("refundAmount").value
    );
    const slipFileInput = document.getElementById("refundSlipFile");
    const note = document.getElementById("refundNote").value.trim();

    // Validate customer data
    if (!customerName || !bankName || !accountNumber) {
      showToast("กรุณากรอกข้อมูลลูกค้าให้ครบถ้วน", "error");
      return;
    }

    // Validate refund data
    if (!refundAmount || refundAmount <= 0) {
      showToast("กรุณากรอกยอดเงินคืน", "error");
      return;
    }

    if (!slipFileInput.files || slipFileInput.files.length === 0) {
      showToast("กรุณาอัปโหลดสลิปการโอนเงินคืน", "error");
      return;
    }

    // Show loading
    const btn = document.getElementById("saveRefundBtn");
    const spinner = document.getElementById("saveRefundSpinner");
    const btnText = document.getElementById("saveRefundText");

    btn.disabled = true;
    if (spinner) spinner.classList.remove("hidden");
    if (btnText) btnText.textContent = "กำลังบันทึก...";

    // Step 1: Create Customer first
    google.script.run
      .withSuccessHandler(function (customerResponse) {
        if (!customerResponse.success) {
          showToast(
            customerResponse.message || "ไม่สามารถบันทึกข้อมูลลูกค้าได้",
            "error"
          );
          btn.disabled = false;
          if (spinner) spinner.classList.add("hidden");
          if (btnText) btnText.textContent = "บันทึกการคืนเงิน";
          return;
        }

        // Read slip file
        const file = slipFileInput.files[0];
        const reader = new FileReader();

        reader.onload = function (e) {
          const base64Data = e.target.result.split(",")[1];

          // Step 2: Create Refund with customer ID
          google.script.run
            .withSuccessHandler(function (refundResponse) {
              btn.disabled = false;
              if (spinner) spinner.classList.add("hidden");
              if (btnText) btnText.textContent = "บันทึกการคืนเงิน";

              if (!refundResponse.success) {
                showToast(
                  refundResponse.message || "ไม่สามารถบันทึกการคืนเงินได้",
                  "error"
                );
                return;
              }

              showToast("บันทึกการคืนเงินสำเร็จ!", "success");

              // Close modal
              closeCreateRefundModal();
              closeViewPaymentModal();

              // Reload payments
              setTimeout(() => {
                loadPayments();
              }, 1500);
            })
            .withFailureHandler(function (error) {
              console.error("Error:", error);
              showToast("เกิดข้อผิดพลาด: " + error.message, "error");
              btn.disabled = false;
              if (spinner) spinner.classList.add("hidden");
              if (btnText) btnText.textContent = "บันทึกการคืนเงิน";
            })
            .createRefund(
              session.sessionToken,
              {
                bookingId: currentPaymentForRefund.bookingId,
                customerId: customerResponse.data.customerId,
                refundAmount: refundAmount,
                note: note,
              },
              {
                data: base64Data,
                mimeType: file.type,
                filename: file.name,
              }
            );
        };

        reader.readAsDataURL(file);
      })
      .withFailureHandler(function (error) {
        console.error("Error:", error);
        showToast("เกิดข้อผิดพลาด: " + error.message, "error");
        btn.disabled = false;
        if (spinner) spinner.classList.add("hidden");
        if (btnText) btnText.textContent = "บันทึกการคืนเงิน";
      })
      .createCustomer(session.sessionToken, {
        customerName: customerName,
        bankName: bankName,
        accountNumber: accountNumber,
      });
  }
</script>
