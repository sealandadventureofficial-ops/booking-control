<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Booking Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Import Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Noto+Sans:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- PDF.js for Sandboxed Environments -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    </script>

    <!-- Centralized Styles -->
    <?!= include('style'); ?>
    <?!= include('PDFGenerator'); ?>
  </head>
  <body class="bg-gray-50">
    <!-- Main App Container -->
    <div id="app"></div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-4 right-4 z-50"></div>

    <script>
      // ========================================
      // SESSION MANAGEMENT (Client-Side)
      // ========================================

      /**
       * Save Session to localStorage
       */
      function saveSession(sessionData) {
        localStorage.setItem("bookingSession", JSON.stringify(sessionData));
      }

      /**
       * Get Session from localStorage
       */
      function getSessionFromStorage() {
        const sessionString = localStorage.getItem("bookingSession");
        if (!sessionString) return null;

        try {
          const session = JSON.parse(sessionString);

          // ตรวจสอบว่า Session หมดอายุหรือไม่ (24 ชั่วโมง)
          const now = new Date().getTime();
          const sessionAge = now - session.loginTime;
          const maxAge = 24 * 60 * 60 * 1000; // 24 hours

          if (sessionAge > maxAge) {
            clearSessionStorage();
            return null;
          }

          return session;
        } catch (error) {
          return null;
        }
      }

      /**
       * Clear Session from localStorage
       */
      function clearSessionStorage() {
        localStorage.removeItem("bookingSession");
      }

      /**
       * Check if User is Logged In
       */
      function isLoggedIn() {
        return getSessionFromStorage() !== null;
      }

      // ========================================
      // GLOBAL VARIABLES & STATE
      // ========================================
      let currentUser = null;
      let currentPage = "login";

      // ========================================
      // SHARED UTILITY FUNCTIONS (ใช้ทุกหน้า)
      // ========================================

      /**
       * Toast Notification Function
       */
      function showToast(message, type = "success", duration = 3000) {
        const toast = document.createElement("div");
        const bgColor = type === "success" ? "bg-green-500" : "bg-red-500";
        const icon =
          type === "success"
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path>';

        toast.className = `${bgColor} text-white px-6 py-4 rounded-lg shadow-2xl mb-4 transform transition-all duration-500 translate-x-full hover:scale-105 cursor-pointer`;
        toast.innerHTML = `
        <div class="flex items-center space-x-3">
          <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            ${icon}
          </svg>
          <span class="font-medium">${message}</span>
        </div>
      `;

        // คลิกเพื่อปิด Toast
        toast.addEventListener("click", function () {
          toast.classList.add("translate-x-full");
          setTimeout(() => toast.remove(), 300);
        });

        document.getElementById("toastContainer").appendChild(toast);

        // แสดง Toast
        setTimeout(() => {
          toast.classList.remove("translate-x-full");
        }, 100);

        // ซ่อน Toast อัตโนมัติ
        setTimeout(() => {
          toast.classList.add("translate-x-full");
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }

      /**
       * Update DateTime (ใช้ใน main.html)
       */
      function updateDateTime() {
        const now = new Date();
        const options = {
          year: "numeric",
          month: "long",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        };
        const dateTimeElement = document.getElementById("currentDateTime");
        if (dateTimeElement) {
          dateTimeElement.textContent = now.toLocaleDateString(
            "th-TH",
            options
          );
        }
      }

      // ========================================
      // PAGE LOADING & NAVIGATION
      // ========================================

      /**
       * Load Page Content
       */
      function loadPage(pageName) {
        currentPage = pageName;
        const app = document.getElementById("app");

        google.script.run
          .withSuccessHandler(function (html) {
            // แยก HTML และ Script
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = html;

            // ดึง scripts ออกมา
            const scripts = tempDiv.querySelectorAll("script");

            // ใส่ HTML (ไม่รวม script)
            app.innerHTML = html;

            // Execute scripts manually
            scripts.forEach((oldScript) => {
              const newScript = document.createElement("script");

              // Copy attributes
              Array.from(oldScript.attributes).forEach((attr) => {
                newScript.setAttribute(attr.name, attr.value);
              });

              // Copy content
              newScript.textContent = oldScript.textContent;

              // Append to body to execute
              document.body.appendChild(newScript);

              // Remove after execution
              setTimeout(() => {
                document.body.removeChild(newScript);
              }, 10);
            });
          })
          .withFailureHandler(function (error) {
            app.innerHTML = `<div class="p-8 text-center text-red-600">เกิดข้อผิดพลาด: ${error.message}</div>`;
          })
          .include(pageName);
      }

      /**
       * Navigate to Page (for internal navigation within main app)
       */
      function navigateTo(pageName) {
        // Hide all page containers
        document.querySelectorAll(".page-container").forEach((page) => {
          page.classList.remove("active");
        });

        // Show selected page
        const targetPage = document.getElementById(`page-${pageName}`);
        if (targetPage) {
          targetPage.classList.add("active");

          // Update active menu
          document.querySelectorAll(".sidebar-item").forEach((item) => {
            item.classList.remove("active");
          });
          const activeMenu = document.querySelector(
            `[data-page="${pageName}"]`
          );
          if (activeMenu) {
            activeMenu.classList.add("active");
          }

          // Update page title
          const titles = {
            dashboard: { title: "Dashboard", subtitle: "ภาพรวมระบบ" },
            booking: {
              title: "จัดการการจอง",
              subtitle: "สร้างและจัดการการจองทัวร์",
            },
            employees: {
              title: "จัดการพนักงาน",
              subtitle: "จัดการข้อมูลพนักงานและสิทธิ์การใช้งาน",
            },
          };

          if (titles[pageName]) {
            document.getElementById("pageTitle").textContent =
              titles[pageName].title;
            document.getElementById("pageSubtitle").textContent =
              titles[pageName].subtitle;
          }

          // Call page-specific load functions
          if (pageName === "dashboard" && typeof loadDashboard === "function") {
            loadDashboard();
          } else if (
            pageName === "booking" &&
            typeof loadBookings === "function"
          ) {
            loadBookings();
          } else if (
            pageName === "employees" &&
            typeof loadEmployees === "function"
          ) {
            loadEmployees();
          }
        }
      }

      /**
       * Logout (ใช้ใน main.html)
       */
      function logout() {
        google.script.run
          .withSuccessHandler(function (response) {
            clearSessionStorage();
            currentUser = null;
            showToast(response.message, "success");
            setTimeout(() => {
              loadPage("login");
            }, 1000);
          })
          .logoutUser();
      }

      // ========================================
      // INITIALIZATION
      // ========================================

      window.onload = function () {
        // Get initial page from server (if passed via doGet)
        const initialPage = "<?= initialPage ?>";

        // Check if user is logged in from localStorage
        const session = getSessionFromStorage();

        if (session && session.sessionToken) {
          // Validate session with server
          google.script.run
            .withSuccessHandler(function (response) {
              if (response.success) {
                currentUser = response.data;

                // Load main page
                loadPage("main");

                // Set hash if initialPage is provided
                if (
                  initialPage &&
                  initialPage !== "null" &&
                  initialPage !== ""
                ) {
                  setTimeout(() => {
                    window.location.hash = initialPage;
                  }, 100);
                }
              } else {
                clearSessionStorage();
                loadPage("login");
              }
            })
            .withFailureHandler(function () {
              clearSessionStorage();
              loadPage("login");
            })
            .getCurrentUser(session.sessionToken);
        } else {
          loadPage("login");
        }
      };
    </script>
  </body>
</html>
