<!-- Reports Page -->
<div class="space-y-6">
  <!-- Page Header & Filter -->
  <div class="bg-white rounded-2xl shadow-lg p-4 sm:p-6">
    <!-- Dynamic Header & Filters Row -->
    <div
      class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4"
    >
      <!-- Left side: Title -->
      <div>
        <h3 class="text-lg font-bold text-gray-800">รายงานและสถิติ</h3>
        <p class="text-sm text-gray-500 mt-1">วิเคราะห์ยอดขายและสรุปข้อมูล</p>
      </div>

      <!-- Right side: All Filter Controls -->
      <div class="flex flex-col lg:flex-row lg:items-center gap-4">
        <!-- Part 1: Quick Filter Buttons -->
        <div
          class="grid grid-cols-2 sm:grid-cols-4 lg:flex lg:flex-row gap-2 order-2 lg:order-1"
        >
          <button
            onclick="setReportFilter('all')"
            class="px-3 py-2 bg-gray-50 text-gray-600 rounded-lg hover:bg-gray-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            ทั้งหมด
          </button>
          <button
            onclick="setReportFilter('today')"
            class="px-3 py-2 bg-purple-50 text-purple-600 rounded-lg hover:bg-purple-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            วันนี้
          </button>
          <button
            onclick="setReportFilter('month')"
            class="px-3 py-2 bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            เดือนนี้
          </button>
          <button
            onclick="setReportFilter('year')"
            class="px-3 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all font-medium text-sm whitespace-nowrap"
          >
            ปีนี้
          </button>
        </div>

        <!-- Part 2: Separator / Label -->
        <div class="hidden lg:block w-px h-8 bg-gray-200 order-2"></div>
        <div class="lg:hidden order-3 border-t border-gray-100 pt-4 mt-2">
          <label
            class="text-xs text-gray-500 uppercase tracking-wide mb-2 block"
            >กำหนดช่วงเวลาเอง</label
          >
        </div>

        <!-- Part 3: Date Inputs -->
        <div
          class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 order-3 lg:order-3"
        >
          <input
            type="date"
            id="reportStartDate"
            class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 text-sm input-modern lg:w-40"
            placeholder="จาก"
          />
          <span class="hidden sm:inline text-gray-400">-</span>
          <input
            type="date"
            id="reportEndDate"
            class="px-3 py-2 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-purple-500 text-sm input-modern lg:w-40"
            placeholder="ถึง"
          />
          <button
            onclick="applyCustomReportFilter()"
            class="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg hover:shadow-lg transition-all font-medium text-sm whitespace-nowrap"
          >
            ค้นหา
          </button>
        </div>
      </div>
    </div>

    <!-- Current Filter Display -->
    <div class="mt-4 pt-4 border-t border-gray-100">
      <p class="text-sm text-gray-600">
        <span class="font-semibold">ช่วงเวลาที่เลือก:</span>
        <span id="reportFilterText" class="text-purple-600 ml-2">เดือนนี้</span>
      </p>
    </div>
  </div>

  <!-- Reports Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- 1. Daily Sales by Location -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h3 class="text-lg font-bold text-gray-800">
            ยอดขายรายวันตามสถานที่
          </h3>
          <p class="text-xs text-gray-500 mt-1">เฉพาะสถานะ Completed</p>
          <div class="mt-2 flex flex-wrap items-center gap-2">
            <select
              id="sortDailySales"
              onchange="sortAndRenderDailySales()"
              class="input-modern select-modern w-full sm:w-auto text-sm"
            >
              <option value="sales">เรียงตามยอดขาย</option>
              <option value="count">เรียงตามยอดการจอง</option>
            </select>
            <button
              onclick="exportDailySalesToExcel()"
              class="px-3 py-2 bg-green-50 text-green-600 rounded-lg hover:bg-green-100 transition-all font-medium text-sm flex items-center gap-2"
            >
              <svg
                class="w-4 h-4"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                ></path>
              </svg>
              Export Excel
            </button>
          </div>
        </div>
        <div
          class="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-600 rounded-xl flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
            ></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
            ></path>
          </svg>
        </div>
      </div>

      <!-- Loading State -->
      <div id="dailySalesLoading" class="space-y-4">
        <!-- Summary Skeleton -->
        <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
          <div class="h-4 bg-gray-200 rounded w-32 mb-2"></div>
          <div class="h-8 bg-gray-300 rounded w-40"></div>
        </div>

        <!-- Item Skeletons -->
        <div class="space-y-3">
          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-32 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-24"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>

          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-28 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-20"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>

          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-36 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-28"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>
        </div>
      </div>

      <!-- Data Container -->
      <div id="dailySalesContainer" class="hidden space-y-4"></div>
    </div>

    <!-- 2. Program Summary -->
    <div class="bg-white rounded-2xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h3 class="text-lg font-bold text-gray-800">สรุปยอดแต่ละโปรแกรม</h3>
          <p class="text-xs text-gray-500 mt-1">เฉพาะสถานะ Completed</p>
          <div class="mt-2">
            <select
              id="sortProgramSummary"
              onchange="sortAndRenderProgramSummary()"
              class="input-modern select-modern w-full sm:w-auto"
            >
              <option value="sales">เรียงตามยอดขาย</option>
              <option value="count">เรียงตามยอดการจอง</option>
            </select>
          </div>
        </div>
        <div
          class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center"
        >
          <svg
            class="w-6 h-6 text-white"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
            ></path>
          </svg>
        </div>
      </div>

      <!-- Loading State -->
      <div id="programSummaryLoading" class="space-y-4">
        <!-- Summary Skeleton -->
        <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
          <div class="h-4 bg-gray-200 rounded w-24 mb-2"></div>
          <div class="h-8 bg-gray-300 rounded w-40"></div>
        </div>

        <!-- Item Skeletons -->
        <div class="space-y-3">
          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-40 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-48"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>

          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-36 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-44"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>

          <div class="bg-gray-50 rounded-xl p-4 animate-pulse">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="h-5 bg-gray-300 rounded w-44 mb-2"></div>
                <div class="h-3 bg-gray-200 rounded w-52"></div>
              </div>
              <div class="text-right">
                <div class="h-5 bg-gray-300 rounded w-24 mb-1"></div>
                <div class="h-3 bg-gray-200 rounded w-12"></div>
              </div>
            </div>
            <div class="h-2 bg-gray-200 rounded-full w-full"></div>
          </div>
        </div>
      </div>

      <!-- Data Container -->
      <div id="programSummaryContainer" class="hidden space-y-4"></div>
    </div>
  </div>
</div>

<script>
  // Global state
  let currentReportFilter = {
    type: "month",
    startDate: null,
    endDate: null,
  };

  window.dailySalesData = [];
  window.programSummaryData = [];

  /**
   * Format Date for Input (YYYY-MM-DD)
   */
  function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const day = String(date.getDate()).padStart(2, "0");
    return `${year}-${month}-${day}`;
  }

  /**
   * Format Date to Thai (DD/MM/YYYY)
   */
  function formatDateThai(date) {
    const day = String(date.getDate()).padStart(2, "0");
    const month = String(date.getMonth() + 1).padStart(2, "0");
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
  }

  /**
   * Set Report Filter (Quick Filters)
   */
  function setReportFilter(type) {
    const today = new Date();
    let startDate, endDate;

    switch (type) {
      case "all":
        startDate = "";
        endDate = "";
        document.getElementById("reportFilterText").textContent = "ทั้งหมด";
        break;

      case "today":
        startDate = endDate = formatDateForInput(today);
        document.getElementById("reportFilterText").textContent = "วันนี้";
        break;

      case "month":
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
        startDate = formatDateForInput(firstDay);
        endDate = formatDateForInput(lastDay);
        document.getElementById("reportFilterText").textContent = "เดือนนี้";
        break;

      case "year":
        const yearStart = new Date(today.getFullYear(), 0, 1);
        const yearEnd = new Date(today.getFullYear(), 11, 31);
        startDate = formatDateForInput(yearStart);
        endDate = formatDateForInput(yearEnd);
        document.getElementById("reportFilterText").textContent = "ปีนี้";
        break;
    }

    // Update input fields
    document.getElementById("reportStartDate").value = startDate;
    document.getElementById("reportEndDate").value = endDate;

    // Update filter state
    currentReportFilter = { type, startDate, endDate };

    // Reload reports
    loadReports(startDate, endDate);
  }

  /**
   * Apply Custom Date Filter
   */
  function applyCustomReportFilter() {
    const startDate = document.getElementById("reportStartDate").value;
    const endDate = document.getElementById("reportEndDate").value;

    if (!startDate || !endDate) {
      showToast("กรุณาเลือกวันที่เริ่มต้นและสิ้นสุด", "warning");
      return;
    }

    if (new Date(startDate) > new Date(endDate)) {
      showToast("วันที่เริ่มต้นต้องน้อยกว่าหรือเท่ากับวันที่สิ้นสุด", "error");
      return;
    }

    // Update filter display
    const start = new Date(startDate);
    const end = new Date(endDate);
    document.getElementById("reportFilterText").textContent = `${formatDateThai(
      start
    )} - ${formatDateThai(end)}`;

    // Update filter state
    currentReportFilter = { type: "custom", startDate, endDate };

    // Reload reports
    loadReports(startDate, endDate);
  }

  /**
   * Load Reports Data
   */
  function loadReports(startDate, endDate) {
    const session = getSessionFromStorage();

    if (!session || !session.sessionToken) {
      showToast("กรุณาเข้าสู่ระบบใหม่", "error");
      return;
    }

    // Initialize date inputs if not already set
    const startDateEl = document.getElementById("reportStartDate");
    const endDateEl = document.getElementById("reportEndDate");

    if (startDateEl && endDateEl && !startDateEl.value && !endDateEl.value) {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      startDateEl.value = formatDateForInput(firstDay);
      endDateEl.value = formatDateForInput(lastDay);
    }

    // Default to this month if parameters are undefined (e.g. initial load)
    if (startDate === undefined || endDate === undefined) {
      const today = new Date();
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      startDate = formatDateForInput(firstDay);
      endDate = formatDateForInput(lastDay);
      if (startDateEl) startDateEl.value = startDate;
      if (endDateEl) endDateEl.value = endDate;
    }

    // Show loading
    showReportLoading();

    // Load both reports in parallel and wait for both to complete
    Promise.all([
      new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getDailySalesReport(session.sessionToken, startDate, endDate);
      }),
      new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getProgramSummaryReport(session.sessionToken, startDate, endDate);
      }),
    ])
      .then(([dailySalesResponse, programSummaryResponse]) => {
        // Both reports loaded successfully, now render them together
        if (dailySalesResponse.success) {
          window.dailySalesData = dailySalesResponse.data.dailySales || [];
          sortAndRenderDailySales();
        } else {
          showToast(
            dailySalesResponse.message || "ไม่สามารถโหลดข้อมูลยอดขายได้",
            "error"
          );
        }

        if (programSummaryResponse.success) {
          window.programSummaryData =
            programSummaryResponse.data.programSummary || [];
          sortAndRenderProgramSummary();
        } else {
          showToast(
            programSummaryResponse.message || "ไม่สามารถโหลดข้อมูลโปรแกรมได้",
            "error"
          );
        }
      })
      .catch((error) => {
        showToast("เกิดข้อผิดพลาด: " + error.message, "error");
        hideReportLoading();
      });
  }

  /**
   * Show Loading State
   */
  function showReportLoading() {
    document.getElementById("dailySalesLoading").classList.remove("hidden");
    document.getElementById("dailySalesContainer").classList.add("hidden");

    document.getElementById("programSummaryLoading").classList.remove("hidden");
    document.getElementById("programSummaryContainer").classList.add("hidden");
  }

  /**
   * Sort and Render Daily Sales
   */
  window.sortAndRenderDailySales = function () {
    const sortBy = document.getElementById("sortDailySales").value;
    const rawData = window.dailySalesData || [];

    // Clone and Sort
    const data = [...rawData].sort((a, b) => {
      if (sortBy === "sales") {
        const valA = Number(a.totalSales) || 0;
        const valB = Number(b.totalSales) || 0;
        if (valB !== valA) return valB - valA;
      } else {
        const valA = Number(a.bookingCount) || 0;
        const valB = Number(b.bookingCount) || 0;
        if (valB !== valA) return valB - valA;
      }
      // ลำดับรอง: เรียงตามชื่อสถานที่
      return (a.location || "").localeCompare(b.location || "");
    });

    console.log("Sort Daily Sales by:", sortBy, "Result:", data);
    renderDailySales(data);
  };

  /**
   * Sort and Render Program Summary
   */
  window.sortAndRenderProgramSummary = function () {
    const sortBy = document.getElementById("sortProgramSummary").value;
    const rawData = window.programSummaryData || [];

    // Clone and Sort
    const data = [...rawData].sort((a, b) => {
      if (sortBy === "sales") {
        const valA = Number(a.totalRevenue) || 0;
        const valB = Number(b.totalRevenue) || 0;
        if (valB !== valA) return valB - valA;
      } else {
        const valA = Number(a.bookingCount) || 0;
        const valB = Number(b.bookingCount) || 0;
        if (valB !== valA) return valB - valA;
      }
      // ลำดับรอง: เรียงตามชื่อโปรแกรม
      return (a.program || "").localeCompare(b.program || "");
    });

    console.log("Sort Program Summary by:", sortBy, "Result:", data);
    renderProgramSummary(data);
  };

  /**
   * Export Daily Sales to Excel (CSV)
   */
  window.exportDailySalesToExcel = function () {
    const data = window.dailySalesData || [];
    if (data.length === 0) {
      showToast("ไม่มีข้อมูลสำหรับส่งออก", "warning");
      return;
    }

    // 1. Prepare CSV Header (BOM for Thai support in Excel)
    let csvContent = "\uFEFF";
    csvContent += "สถานที่,ผู้ใหญ่,เด็ก,รวมทั้งหมด,รายการจอง,ยอดขาย\n";

    // 2. Prepare Data Rows
    data.forEach((item) => {
      const location = (item.location || "ไม่ระบุ").replace(/,/g, " ");
      const adults = item.totalAdults || 0;
      const children = item.totalChildren || 0;
      const total = adults + children;
      const count = item.bookingCount || 0;
      const sales = item.totalSales || 0;

      csvContent += `${location},${adults},${children},${total},${count},${sales}\n`;
    });

    // 3. Create Download Link
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");

    // Get filter text for filename
    const filterText =
      document.getElementById("reportFilterText").textContent || "report";
    const filename = `รายงานยอดขายตามสถานที่_${filterText.replace(
      /[\/\\\s-]/g,
      "_"
    )}.csv`;

    link.setAttribute("href", url);
    link.setAttribute("download", filename);
    link.style.visibility = "hidden";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    showToast("ส่งออกข้อมูลเรียบร้อยแล้ว", "success");
  };

  /**
   * Render Daily Sales by Location
   */
  function renderDailySales(data) {
    const container = document.getElementById("dailySalesContainer");
    const loading = document.getElementById("dailySalesLoading");

    loading.classList.add("hidden");
    container.classList.remove("hidden");

    if (!data || data.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-400">
          <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          <p class="text-sm">ไม่มีข้อมูลในช่วงเวลาที่เลือก</p>
        </div>
      `;
      return;
    }

    // Calculate total
    const total = data.reduce((sum, item) => sum + item.totalSales, 0);

    container.innerHTML = `
      <!-- Total Summary -->
      <div class="bg-gradient-to-br from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-xl p-4 mb-4">
        <div class="text-sm text-gray-600 mb-1">ยอดขายรวมทั้งหมด</div>
        <div class="text-3xl font-bold text-blue-600">฿${total.toLocaleString()}</div>
      </div>

      <!-- Location List -->
      ${data
        .map((item, index) => {
          const percentage = total > 0 ? (item.totalSales / total) * 100 : 0;
          const colors = [
            "from-blue-500 to-cyan-600",
            "from-purple-500 to-pink-600",
            "from-green-500 to-emerald-600",
            "from-orange-500 to-red-600",
            "from-indigo-500 to-purple-600",
          ];
          const color = colors[index % colors.length];

          return `
          <div class="bg-gray-50 rounded-xl p-4 hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="font-bold text-gray-800 mb-1">${
                  item.location || "ไม่ระบุ"
                }</div>
                <div class="flex flex-wrap items-center gap-y-1 gap-x-4 text-xs text-gray-500">
                  <span class="flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                    </svg>
                    ผู้ใหญ่ ${item.totalAdults} คน
                  </span>
                  <span class="flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                    </svg>
                    เด็ก ${item.totalChildren} คน
                  </span>
                  <span class="flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                    </svg>
                    ทั้งหมด ${item.totalAdults + item.totalChildren} คน
                  </span>
                  <span class="flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zM12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z"></path>
                    </svg>
                    ${item.bookingCount} รายการ
                  </span>
                </div>
              </div>
              <div class="text-right ml-4">
                <div class="text-lg font-bold text-gray-900">฿${item.totalSales.toLocaleString()}</div>
                <div class="text-xs text-gray-500">${percentage.toFixed(
                  1
                )}%</div>
              </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-gradient-to-r ${color} h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
        })
        .join("")}
    `;
  }

  /**
   * Render Program Summary
   */
  function renderProgramSummary(data) {
    const container = document.getElementById("programSummaryContainer");
    const loading = document.getElementById("programSummaryLoading");

    loading.classList.add("hidden");
    container.classList.remove("hidden");

    if (!data || data.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-400">
          <svg class="w-12 h-12 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
          </svg>
          <p class="text-sm">ไม่มีข้อมูลในช่วงเวลาที่เลือก</p>
        </div>
      `;
      return;
    }

    // Calculate totals
    const totalBookings = data.reduce(
      (sum, item) => sum + item.bookingCount,
      0
    );
    const totalRevenue = data.reduce((sum, item) => sum + item.totalRevenue, 0);

    container.innerHTML = `
      <!-- Total Summary -->
      <div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-4 mb-4">
        <div class="text-sm text-gray-600 mb-1">รายได้รวม</div>
        <div class="text-3xl font-bold text-purple-600">฿${totalRevenue.toLocaleString()}</div>
      </div>

      <!-- Program List -->
      ${data
        .map((item, index) => {
          const percentage =
            totalRevenue > 0 ? (item.totalRevenue / totalRevenue) * 100 : 0;

          return `
          <div class="bg-gray-50 rounded-xl p-4 hover:shadow-md transition-all">
            <div class="flex items-center justify-between mb-3">
              <div class="flex-1">
                <div class="font-bold text-gray-800 mb-1">${
                  item.program || "ไม่ระบุ"
                }</div>
                <div class="flex items-center gap-4 text-xs text-gray-500">
                  <span class="flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                    </svg>
                    ผู้ใหญ่ ${item.totalAdults} คน
                  </span>
                  <span class="flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                    </svg>
                    เด็ก ${item.totalChildren} คน
                  </span>
                  <span class="flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
                    </svg>
                    รวมทั้งหมด ${item.totalAdults + item.totalChildren} คน
                  </span>
                  <span class="flex items-center">
                    <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M8 5a1 1 0 100 2h5.586l-1.293 1.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L13.586 5H8zM12 15a1 1 0 100-2H6.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L6.414 15H12z"></path>
                    </svg>
                    ${item.bookingCount} รายการ
                  </span>
                </div>
              </div>
              <div class="text-right ml-4">
                <div class="text-lg font-bold text-gray-900">฿${item.totalRevenue.toLocaleString()}</div>
                <div class="text-xs text-gray-500">${percentage.toFixed(
                  1
                )}%</div>
              </div>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-gradient-to-r from-purple-500 to-pink-600 h-2 rounded-full transition-all duration-500" style="width: ${percentage}%"></div>
            </div>
          </div>
        `;
        })
        .join("")}
    `;
  }

  // Export to window for global access (especially for event handlers)
  window.loadReports = loadReports;
  window.setReportFilter = setReportFilter;
  window.applyCustomReportFilter = applyCustomReportFilter;
  window.sortAndRenderDailySales = sortAndRenderDailySales;
  window.sortAndRenderProgramSummary = sortAndRenderProgramSummary;
  window.renderDailySales = renderDailySales;
  window.renderProgramSummary = renderProgramSummary;
</script>
